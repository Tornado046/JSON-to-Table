<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>JSON ‚Üí Tabla Mejorada</title>

<!-- M√≥dulo 1.1 - Tipograf√≠a y estilos base -->
<link href="https://fonts.googleapis.com/css?family=Inter:400,700&display=swap" rel="stylesheet">

<style>
/* M√≥dulo 1.2 - Variables CSS y sistema de temas */
:root{
  --bg:#ffffff; 
  --fg:#111111; 
  --header-bg:#f2f2f2; 
  --muted:#888;
  --cell-even:#f9f9f9; 
  --cell-odd:#eef3ff; 
  --accent:#2979ff;
  --input-border:#bbb; 
  --input-bg:#ffffff;
  --button-bg:#f2f6ff;
  --button-border:#bbb;
  --error:#e53935;
  --th-height:40px;
  --row-height:32px;
  --font-main: 'Inter', system-ui, Arial, sans-serif;
}

/* M√≥dulo 1.2.1 - Variables para modo oscuro */
body.dark{
  --bg:#141414; 
  --fg:#eee; 
  --header-bg:#222; 
  --muted:#aaa;
  --cell-even:#252525; 
  --cell-odd:#202020; 
  --accent:#2979ff;
  --input-border:#555;
  --input-bg:#2a2a2a;
  --button-bg:#333;
  --button-border:#555;
}

/* M√≥dulo 1.3 - Reset y estilos base */
*{box-sizing:border-box}
body{
  margin:0; 
  font-family:var(--font-main); 
  color:var(--fg);
  background:var(--bg); 
  -webkit-font-smoothing:antialiased;
}

/* M√≥dulo 1.4 - Layout y contenedores */
.container{padding:12px;}
.row{display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap}

/* M√≥dulo 1.5 - Estilos de inputs y controles */
input[type=text], textarea, select, button{
  font-family:var(--font-main);
  font-size:14px;
}

/* M√≥dulo 1.5.1 - Textarea JSON principal */
textarea#jsonin{
  width:100%; 
  min-height:160px; 
  padding:10px; 
  border:2px solid var(--input-border);
  border-radius:6px; 
  resize:vertical; 
  background:var(--input-bg); 
  color:var(--fg);
}
textarea#jsonin.error{ 
  border-color:var(--error); 
  box-shadow:0 0 6px rgba(229,57,53,0.18); 
}

/* M√≥dulo 1.5.2 - Inputs de texto */
input[type=text]{
  padding:6px;
  border-radius:6px;
  border:1px solid var(--input-border);
  background:var(--input-bg);
  color:var(--fg);
}

/* M√≥dulo 1.5.3 - Selectores */
select{
  padding:6px;
  border-radius:6px;
  border:1px solid var(--input-border);
  background:var(--input-bg);
  color:var(--fg);
}

/* M√≥dulo 1.5.4 - Botones */
button{
  padding:6px 10px;
  border-radius:6px;
  border:1px solid var(--button-border);
  background:var(--button-bg);
  color:var(--fg);
  cursor:pointer;
}
button:hover{
  opacity:0.9;
}
button:disabled{
  background:#f0f0f0;
  color:var(--muted);
  cursor:not-allowed;
}
body.dark button:disabled{
  background:#1a1a1a;
}

/* M√≥dulo 1.6 - Drawer de configuraci√≥n */
#drawer{
  position:fixed; 
  right:-100%; 
  top:0; 
  width:360px; 
  height:100vh; 
  background:var(--header-bg);
  box-shadow:0 6px 24px rgba(0,0,0,0.12); 
  transition:right .28s; 
  z-index:9999; 
  padding:12px; 
  overflow:auto;
}
#drawer.open{ right:0; }

/* M√≥dulo 1.6.1 - Pesta√±as del drawer */
.tab-bar{display:flex;gap:6px;margin-bottom:12px}
.tab-btn{
  flex:1;
  padding:10px;
  border-radius:8px;
  border:0;
  background:var(--input-bg);
  color:var(--fg);
  cursor:pointer;
}
.tab-btn.active{
  background:var(--accent);
  color:#fff;
}

/* M√≥dulo 1.7 - Contenedor de tabla con scroll */
#tableWrap{ 
  width:100%; 
  margin-top:10px; 
  border-radius:8px; 
  border:1px solid var(--input-border); 
  background:transparent; 
  min-height:200px; 
  max-height:420px; 
  overflow:auto;
}

/* M√≥dulo 1.8 - Estilos de tabla */
table{border-collapse:collapse;width:100%}
th, td{
  padding:6px 8px;
  border:1px solid var(--input-border); 
  white-space:nowrap; 
  font-family:monospace; 
  font-size:13px; 
  height:var(--row-height);
}

/* M√≥dulo 1.8.1 - Headers sticky */
thead th{
  height:var(--th-height); 
  background:var(--header-bg); 
  position:sticky; 
  top:0; 
  z-index:4;
  color:var(--fg);
}
thead tr.filter-row th{ 
  top: calc(var(--th-height)); 
  background:var(--header-bg); 
  z-index:5;
} 

/* M√≥dulo 1.8.2 - Filas alternadas */
tbody tr:nth-child(even) td{background:var(--cell-even)}
tbody tr:nth-child(odd) td{background:var(--cell-odd)}

/* M√≥dulo 1.8.3 - Indicadores de ordenamiento */
th.order-asc::after{ content:" ‚Üë"; color:var(--accent); font-weight:bold }
th.order-desc::after{ content:" ‚Üì"; color:var(--accent); font-weight:bold }

/* M√≥dulo 1.9 - Filtros por columna */
.filter-col-wrap{ position:relative; }
.filter-col{ 
  width:100%; 
  box-sizing:border-box; 
  padding-right:28px; 
  border-radius:4px; 
  padding:4px 8px;
  background:var(--input-bg);
  color:var(--fg);
  border:1px solid var(--input-border);
}

/* M√≥dulo 1.10 - Botones de limpiar (X) */
.clear-btn{ 
  position:absolute; 
  right:6px; 
  top:50%; 
  transform:translateY(-50%); 
  border:0;
  background:transparent;
  color:var(--muted); 
  cursor:pointer;
  font-size:14px;
  padding:2px; 
}
.clear-btn:focus{outline:2px solid rgba(41,121,255,0.12)}

/* M√≥dulo 1.11 - Celdas editables */
.editable-cell{ 
  background:#fffbe7 !important; 
  border:1px dashed var(--accent) !important; 
  box-shadow:0 0 0 3px rgba(41,121,255,0.06); 
}
td.editable-cell:focus{ 
  outline:2px solid rgba(41,121,255,0.16); 
}
body.dark .editable-cell{
  background:#3a3a1a !important;
}

/* M√≥dulo 1.12 - √Årea de visualizaci√≥n raw */
#rawDisplay{
  display:none;
  width:100%;
  min-height:160px;
  padding:10px;
  border:2px solid var(--input-border);
  border-radius:6px;
  white-space:pre;
  overflow:auto;
  background:var(--input-bg);
  color:var(--fg);
}

/* M√≥dulo 1.13 - Controles que se ocultan sin datos */
.hide-without-data{
  display:none;
}
.show-with-data{
  display:flex;
}

/* M√≥dulo 1.14 - Responsive */
@media (max-width:720px){
  #drawer{width:100vw}
  thead tr.filter-row th{ top: calc(var(--th-height) + 2px) }
}
</style>
</head>
<body>
<div class="container">
  <!-- M√≥dulo 2.1 - Controles superiores -->
  <div class="row" id="topControls">
    <input type="text" id="urlIn" placeholder="Pega URL aqu√≠..." aria-label="Pegar URL" style="flex:1">
    <button id="fetchBtn" aria-label="Cargar URL">Cargar URL</button>
    <button id="configBtn" aria-label="Abrir configuraci√≥n">‚öôÔ∏è Config</button>
  </div>

  <!-- M√≥dulo 2.2 - √Årea JSON -->
  <div class="row">
    <textarea id="jsonin" aria-label="√Årea JSON" placeholder="Pega o escribe JSON aqu√≠"></textarea>
  </div>

  <!-- M√≥dulo 2.3 - Acciones principales -->
  <div class="row">
    <button id="clearBtn" aria-label="Limpiar JSON">Limpiar JSON</button>

    <label style="display:flex;align-items:center;gap:6px">
      <span id="separatorLabel">Separador:</span>
      <select id="separatorSelect" aria-label="Separador">
        <option value="	">Tab</option>
        <option value=",">,</option>
        <option value=";">;</option>
      </select>
    </label>

    <select id="downloadSelect" aria-label="Descargar" disabled>
      <option value="" id="downloadOption">Descargar...</option>
      <option value="csv">CSV</option>
      <option value="xlsx">XLSX</option>
      <option value="txt">TXT</option>
    </select>

    <button id="toggleRawBtn" disabled aria-label="Mostrar raw">Mostrar Raw</button>
    <button id="copyBtn" disabled aria-label="Copiar tabla">Copiar tabla</button>
  </div>

  <!-- M√≥dulo 2.4 - Filtro global y edici√≥n (se ocultan sin datos) -->
  <div class="row hide-without-data" id="filterEditRow" style="align-items:center; margin-top:10px;">
    <div style="position:relative;flex:1;">
      <input type="text" id="filterGlobal" class="filter-global" placeholder="Filtro global..." autocomplete="off" style="width:100%;padding:8px 36px;border-radius:6px;border:1px solid var(--input-border);background:var(--input-bg);color:var(--fg)" />
      <button id="filterGlobalClearBtn" class="clear-btn" title="Limpiar filtro global">‚úï</button>
    </div>
    <button id="editBtn" aria-label="Editar tabla" disabled>‚úèÔ∏è <span id="editBtnText">Editar</span></button>
  </div>

  <!-- M√≥dulo 2.5 - Wrapper de tabla -->
  <div id="tableWrap" aria-live="polite">
    <div style="padding:12px;color:var(--muted)" id="noDataMessage">No hay tabla para mostrar</div>
  </div>

  <!-- M√≥dulo 2.6 - √Årea raw -->
  <div style="margin-top:8px">
    <textarea id="rawDisplay" readonly aria-label="Raw CSV"></textarea>
  </div>
</div>

<!-- M√≥dulo 3.1 - Drawer de configuraci√≥n -->
<div id="drawer" role="dialog" aria-label="Configuraci√≥n">
  <div class="tab-bar">
    <button class="tab-btn active" id="tabConfig">
      <span id="tabConfigText">Configuraci√≥n</span>
    </button>
    <button class="tab-btn" id="tabCustom">
      <span id="tabCustomText">Tema personalizado</span>
    </button>
  </div>

  <!-- M√≥dulo 3.2 - Panel de configuraci√≥n -->
  <div id="configContent" class="active">
    <!-- M√≥dulo 3.2.1 - Tema r√°pido -->
    <div style="display:flex;gap:8px;margin-bottom:10px;">
      <button id="themeLight" title="Modo claro">üåû</button>
      <button id="themeDark" title="Modo oscuro">üåô</button>
    </div>

    <!-- M√≥dulo 3.2.2 - Selector de idioma -->
    <label>
      <span id="languageLabel">Idioma:</span>
      <select id="languageSelect" style="width:100%;margin-top:6px">
        <option value="es">Espa√±ol</option>
        <option value="en">English</option>
      </select>
    </label>

    <!-- M√≥dulo 3.2.3 - Historial JSON -->
    <div style="margin-top:12px;">
      <label>
        <span id="historyLabel">Historial JSON:</span>
        <select id="jsonHistorySelect" style="width:100%;margin-top:6px">
          <option value="" id="selectJsonOption">-- Seleccionar JSON --</option>
        </select>
      </label>
      <div style="display:flex;gap:6px;margin-top:6px;">
        <button id="loadHistoryBtn" disabled>
          <span id="loadHistoryText">Cargar</span>
        </button>
        <button id="renameHistoryBtn">
          <span id="renameHistoryText">Renombrar</span>
        </button>
        <button id="deleteHistoryBtn" disabled>
          <span id="deleteHistoryText">Eliminar</span>
        </button>
      </div>
    </div>

    <!-- M√≥dulo 3.2.4 - Modo Web/M√≥vil -->
    <div style="margin-top:12px;">
      <button id="mobileSwitchBtn">
        <span id="mobileSwitchText">Web / M√≥vil</span>
      </button>
    </div>
  </div>

  <!-- M√≥dulo 3.3 - Panel de tema personalizado -->
  <div id="customPanel" style="display:none;">
    <h4 id="customThemeTitle">Personalizar tema</h4>
    <label>
      <span id="bgColorLabel">Fondo:</span> 
      <input type="color" id="bgColor">
    </label>
    <label>
      <span id="textColorLabel">Texto:</span> 
      <input type="color" id="textColor">
    </label>
    <label>
      <span id="fontFamilyLabel">Tipograf√≠a:</span> 
      <input type="text" id="fontFamily" placeholder="Inter, Arial">
    </label>
    <label>
      <span id="cellEvenLabel">Celdas pares:</span> 
      <input type="color" id="cellEven">
    </label>
    <label>
      <span id="cellOddLabel">Celdas impares:</span> 
      <input type="color" id="cellOdd">
    </label>
    <div style="margin-top:8px">
      <button id="customDefaultBtn">
        <span id="customDefaultText">Default</span>
      </button>
    </div>
  </div>
</div>

<!-- M√≥dulo 4.1 - Script principal -->
<script>
/* M√≥dulo 4.1.1 - Traducciones multiidioma */
const translations = {
  es: {
    // M√≥dulo 4.1.1.1 - Textos de interfaz
    clearJson: 'Limpiar JSON',
    separator: 'Separador:',
    download: 'Descargar...',
    showRaw: 'Mostrar Raw',
    hideRaw: 'Ocultar Raw',
    copyTable: 'Copiar tabla',
    globalFilter: 'Filtro global...',
    edit: 'Editar',
    save: 'Guardar',
    noTable: 'No hay tabla para mostrar',
    noResults: 'No hay resultados para el filtro',
    invalidJson: 'JSON inv√°lido',
    
    // M√≥dulo 4.1.1.2 - Configuraci√≥n
    configuration: 'Configuraci√≥n',
    customTheme: 'Tema personalizado',
    language: 'Idioma:',
    jsonHistory: 'Historial JSON:',
    selectJson: '-- Seleccionar JSON --',
    load: 'Cargar',
    rename: 'Renombrar',
    delete: 'Eliminar',
    webMobile: 'Web / M√≥vil',
    
    // M√≥dulo 4.1.1.3 - Tema personalizado
    customizeTheme: 'Personalizar tema',
    background: 'Fondo:',
    text: 'Texto:',
    typography: 'Tipograf√≠a:',
    evenCells: 'Celdas pares:',
    oddCells: 'Celdas impares:',
    default: 'Default',
    
    // M√≥dulo 4.1.1.4 - Mensajes
    copied: 'Copiado',
    loading: 'Cargando...',
    loadUrl: 'Cargar URL',
    errorLoadingUrl: 'Error cargando URL',
    loadJsonFromHistory: '¬øCargar este JSON desde el historial?',
    selectJsonFromHistory: 'Selecciona un JSON del historial',
    newName: 'Nuevo nombre:',
    selectItemToDelete: 'Selecciona un elemento para eliminar',
    deleteFromHistory: 'Eliminar este JSON del historial?',
    resetThemeConfirm: '¬øRestablecer el tema a los valores predeterminados?',
    filterColumn: 'Filtrar...',
    clearFilter: 'Limpiar'
  },
  en: {
    // M√≥dulo 4.1.1.5 - English interface texts
    clearJson: 'Clear JSON',
    separator: 'Separator:',
    download: 'Download...',
    showRaw: 'Show Raw',
    hideRaw: 'Hide Raw',
    copyTable: 'Copy table',
    globalFilter: 'Global filter...',
    edit: 'Edit',
    save: 'Save',
    noTable: 'No table to display',
    noResults: 'No results for filter',
    invalidJson: 'Invalid JSON',
    
    // M√≥dulo 4.1.1.6 - Configuration
    configuration: 'Configuration',
    customTheme: 'Custom theme',
    language: 'Language:',
    jsonHistory: 'JSON History:',
    selectJson: '-- Select JSON --',
    load: 'Load',
    rename: 'Rename',
    delete: 'Delete',
    webMobile: 'Web / Mobile',
    
    // M√≥dulo 4.1.1.7 - Custom theme
    customizeTheme: 'Customize theme',
    background: 'Background:',
    text: 'Text:',
    typography: 'Typography:',
    evenCells: 'Even cells:',
    oddCells: 'Odd cells:',
    default: 'Default',
    
    // M√≥dulo 4.1.1.8 - Messages
    copied: 'Copied',
    loading: 'Loading...',
    loadUrl: 'Load URL',
    errorLoadingUrl: 'Error loading URL',
    loadJsonFromHistory: 'Load this JSON from history?',
    selectJsonFromHistory: 'Select a JSON from history',
    newName: 'New name:',
    selectItemToDelete: 'Select an item to delete',
    deleteFromHistory: 'Delete this JSON from history?',
    resetThemeConfirm: 'Reset theme to default values?',
    filterColumn: 'Filter...',
    clearFilter: 'Clear'
  }
};

/* M√≥dulo 4.1.2 - Variables globales del DOM */
const el = {
  urlIn: document.getElementById('urlIn'),
  fetchBtn: document.getElementById('fetchBtn'),
  configBtn: document.getElementById('configBtn'),
  jsonin: document.getElementById('jsonin'),
  clearBtn: document.getElementById('clearBtn'),
  downloadSelect: document.getElementById('downloadSelect'),
  separatorSelect: document.getElementById('separatorSelect'),
  toggleRawBtn: document.getElementById('toggleRawBtn'),
  copyBtn: document.getElementById('copyBtn'),
  filterGlobal: document.getElementById('filterGlobal'),
  filterGlobalClearBtn: document.getElementById('filterGlobalClearBtn'),
  editBtn: document.getElementById('editBtn'),
  tableWrap: document.getElementById('tableWrap'),
  rawDisplay: document.getElementById('rawDisplay'),
  drawer: document.getElementById('drawer'),
  tabConfig: document.getElementById('tabConfig'),
  tabCustom: document.getElementById('tabCustom'),
  configContent: document.getElementById('configContent'),
  customPanel: document.getElementById('customPanel'),
  themeLight: document.getElementById('themeLight'),
  themeDark: document.getElementById('themeDark'),
  languageSelect: document.getElementById('languageSelect'),
  jsonHistorySelect: document.getElementById('jsonHistorySelect'),
  loadHistoryBtn: document.getElementById('loadHistoryBtn'),
  deleteHistoryBtn: document.getElementById('deleteHistoryBtn'),
  renameHistoryBtn: document.getElementById('renameHistoryBtn'),
  mobileSwitchBtn: document.getElementById('mobileSwitchBtn'),
  bgColor: document.getElementById('bgColor'),
  textColor: document.getElementById('textColor'),
  fontFamily: document.getElementById('fontFamily'),
  cellEven: document.getElementById('cellEven'),
  cellOdd: document.getElementById('cellOdd'),
  customDefaultBtn: document.getElementById('customDefaultBtn'),
  filterEditRow: document.getElementById('filterEditRow'),
  noDataMessage: document.getElementById('noDataMessage')
};

/* M√≥dulo 4.1.3 - Estado global de la aplicaci√≥n */
const state = {
  originalParsed: null,     // M√≥dulo 4.1.3.1 - JSON original parseado
  originalRows: [],         // M√≥dulo 4.1.3.2 - Filas aplanadas originales
  currentRows: [],          // M√≥dulo 4.1.3.3 - Filas actuales (filtradas/ordenadas)
  currentHeaders: [],       // M√≥dulo 4.1.3.4 - Headers actuales
  sortState: {},            // M√≥dulo 4.1.3.5 - Estado de ordenamiento {col: 'asc'|'desc'}
  editing: false,           // M√≥dulo 4.1.3.6 - Modo edici√≥n activo
  columnFilters: {},        // M√≥dulo 4.1.3.7 - Filtros por columna {colKey: value}
  history: [],              // M√≥dulo 4.1.3.8 - Historial {hash,name,data,date}
  mobileMode: false,        // M√≥dulo 4.1.3.9 - Modo m√≥vil
  virtualStart: 0,          // M√≥dulo 4.1.3.10 - Inicio del scroll virtual
  rowHeight: 32,            // M√≥dulo 4.1.3.11 - Altura estimada de fila
  visibleCount: 0,          // M√≥dulo 4.1.3.12 - N√∫mero de filas visibles
  filterDebounceMs: 200,    // M√≥dulo 4.1.3.13 - Debounce para filtros
  lastParsedFull: null,     // M√≥dulo 4.1.3.14 - JSON completo parseado
  currentLanguage: 'es'     // M√≥dulo 4.1.3.15 - Idioma actual
};

/* M√≥dulo 4.2 - Funciones de utilidad */

/* M√≥dulo 4.2.1 - Funci√≥n SHA-1 para hash */
async function sha1(str){
  const enc = new TextEncoder();
  const buf = await crypto.subtle.digest('SHA-1', enc.encode(str));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

/* M√≥dulo 4.2.2 - Verificar si es objeto */
function isObj(x){ 
  return x && typeof x === 'object' && !Array.isArray(x); 
}

/* M√≥dulo 4.2.3 - Aplanar objeto preservando tipos */
function flattenObject(obj, prefix='', out={}){
  if(Array.isArray(obj)){ 
    out[prefix.slice(0,-1)||'array']=JSON.stringify(obj); 
    return out; 
  }
  for(const k of Object.keys(obj||{})){
    const v = obj[k], key = prefix + k + '.';
    if(isObj(v)) {
      flattenObject(v, key, out);
    } else if(Array.isArray(v)) {
      out[key.slice(0,-1)] = JSON.stringify(v);
    } else {
      out[key.slice(0,-1)] = v;
    }
  }
  return out;
}

/* M√≥dulo 4.2.4 - Reconstruir objeto desde claves aplanadas preservando tipos */
function unflattenObject(flat){
  const res = {};
  for(const flatKey of Object.keys(flat || {})){
    const parts = flatKey.split('.');
    let cur = res;
    for(let i=0;i<parts.length;i++){
      const p = parts[i];
      if(i === parts.length - 1){
        const val = flat[flatKey];
        if(typeof val === 'string'){
          // M√≥dulo 4.2.4.1 - Intentar parsear JSON (arrays/objetos)
          if(val.trim().startsWith('[') || val.trim().startsWith('{')){
            try{ 
              cur[p] = JSON.parse(val); 
              continue; 
            }catch(e){}
          }
          // M√≥dulo 4.2.4.2 - Intentar convertir a n√∫mero
          if(!isNaN(val) && !isNaN(parseFloat(val)) && val.trim() !== ''){
            const num = parseFloat(val);
            if(num.toString() === val.trim()){
              cur[p] = num;
              continue;
            }
          }
          // M√≥dulo 4.2.4.3 - Intentar convertir a booleano
          if(val.toLowerCase() === 'true'){
            cur[p] = true;
            continue;
          }
          if(val.toLowerCase() === 'false'){
            cur[p] = false;
            continue;
          }
          // M√≥dulo 4.2.4.4 - Verificar null/undefined
          if(val.toLowerCase() === 'null'){
            cur[p] = null;
            continue;
          }
          if(val.toLowerCase() === 'undefined'){
            cur[p] = undefined;
            continue;
          }
        }
        cur[p] = val;
      } else {
        if(!cur[p] || typeof cur[p] !== 'object') cur[p] = {};
        cur = cur[p];
      }
    }
  }
  return res;
}

/* M√≥dulo 4.2.5 - Obtener filas desde JSON parseado */
function getRowsFromJson(parsed){
  if(Array.isArray(parsed)){
    state.originalParsed = { type: 'array' };
    return parsed.map(o=>flattenObject(o));
  }
  for(const k of Object.keys(parsed || {})){
    if(Array.isArray(parsed[k])){
      state.originalParsed = { type: 'rootKeyArray', key: k, template: parsed };
      return parsed[k].map(o=>flattenObject(o));
    }
  }
  state.originalParsed = { type: 'object' };
  return [flattenObject(parsed)];
}

/* M√≥dulo 4.2.6 - Intentar parsear JSON con limpieza */
function tryParseJson(text){
  try{ 
    return JSON.parse(text); 
  }catch{
    try {
      const clean = text.replace(/(['"])?([a-zA-Z0-9_]+)(['"])?\s*:/g, '"$2":');
      return JSON.parse(clean);
    }catch{ 
      return null; 
    }
  }
}

/* M√≥dulo 4.2.7 - Generar nombre de archivo din√°mico */
function dynamicFilename(ext){
  const d = new Date();
  const pad = n=> (n<10?'0':'')+n;
  return `JSON_${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}.${ext}`;
}

/* M√≥dulo 4.2.8 - Convertir filas a CSV */
function rowsToCsv(rows, sep){
  if(!rows.length) return '';
  const keys = Array.from(rows.reduce((s,r)=>{ 
    Object.keys(r).forEach(k=>s.add(k)); 
    return s; 
  }, new Set()));
  const esc = v=>{
    if(v==null) return '';
    const s = String(v);
    if(s.includes('"') || s.includes('\n') || s.includes(sep)) {
      return `"${s.replace(/"/g,'""')}"`;
    }
    return s;
  };
  const lines = [keys.join(sep)];
  for(const r of rows) {
    lines.push(keys.map(k=>esc(r[k])).join(sep));
  }
  return lines.join('\n');
}

/* M√≥dulo 4.2.9 - Escapar HTML */
function escapeHtml(s){ 
  return (s||'').replace(/[&<>"']/g, c=>({ 
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' 
  })[c]); 
}

/* M√≥dulo 4.2.10 - Escapar atributos */
function escapeAttribute(s){ 
  return (s||'').replace(/"/g,'&quot;'); 
}

/* M√≥dulo 4.3 - Sistema de traducciones */

/* M√≥dulo 4.3.1 - Obtener texto traducido */
function t(key){
  return translations[state.currentLanguage][key] || key;
}

/* M√≥dulo 4.3.2 - Actualizar textos de la interfaz */
function updateUITexts(){
  // M√≥dulo 4.3.2.1 - Botones principales
  el.clearBtn.textContent = t('clearJson');
  document.getElementById('separatorLabel').textContent = t('separator');
  document.getElementById('downloadOption').textContent = t('download');
  el.toggleRawBtn.textContent = t('showRaw');
  el.copyBtn.textContent = t('copyTable');
  el.filterGlobal.placeholder = t('globalFilter');
  document.getElementById('editBtnText').textContent = state.editing ? t('save') : t('edit');
  document.getElementById('noDataMessage').textContent = t('noTable');
  
  // M√≥dulo 4.3.2.2 - Configuraci√≥n
  document.getElementById('tabConfigText').textContent = t('configuration');
  document.getElementById('tabCustomText').textContent = t('customTheme');
  document.getElementById('languageLabel').textContent = t('language');
  document.getElementById('historyLabel').textContent = t('jsonHistory');
  document.getElementById('selectJsonOption').textContent = t('selectJson');
  document.getElementById('loadHistoryText').textContent = t('load');
  document.getElementById('renameHistoryText').textContent = t('rename');
  document.getElementById('deleteHistoryText').textContent = t('delete');
  document.getElementById('mobileSwitchText').textContent = t('webMobile');
  
  // M√≥dulo 4.3.2.3 - Tema personalizado
  document.getElementById('customThemeTitle').textContent = t('customizeTheme');
  document.getElementById('bgColorLabel').textContent = t('background');
  document.getElementById('textColorLabel').textContent = t('text');
  document.getElementById('fontFamilyLabel').textContent = t('typography');
  document.getElementById('cellEvenLabel').textContent = t('evenCells');
  document.getElementById('cellOddLabel').textContent = t('oddCells');
  document.getElementById('customDefaultText').textContent = t('default');
  
  // M√≥dulo 4.3.2.4 - Actualizar historial
  renderHistoryDropdown();
}

/* M√≥dulo 4.3.3 - Cambiar idioma */
function changeLanguage(lang){
  state.currentLanguage = lang;
  localStorage.setItem('language', lang);
  updateUITexts();
  // M√≥dulo 4.3.3.1 - Re-renderizar tabla para actualizar filtros
  if(state.currentRows.length > 0){
    renderTable();
  }
}

/* M√≥dulo 4.4 - Persistencia de datos */

/* M√≥dulo 4.4.1 - Guardar historial */
function saveHistory(){ 
  try{ 
    localStorage.setItem('jsonHistory', JSON.stringify(state.history)); 
  }catch(e){ 
    console.warn(e); 
  } 
}

/* M√≥dulo 4.4.2 - Cargar historial */
function loadHistory(){
  try{
    const raw = localStorage.getItem('jsonHistory');
    if(!raw) return;
    state.history = JSON.parse(raw) || [];
    renderHistoryDropdown();
  }catch(e){ 
    console.warn('loadHistory', e); 
  }
}

/* M√≥dulo 4.4.3 - Renderizar dropdown de historial */
function renderHistoryDropdown(){
  const sel = el.jsonHistorySelect;
  sel.innerHTML = `<option value="">${t('selectJson')}</option>`;
  state.history.forEach((it, idx)=>{
    const opt = document.createElement('option');
    opt.value = idx;
    opt.textContent = `${it.name || 'JSON '+(idx+1)} (${new Date(it.date).toLocaleString()})`;
    sel.appendChild(opt);
  });
}

/* M√≥dulo 4.4.4 - A√±adir al historial con deduplicaci√≥n */
async function addToHistory(jsonStr, name){
  if(!jsonStr || !jsonStr.trim()) return;
  const h = await sha1(jsonStr);
  const idx = state.history.findIndex(x => x.hash === h);
  if(idx >= 0){
    state.history[idx].date = new Date().toISOString();
  } else {
    state.history.push({ 
      hash: h, 
      data: jsonStr, 
      name: name || ('JSON ' + (state.history.length+1)), 
      date: new Date().toISOString() 
    });
    if(state.history.length > 200) state.history.shift();
  }
  saveHistory();
  renderHistoryDropdown();
}

/* M√≥dulo 4.5 - Control de estado de botones */

/* M√≥dulo 4.5.1 - Actualizar estado de botones de acci√≥n */
function updateActionButtons(){
  const hasData = state.currentRows && state.currentRows.length > 0;
  
  // M√≥dulo 4.5.1.1 - Botones que dependen de datos
  el.downloadSelect.disabled = !hasData;
  el.toggleRawBtn.disabled = !hasData;
  el.copyBtn.disabled = !hasData;
  el.editBtn.disabled = !hasData;
  el.filterGlobal.disabled = !hasData;
  
  // M√≥dulo 4.5.1.2 - Bot√≥n limpiar depende del contenido del textarea
  el.clearBtn.disabled = !el.jsonin.value.trim();
  
  // M√≥dulo 4.5.1.3 - Botones de historial
  el.deleteHistoryBtn.disabled = el.jsonHistorySelect.value === '';
  el.loadHistoryBtn.disabled = el.jsonHistorySelect.value === '';
  
  // M√≥dulo 4.5.1.4 - Mostrar/ocultar controles seg√∫n datos
  if(hasData){
    el.filterEditRow.classList.remove('hide-without-data');
    el.filterEditRow.classList.add('show-with-data');
  } else {
    el.filterEditRow.classList.add('hide-without-data');
    el.filterEditRow.classList.remove('show-with-data');
  }
}

/* M√≥dulo 4.6 - Gesti√≥n del drawer de configuraci√≥n */

/* M√≥dulo 4.6.1 - Mostrar pesta√±a de configuraci√≥n */
function showConfigTab(){
  el.tabConfig.classList.add('active');
  el.tabCustom.classList.remove('active');
  el.configContent.classList.add('active');
  el.configContent.style.display = 'block';
  el.customPanel.style.display = 'none';
  el.customPanel.classList.remove('active');
}

/* M√≥dulo 4.6.2 - Mostrar pesta√±a de tema personalizado */
function showCustomTab(){
  el.tabCustom.classList.add('active');
  el.tabConfig.classList.remove('active');
  el.configContent.classList.remove('active');
  el.configContent.style.display = 'none';
  el.customPanel.style.display = 'block';
  el.customPanel.classList.add('active');
}

/* M√≥dulo 4.7 - Sistema de temas personalizados */

/* M√≥dulo 4.7.1 - Aplicar tema personalizado */
function applyCustomTheme(colors){
  if(colors.bg) document.documentElement.style.setProperty('--bg', colors.bg);
  if(colors.text) document.documentElement.style.setProperty('--fg', colors.text);
  if(colors.cellEven) document.documentElement.style.setProperty('--cell-even', colors.cellEven);
  if(colors.cellOdd) document.documentElement.style.setProperty('--cell-odd', colors.cellOdd);
  if(colors.font) document.body.style.fontFamily = colors.font;
}

/* M√≥dulo 4.7.2 - Cargar tema personalizado */
function loadCustomTheme(){
  try{
    const raw = localStorage.getItem('customTheme');
    if(raw){
      const c = JSON.parse(raw);
      el.bgColor.value = c.bg || '#ffffff';
      el.textColor.value = c.text || '#111111';
      el.fontFamily.value = c.font || '';
      el.cellEven.value = c.cellEven || '#f9f9f9';
      el.cellOdd.value = c.cellOdd || '#eef3ff';
      applyCustomTheme(c);
    } else {
      el.bgColor.value = '#ffffff';
      el.textColor.value = '#111111';
      el.fontFamily.value = '';
      el.cellEven.value = '#f9f9f9';
      el.cellOdd.value = '#eef3ff';
    }
  }catch(e){ 
    console.warn(e); 
  }
}

/* M√≥dulo 4.7.3 - Guardar tema personalizado */
function saveCustomTheme(){
  const c = { 
    bg: el.bgColor.value, 
    text: el.textColor.value, 
    font: el.fontFamily.value, 
    cellEven: el.cellEven.value, 
    cellOdd: el.cellOdd.value
  };
  localStorage.setItem('customTheme', JSON.stringify(c));
  applyCustomTheme(c);
}

/* M√≥dulo 4.8 - Modo m√≥vil */

/* M√≥dulo 4.8.1 - Habilitar/deshabilitar modo m√≥vil */
function enableMobileMode(flag){
  state.mobileMode = !!flag;
  document.body.classList.toggle('mobile', !!flag);
  localStorage.setItem('mobileMode', state.mobileMode ? 'true' : 'false');
}

/* M√≥dulo 4.9 - Control de carga de URL */

/* M√≥dulo 4.9.1 - Actualizar estado del bot√≥n fetch */
function updateFetchButtonState(){
  el.fetchBtn.disabled = !el.urlIn.value.trim();
}

/* M√≥dulo 4.10 - Procesamiento de JSON */

/* M√≥dulo 4.10.1 - Parsear entrada JSON */
async function parseJsonInput(addToHist){
  const txt = el.jsonin.value || '';
  if(!txt.trim()){
    // M√≥dulo 4.10.1.1 - Limpiar estado sin datos
    state.originalParsed = null;
    state.originalRows = []; 
    state.currentRows = []; 
    state.currentHeaders = [];
    el.tableWrap.innerHTML = `<div style="padding:12px;color:var(--muted)">${t('noTable')}</div>`;
    updateActionButtons();
    return;
  }
  
  const parsed = tryParseJson(txt);
  if(!parsed){
    // M√≥dulo 4.10.1.2 - JSON inv√°lido
    el.jsonin.classList.add('error');
    state.originalRows = []; 
    state.currentRows = [];
    el.tableWrap.innerHTML = `<div style="padding:12px;color:var(--error)">${t('invalidJson')}</div>`;
    updateActionButtons();
    return;
  } else {
    el.jsonin.classList.remove('error');
  }
  
  // M√≥dulo 4.10.1.3 - Procesar JSON v√°lido
  const rows = getRowsFromJson(parsed);
  state.originalRows = rows;
  state.currentRows = rows.slice();
  state.lastParsedFull = parsed;
  
  if(addToHist) await addToHistory(txt);
  localStorage.setItem('lastJson', txt);
  
  // M√≥dulo 4.10.1.4 - Reset scroll virtual
  state.virtualStart = 0;
  computeVisibleCount();
  renderTable();
  updateActionButtons();
}

/* M√≥dulo 4.10.2 - Guardar √∫ltimo JSON */
function saveLastJson(){ 
  try{ 
    localStorage.setItem('lastJson', el.jsonin.value || ''); 
  }catch(e){
    console.warn(e);
  } 
}

/* M√≥dulo 4.11 - Utilidades de debounce */

/* M√≥dulo 4.11.1 - Funci√≥n debounce */
function debounce(fn, ms){
  let t;
  return function(...args){
    clearTimeout(t);
    t = setTimeout(()=> fn.apply(this, args), ms);
  };
}

/* M√≥dulo 4.12 - Scroll virtual */

/* M√≥dulo 4.12.1 - Calcular filas visibles */
function computeVisibleCount(){
  const h = el.tableWrap.clientHeight || 420;
  state.visibleCount = Math.ceil(h / state.rowHeight) + 6; // buffer
}

/* M√≥dulo 4.13 - Renderizado de tabla */

/* M√≥dulo 4.13.1 - Renderizar tabla principal */
function renderTable(){
  const rows = state.currentRows || [];
  
  if(!rows.length){
    // M√≥dulo 4.13.1.1 - Mostrar headers si es posible
    const keys = state.originalRows.length ? 
      Array.from(state.originalRows.reduce((s,r)=>{ 
        Object.keys(r).forEach(k=>s.add(k)); 
        return s; 
      }, new Set())) : [];
      
    if(!keys.length){
      el.tableWrap.innerHTML = `<div style="padding:12px;color:var(--muted)">${t('noTable')}</div>`;
      updateActionButtons();
      return;
    }
    
    // M√≥dulo 4.13.1.2 - Renderizar tabla con headers vac√≠a
    const html = buildTableHtml([], keys, true);
    el.tableWrap.innerHTML = html;
    attachTableEvents();
    updateActionButtons();
    return;
  }

  // M√≥dulo 4.13.1.3 - Aplicar filtros
  const globalVal = (el.filterGlobal.value || '').toLowerCase();
  let filtered = rows.filter(r=>{
    if(globalVal){
      if(!Object.values(r).some(v=>String(v||'').toLowerCase().includes(globalVal))) {
        return false;
      }
    }
    for(const [col, val] of Object.entries(state.columnFilters || {})){
      if(val && !(String((r[col]||'')).toLowerCase().includes(val.toLowerCase()))) {
        return false;
      }
    }
    return true;
  });

  // M√≥dulo 4.13.1.4 - Calcular headers
  const keys = Array.from((filtered.length ? filtered : rows).reduce((s,r)=>{ 
    Object.keys(r).forEach(k=>s.add(k)); 
    return s; 
  }, new Set()));
  state.currentHeaders = keys;

  // M√≥dulo 4.13.1.5 - Scroll virtual
  const scrollTop = el.tableWrap.scrollTop || 0;
  state.virtualStart = Math.max(0, Math.floor(scrollTop / state.rowHeight) - 3);
  computeVisibleCount();
  const visibleRows = filtered.slice(state.virtualStart, state.virtualStart + state.visibleCount);

  // M√≥dulo 4.13.1.6 - Calcular espaciadores
  const topSpacerHeight = state.virtualStart * state.rowHeight;
  const bottomSpacerHeight = Math.max(0, (filtered.length - state.virtualStart - visibleRows.length) * state.rowHeight);

  // M√≥dulo 4.13.1.7 - Construir HTML
  let html = '';
  html += `<table><thead><tr>`;
  keys.forEach(k => {
    const cls = (state.sortState[k] === 'asc') ? 'order-asc' : 
                (state.sortState[k] === 'desc') ? 'order-desc' : '';
    html += `<th class="${cls}" data-col="${encodeURIComponent(k)}">${escapeHtml(k)}</th>`;
  });
  html += `</tr>`;

  // M√≥dulo 4.13.1.8 - Fila de filtros
  html += '<tr class="filter-row">';
  keys.forEach(k=>{
    const val = state.columnFilters[k] || '';
    html += `<th><span class="filter-col-wrap">
      <input class="filter-col" data-col="${encodeURIComponent(k)}" 
             value="${escapeAttribute(val)}" placeholder="${t('filterColumn')}" />
      <button class="clear-btn filter-col-clear" data-col="${encodeURIComponent(k)}" 
              title="${t('clearFilter')}">‚úï</button>
    </span></th>`;
  });
  html += '</tr></thead><tbody>';
  
  // M√≥dulo 4.13.1.9 - Espaciador superior
  html += `<tr style="height:${topSpacerHeight}px">
    <td style="padding:0;border:none" colspan="${keys.length}"></td>
  </tr>`;

  if(visibleRows.length){
    // M√≥dulo 4.13.1.10 - Filas visibles
    visibleRows.forEach((r, idx)=>{
      html += '<tr>';
      keys.forEach(k=>{
        const v = r[k] == null ? '' : escapeHtml(String(r[k]));
        html += `<td data-row="${state.virtualStart + idx}" data-col="${encodeURIComponent(k)}">${v}</td>`;
      });
      html += '</tr>';
    });
  } else {
    // M√≥dulo 4.13.1.11 - Sin resultados
    html += `<tr><td colspan="${keys.length}" style="padding:12px;color:var(--muted)">
      ${t('noResults')}
    </td></tr>`;
  }

  // M√≥dulo 4.13.1.12 - Espaciador inferior
  html += `<tr style="height:${bottomSpacerHeight}px">
    <td style="padding:0;border:none" colspan="${keys.length}"></td>
  </tr>`;
  html += `</tbody></table>`;

  el.tableWrap.innerHTML = html;
  attachTableEvents(filtered);
  updateActionButtons();
}

/* M√≥dulo 4.13.2 - Construir HTML de tabla (funci√≥n auxiliar) */
function buildTableHtml(rows, keys, showFilters = false){
  let html = `<table><thead><tr>`;
  keys.forEach(k => {
    const cls = (state.sortState[k] === 'asc') ? 'order-asc' : 
                (state.sortState[k] === 'desc') ? 'order-desc' : '';
    html += `<th class="${cls}" data-col="${encodeURIComponent(k)}">${escapeHtml(k)}</th>`;
  });
  html += `</tr>`;
  
  if(showFilters){
    html += '<tr class="filter-row">';
    keys.forEach(k=>{
      const val = state.columnFilters[k] || '';
      html += `<th><span class="filter-col-wrap">
        <input class="filter-col" data-col="${encodeURIComponent(k)}" 
               value="${escapeAttribute(val)}" placeholder="${t('filterColumn')}" />
        <button class="clear-btn filter-col-clear" data-col="${encodeURIComponent(k)}" 
                title="${t('clearFilter')}">‚úï</button>
      </span></th>`;
    });
    html += '</tr>';
  }
  
  html += '</thead><tbody>';
  if(!rows.length){
    html += `<tr><td colspan="${keys.length}" style="padding:12px;color:var(--muted)">
      ${t('noTable')}
    </td></tr>`;
  }
  html += '</tbody></table>';
  return html;
}

/* M√≥dulo 4.14 - Eventos de tabla */

/* M√≥dulo 4.14.1 - Adjuntar eventos a elementos de tabla */
function attachTableEvents(filteredRows){
  // M√≥dulo 4.14.1.1 - Eventos de ordenamiento en headers
  el.tableWrap.querySelectorAll('th[data-col]').forEach(th=>{
    th.onclick = ()=>{
      const col = decodeURIComponent(th.dataset.col);
      const dir = (state.sortState[col] === 'asc') ? 'desc' : 'asc';
      state.sortState = {}; 
      state.sortState[col] = dir;
      
      state.currentRows.sort((a,b)=>{
        const va = a[col], vb = b[col];
        if(va==null) return 1; 
        if(vb==null) return -1;
        if(!isNaN(va) && !isNaN(vb)) {
          return dir==='asc' ? va - vb : vb - va;
        }
        return dir==='asc' ? 
          String(va).localeCompare(String(vb)) : 
          String(vb).localeCompare(String(va));
      });
      
      el.tableWrap.scrollTop = 0;
      renderTable();
    };
  });

  // M√≥dulo 4.14.1.2 - Eventos de filtros por columna con debounce mejorado
  const deb = debounce(function(){
    renderTable();
  }, state.filterDebounceMs);

  el.tableWrap.querySelectorAll('.filter-col').forEach(inp=>{
    // M√≥dulo 4.14.1.2.1 - Actualizaci√≥n inmediata del estado
    inp.addEventListener('input', (e)=> {
      const col = decodeURIComponent(inp.dataset.col);
      state.columnFilters[col] = inp.value;
      deb();
    });
    
    // M√≥dulo 4.14.1.2.2 - Prevenir bloqueo de escritura
    inp.addEventListener('keydown', (e)=> { 
      e.stopPropagation();
    });
    
    // M√≥dulo 4.14.1.2.3 - Mantener foco durante escritura
    inp.addEventListener('focus', (e)=> {
      e.stopPropagation();
    });
  });

  // M√≥dulo 4.14.1.3 - Botones de limpiar filtros por columna
  el.tableWrap.querySelectorAll('.filter-col-clear').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const col = decodeURIComponent(btn.dataset.col);
      state.columnFilters[col] = '';
      renderTable();
      setTimeout(()=>{
        const selector = `.filter-col[data-col="${encodeURIComponent(col)}"]`;
        const newInp = el.tableWrap.querySelector(selector);
        if(newInp){ 
          newInp.value=''; 
          newInp.focus(); 
        }
      }, 0);
    });
  });

  // M√≥dulo 4.14.1.4 - Manejo de edici√≥n
  if(state.editing){
    el.tableWrap.querySelectorAll('tbody td').forEach(td=>{
      td.contentEditable = 'true';
      td.classList.add('editable-cell');
      td.addEventListener('input', onCellEdit);
    });
  } else {
    el.tableWrap.querySelectorAll('tbody td').forEach(td=>{
      td.contentEditable = 'false';
      td.classList.remove('editable-cell');
      td.removeEventListener('input', onCellEdit);
    });
  }

  // M√≥dulo 4.14.1.5 - Scroll virtual
  el.tableWrap.onscroll = function(){
    const scrollTop = el.tableWrap.scrollTop || 0;
    const newStart = Math.max(0, Math.floor(scrollTop / state.rowHeight) - 3);
    if(newStart !== state.virtualStart){
      state.virtualStart = newStart;
      renderTable();
    }
  };
}

/* M√≥dulo 4.15 - Edici√≥n de celdas */

/* M√≥dulo 4.15.1 - Manejar edici√≥n de celda */
function onCellEdit(e){
  const td = e.target;
  const virtualRowIdx = Number(td.dataset.row);
  const col = decodeURIComponent(td.dataset.col);
  const newVal = td.innerText;
  
  // M√≥dulo 4.15.1.1 - Actualizar currentRows
  const actualIdx = virtualRowIdx;
  if(typeof actualIdx === 'number' && state.currentRows[actualIdx]){
    state.currentRows[actualIdx][col] = newVal;
  }
  
  // M√≥dulo 4.15.1.2 - Reconstruir JSON completo
  if(state.originalParsed && state.originalParsed.type === 'array'){
    const newObj = unflattenObject(state.currentRows[actualIdx]);
    if(state.lastParsedFull && Array.isArray(state.lastParsedFull)){
      state.lastParsedFull[actualIdx] = newObj;
      const jsonStr = JSON.stringify(state.lastParsedFull, null, 2);
      localStorage.setItem('lastJson', jsonStr);
      el.jsonin.value = jsonStr;
    }
  } else if(state.originalParsed && state.originalParsed.type === 'rootKeyArray'){
    const key = state.originalParsed.key;
    if(state.lastParsedFull && state.lastParsedFull[key] && Array.isArray(state.lastParsedFull[key])){
      const newObj = unflattenObject(state.currentRows[actualIdx]);
      state.lastParsedFull[key][actualIdx] = newObj;
      const jsonStr = JSON.stringify(state.lastParsedFull, null, 2);
      localStorage.setItem('lastJson', jsonStr);
      el.jsonin.value = jsonStr;
    }
  } else if(state.originalParsed && state.originalParsed.type === 'object'){
    const newObj = unflattenObject(state.currentRows[actualIdx]);
    state.lastParsedFull = newObj;
    const jsonStr = JSON.stringify(state.lastParsedFull, null, 2);
    localStorage.setItem('lastJson', jsonStr);
    el.jsonin.value = jsonStr;
  }
}

/* M√≥dulo 4.16 - Eventos de interfaz */

/* M√≥dulo 4.16.1 - Limpiar JSON */
el.clearBtn.addEventListener('click', ()=>{
  el.jsonin.value = '';
  state.originalParsed = null;
  state.originalRows = []; 
  state.currentRows = []; 
  state.currentHeaders = [];
  el.tableWrap.innerHTML = `<div style="padding:12px;color:var(--muted)">${t('noTable')}</div>`;
  updateActionButtons();
  localStorage.removeItem('lastJson');
});

/* M√≥dulo 4.16.2 - Copiar tabla */
el.copyBtn.addEventListener('click', async (ev)=>{
  if(!state.currentRows || !state.currentRows.length) return;
  try{
    await navigator.clipboard.writeText(rowsToCsv(state.currentRows, el.separatorSelect.value));
    const note = document.createElement('div'); 
    note.textContent = t('copied');
    note.style.position = 'fixed'; 
    note.style.zIndex = 99999; 
    note.style.padding = '6px 10px';
    note.style.background = '#e0f7fa'; 
    note.style.borderRadius = '6px';
    
    if(ev && ev.clientX && ev.clientY){
      note.style.left = (ev.clientX + 8) + 'px';
      note.style.top = (ev.clientY + 8) + 'px';
    } else {
      note.style.left = '50%'; 
      note.style.top = '12px'; 
      note.style.transform = 'translateX(-50%)';
    }
    
    document.body.appendChild(note);
    setTimeout(()=> note.remove(), 900);
  }catch(e){ 
    console.warn(e); 
  }
});

/* M√≥dulo 4.16.3 - Filtro global con debounce */
const debFilterGlobal = debounce(()=>{ 
  renderTable(); 
  updateActionButtons(); 
}, state.filterDebounceMs);

el.filterGlobal.addEventListener('input', debFilterGlobal);

/* M√≥dulo 4.16.4 - Limpiar filtro global */
el.filterGlobalClearBtn.addEventListener('click', ()=>{
  el.filterGlobal.value = '';
  el.filterGlobal.focus();
  renderTable();
});

/* M√≥dulo 4.16.5 - Toggle de edici√≥n */
el.editBtn.addEventListener('click', ()=>{
  state.editing = !state.editing;
  el.editBtn.classList.toggle('active', state.editing);
  document.getElementById('editBtnText').textContent = state.editing ? t('save') : t('edit');
  if(!state.editing) saveLastJson();
  renderTable();
});

/* M√≥dulo 4.16.6 - Cargar desde URL */
el.fetchBtn.addEventListener('click', async ()=>{
  if(!el.urlIn.value.trim()) return;
  try{
    el.fetchBtn.disabled = true;
    el.fetchBtn.textContent = t('loading');
    const res = await fetch(el.urlIn.value.trim());
    const txt = await res.text();
    const parsed = tryParseJson(txt);
    el.jsonin.value = parsed ? JSON.stringify(parsed, null, 2) : txt;
    state.lastParsedFull = parsed;
    await parseJsonInput(true);
  }catch(e){ 
    console.warn(e); 
    alert(t('errorLoadingUrl')); 
  }
  el.fetchBtn.textContent = t('loadUrl');
  updateFetchButtonState();
});

/* M√≥dulo 4.16.7 - Descargas y visualizaci√≥n raw */
el.downloadSelect.addEventListener('change', ()=>{
  const val = el.downloadSelect.value;
  if(!val) return;
  const sep = el.separatorSelect.value;
  
  if(val === 'csv' || val === 'txt'){
    const content = rowsToCsv(state.currentRows, sep);
    const blob = new Blob([content], {type:'text/plain;charset=utf-8'});
    const a = document.createElement('a'); 
    a.href = URL.createObjectURL(blob); 
    a.download = dynamicFilename(val); 
    a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 1500);
  } else if(val === 'xlsx'){
    const ws = XLSX.utils.json_to_sheet(state.currentRows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
    XLSX.writeFile(wb, dynamicFilename(val));
  }
  el.downloadSelect.value = '';
});

/* M√≥dulo 4.16.8 - Toggle raw display */
el.toggleRawBtn.addEventListener('click', ()=>{
  if(!state.currentRows || !state.currentRows.length) return;
  
  if(el.rawDisplay.style.display === 'block'){ 
    el.rawDisplay.style.display = 'none'; 
    el.tableWrap.style.display = '';
    el.toggleRawBtn.textContent = t('showRaw');
  } else {
    el.rawDisplay.value = rowsToCsv(state.currentRows, el.separatorSelect.value);
    el.rawDisplay.style.display = 'block'; 
    el.tableWrap.style.display = 'none';
    el.toggleRawBtn.textContent = t('hideRaw');
    setTimeout(()=>{ el.rawDisplay.select(); }, 20);
  }
});

/* M√≥dulo 4.16.9 - Actualizar raw al cambiar separador */
el.separatorSelect.addEventListener('change', ()=>{
  if(el.rawDisplay.style.display === 'block' && state.currentRows && state.currentRows.length){
    el.rawDisplay.value = rowsToCsv(state.currentRows, el.separatorSelect.value);
    setTimeout(()=>{ el.rawDisplay.select(); }, 20);
  }
});

/* M√≥dulo 4.17 - Eventos de configuraci√≥n */

/* M√≥dulo 4.17.1 - Drawer toggle */
el.configBtn.addEventListener('click', ()=> {
  el.drawer.classList.toggle('open');
  showConfigTab();
});

/* M√≥dulo 4.17.2 - Pesta√±as del drawer */
el.tabConfig.addEventListener('click', showConfigTab);
el.tabCustom.addEventListener('click', showCustomTab);

/* M√≥dulo 4.17.3 - Temas r√°pidos */
el.themeLight.addEventListener('click', ()=> { 
  localStorage.setItem('theme','light'); 
  document.body.classList.remove('dark'); 
});

el.themeDark.addEventListener('click', ()=> { 
  localStorage.setItem('theme','dark'); 
  document.body.classList.add('dark'); 
});

/* M√≥dulo 4.17.4 - Cambio de idioma */
el.languageSelect.addEventListener('change', ()=>{
  changeLanguage(el.languageSelect.value);
});

/* M√≥dulo 4.17.5 - Historial JSON */
el.jsonHistorySelect.addEventListener('change', ()=>{
  const hasSelection = el.jsonHistorySelect.value !== '';
  el.deleteHistoryBtn.disabled = !hasSelection;
  el.loadHistoryBtn.disabled = !hasSelection;
});

/* M√≥dulo 4.17.6 - Cargar desde historial */
el.loadHistoryBtn.addEventListener('click', ()=>{
  const idx = el.jsonHistorySelect.value;
  if(idx === '') return;
  const item = state.history[idx];
  if(!item) return;
  if(!confirm(t('loadJsonFromHistory'))) return;
  
  el.jsonin.value = item.data;
  state.lastParsedFull = tryParseJson(item.data);
  parseJsonInput(false);
});

/* M√≥dulo 4.17.7 - Renombrar historial */
el.renameHistoryBtn.addEventListener('click', ()=>{
  const idx = el.jsonHistorySelect.value;
  if(idx === '') return alert(t('selectJsonFromHistory'));
  const newName = prompt(t('newName'), state.history[idx].name || '');
  if(newName){ 
    state.history[idx].name = newName; 
    saveHistory(); 
    renderHistoryDropdown(); 
    el.jsonHistorySelect.value = idx; 
  }
});

/* M√≥dulo 4.17.8 - Eliminar del historial */
el.deleteHistoryBtn.addEventListener('click', ()=>{
  const idx = el.jsonHistorySelect.value;
  if(idx === '') return alert(t('selectItemToDelete'));
  if(confirm(t('deleteFromHistory'))){
    state.history.splice(idx, 1);
    saveHistory(); 
    renderHistoryDropdown();
    el.jsonHistorySelect.value = '';
    el.deleteHistoryBtn.disabled = true;
    el.loadHistoryBtn.disabled = true;
  }
});

/* M√≥dulo 4.17.9 - Modo m√≥vil */
el.mobileSwitchBtn.addEventListener('click', ()=>{
  enableMobileMode(!state.mobileMode);
});

/* M√≥dulo 4.18 - Tema personalizado eventos */

/* M√≥dulo 4.18.1 - Inputs de color y fuente */
['bgColor','textColor','fontFamily','cellEven','cellOdd'].forEach(id=>{
  const node = el[id] || document.getElementById(id);
  if(node){
    node.addEventListener('input', ()=>{
      saveCustomTheme();
    });
  }
});

/* M√≥dulo 4.18.2 - Restablecer tema */
el.customDefaultBtn.addEventListener('click', ()=>{
  if(!confirm(t('resetThemeConfirm'))) return;
  localStorage.removeItem('customTheme');
  el.bgColor.value = '#ffffff';
  el.textColor.value = '#111111';
  el.fontFamily.value = '';
  el.cellEven.value = '#f9f9f9';
  el.cellOdd.value = '#eef3ff';
  applyCustomTheme({
    bg:'#ffffff', 
    text:'#111111', 
    font:'', 
    cellEven:'#f9f9f9', 
    cellOdd:'#eef3ff'
  });
});

/* M√≥dulo 4.19 - Eventos globales */

/* M√≥dulo 4.19.1 - Cerrar drawer al hacer click fuera */
document.addEventListener('mousedown', (e)=>{
  if(el.drawer.classList.contains('open')){
    if(!el.drawer.contains(e.target) && !el.configBtn.contains(e.target)){
      el.drawer.classList.remove('open');
      showConfigTab();
    }
  }
});

/* M√≥dulo 4.19.2 - Actualizar estado de fetch button */
el.urlIn.addEventListener('input', updateFetchButtonState);

/* M√≥dulo 4.19.3 - Actualizar botones al cambiar JSON */
el.jsonin.addEventListener('input', ()=>{
  updateActionButtons();
});

/* M√≥dulo 4.19.4 - Redimensionar ventana */
window.addEventListener('resize', ()=>{
  computeVisibleCount();
  renderTable();
});

/* M√≥dulo 4.20 - Inicializaci√≥n */

/* M√≥dulo 4.20.1 - Funci√≥n de inicializaci√≥n principal */
(async function init(){
  try{
    // M√≥dulo 4.20.1.1 - Cargar idioma guardado
    const savedLang = localStorage.getItem('language') || 'es';
    state.currentLanguage = savedLang;
    el.languageSelect.value = savedLang;
    
    // M√≥dulo 4.20.1.2 - Cargar tema claro/oscuro
    const savedTheme = localStorage.getItem('theme');
    if(savedTheme === 'dark') {
      document.body.classList.add('dark');
    } else {
      document.body.classList.remove('dark');
    }

    // M√≥dulo 4.20.1.3 - Cargar tema personalizado
    loadCustomTheme();

    // M√≥dulo 4.20.1.4 - Cargar historial
    loadHistory();

    // M√≥dulo 4.20.1.5 - Cargar √∫ltimo JSON
    const last = localStorage.getItem('lastJson');
    if(last && last.trim()){ 
      el.jsonin.value = last; 
      state.lastParsedFull = tryParseJson(last); 
      await parseJsonInput(false); 
    } else { 
      updateActionButtons(); 
    }

    // M√≥dulo 4.20.1.6 - Estado inicial de botones
    updateFetchButtonState();

    // M√≥dulo 4.20.1.7 - Modo m√≥vil
    const mobile = localStorage.getItem('mobileMode') === 'true';
    enableMobileMode(mobile);

    // M√≥dulo 4.20.1.8 - Actualizar textos de interfaz
    updateUITexts();
    
  }catch(e){ 
    console.warn('init', e); 
  }
})();

/* M√≥dulo 4.21 - Fin del script */
</script>

<!-- M√≥dulo 5.1 - Biblioteca XLSX para exportaci√≥n -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</body>
</html>