<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>.JSON → Tabla Mejorada</title>

<link href="https://fonts.googleapis.com/css?family=Inter:400,700&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#ffffff; 
  --fg:#111111; 
  --header-bg:#f2f2f2; 
  --muted:#888;
  --cell-even:#f9f9f9; 
  --cell-odd:#eef3ff; 
  --accent:#2979ff;
  --input-border:#bbb; 
  --input-bg:#ffffff;
  --button-bg:#f2f6ff;
  --button-border:#bbb;
  --error:#e53935;
  --th-height:40px;
  --row-height:32px;
  --font-main: 'Inter', system-ui, Arial, sans-serif;
}

body.dark{
  --bg:#141414; 
  --fg:#eee; 
  --header-bg:#222; 
  --muted:#aaa;
  --cell-even:#252525; 
  --cell-odd:#202020; 
  --accent:#2979ff;
  --input-border:#555;
  --input-bg:#2a2a2a;
  --button-bg:#333;
  --button-border:#555;
}

*{box-sizing:border-box; font-family:inherit;}
body{
  margin:0; 
  font-family:var(--font-main); 
  color:var(--fg);
  background:var(--bg); 
  -webkit-font-smoothing:antialiased;
}

.container{padding:12px;}
.row{display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap}
.row.top-controls{justify-content:space-between;}
.sr-only{
  position:absolute;
  width:1px;
  height:1px;
  padding:0;
  margin:-1px;
  overflow:hidden;
  clip:rect(0,0,0,0);
  white-space:nowrap;
  border:0;
}
.url-control-group{display:flex;gap:8px;flex:1;max-width:500px;}
.url-input-wrapper{position:relative;flex:0 0 300px;max-width:300px;}
#urlIn{width:100%;padding-right:30px;box-sizing:border-box;}
#urlClearBtn{position:absolute;right:8px;top:50%;transform:translateY(-50%);display:none;z-index:10;background:transparent;border:none;cursor:pointer;padding:0 4px;line-height:1;}
.filter-edit-row{align-items:center;margin-top:10px;gap:8px;}
.filter-global-wrapper{position:relative;width:300px;max-width:100%;}
.table-message{
  padding:20px;
  text-align:center;
  font-size:1.1em;
  border-radius:6px;
  margin:10px 0;
}
.table-message--error{
  color:#ff6b6b;
  border:1px solid #ff6b6b;
  background-color:rgba(255,107,107,0.1);
}

.history-search{
  margin-top:6px;
  display:flex;
  gap:8px;
  align-items:center;
}

.history-search input{
  flex:1;
  padding:6px 10px;
  border-radius:6px;
  border:1px solid var(--input-border);
  background:var(--input-bg);
  color:var(--fg);
}

.history-meta{
  font-size:12px;
  color:var(--muted);
  margin-top:4px;
}

input[type=text], textarea, select, button{
  font-family:var(--font-main);
  font-size:14px;
}

textarea#jsonin{
  width:100%; 
  min-height:100px; 
  padding:10px; 
  border:2px solid var(--input-border);
  border-radius:6px; 
  resize:vertical; 
  background:var(--input-bg); 
  color:var(--fg);
  font-size: 16px; /* Tamaño base */
  line-height: 1.4;
}

/* Ajustes para pantallas medianas */
@media (max-width: 768px) {
  textarea#jsonin {
    font-size: 14px;
    min-height: 100px;
    line-height: 1.3;
  }
}

/* Ajustes para pantallas pequeñas */
@media (max-width: 480px) {
  textarea#jsonin {
    font-size: 13px;
    min-height: 80px;
    line-height: 1.2;
    padding: 8px;
  }
}
textarea#jsonin.error{ 
  border-color:var(--error); 
  box-shadow:0 0 6px rgba(229,57,53,0.18); 
}

input[type=text]{
  padding:6px;
  border-radius:6px;
  border:1px solid var(--input-border);
  background:var(--input-bg);
  color:var(--fg);
}

select{
  padding:6px;
  border-radius:6px;
  border:1px solid var(--input-border);
  background:var(--input-bg);
  color:var(--fg);
}

button{
  padding:6px 10px;
  border-radius:6px;
  border:1px solid var(--button-border);
  background:var(--button-bg);
  color:var(--fg);
  cursor:pointer;
}
button:hover{
  opacity:0.9;
}
button:disabled{
  background:#f0f0f0;
  color:var(--muted);
  cursor:not-allowed;
}
body.dark button:disabled{
  background:#1a1a1a;
}

#drawer{
  position:fixed; 
  right:-100%; 
  top:0; 
  width:360px; 
  height:100vh; 
  background:var(--header-bg);
  box-shadow:0 6px 24px rgba(0,0,0,0.12); 
  transition:right .28s; 
  z-index:9999; 
  padding:12px; 
  overflow:auto;
}
#drawer.open{ right:0; }

.tab-bar{display:flex;gap:6px;margin-bottom:12px}
.tab-btn{
  flex:1;
  padding:10px;
  border-radius:8px;
  border:0;
  background:var(--input-bg);
  color:var(--fg);
  cursor:pointer;
}
.tab-btn.active{
  background:var(--accent);
  color:#fff;
}

#tableWrap{ 
  width:100%; 
  margin-top:10px; 
  border-radius:8px; 
  border:1px solid var(--input-border); 
  background:transparent; 
  min-height:200px; 
  max-height:420px; 
  overflow:auto;
  overflow-y: scroll;
}

table{border-collapse:collapse;width:100%;table-layout:fixed;}
th, td{
  padding:6px 8px;
  border:1px solid var(--input-border); 
  white-space:nowrap; 
  font-family:var(--font-main, monospace); 
  font-size:13px; 
}

th[data-col] {
  cursor: pointer;
  user-select: none;
}

tbody tr{
  height:var(--row-height);
}

td.editable-cell{
  background: rgba(41, 121, 255, 0.12);
  box-shadow: inset 0 0 0 1px rgba(41, 121, 255, 0.3);
  transition: background 0.2s ease, box-shadow 0.2s ease;
}

body.dark td.editable-cell{
  background: rgba(100, 181, 246, 0.25);
  box-shadow: inset 0 0 0 1px rgba(144, 202, 249, 0.35);
}

td.editable-cell:focus { 
  outline: 2px solid rgba(41, 121, 255, 0.45);
  box-shadow: inset 0 0 0 2px rgba(41, 121, 255, 0.45);
  animation: editablePulse 1.2s ease-in-out infinite alternate;
}

@keyframes editablePulse {
  from {
    background: rgba(41, 121, 255, 0.16);
  }
  to {
    background: rgba(41, 121, 255, 0.25);
  }
}

.edit-badge {
  display: none;
  position: sticky;
  top: 8px;
  align-self: flex-start;
  margin-top: 8px;
  padding: 6px 12px;
  border-radius: 999px;
  background: rgba(255, 193, 7, 0.18);
  color: rgba(130, 83, 0, 0.95);
  font-weight: 600;
  border: 1px solid rgba(255, 193, 7, 0.4);
  box-shadow: 0 2px 6px rgba(255, 193, 7, 0.22);
  gap: 6px;
  display: inline-flex;
  align-items: center;
  z-index: 6;
  animation: badgePulse 1.8s ease-in-out infinite;
}

body.dark .edit-badge {
  background: rgba(255, 214, 102, 0.18);
  color: rgba(255, 235, 180, 0.95);
  border-color: rgba(255, 214, 102, 0.5);
  box-shadow: 0 2px 6px rgba(255, 214, 102, 0.35);
}

@keyframes badgePulse {
  from { transform: translateY(0); opacity: 0.9; }
  to { transform: translateY(3px); opacity: 1; }
}

body.edit-mode-active .edit-badge {
  display: inline-flex;
}
thead th{
  height:var(--th-height); 
  background:var(--header-bg); 
  position:sticky; 
  top:0; 
  z-index:4;
  color:var(--fg);
}
thead tr.filter-row th{ 
  top: calc(var(--th-height)); 
  background:var(--header-bg); 
  z-index:5;
} 

tbody tr:nth-child(even) td{background:var(--cell-even)}
tbody tr:nth-child(odd) td{background:var(--cell-odd)}

th.order-asc::after{ content:" ↑"; color:var(--accent); font-weight:bold }
th.order-desc::after{ content:" ↓"; color:var(--accent); font-weight:bold }

.filter-col-wrap { 
  position: relative; 
}

.filter-col { 
  width: 100%; 
  box-sizing: border-box; 
  padding: 4px 28px 4px 8px;
  border-radius: 4px;
  border: 1px solid var(--input-border);
}

.clear-btn {
  position: absolute;
  right: 6px;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  cursor: pointer;
  color: #ff0000;
  font-size: 16px;
  padding: 2px 4px;
  font-weight: bold;
  transition: all 0.2s ease;
  z-index: 10;
  display: none;
}

.url-input-wrapper .clear-btn { right: 6px !important; }
.filter-global-wrapper .clear-btn { right: 8px; }

.filter-global {
  width: 100%;
  padding: 8px 36px 8px 12px;
  border-radius: 6px;
  border: 1px solid var(--input-border);
  background: var(--input-bg);
  color: var(--fg);
}

.clear-btn:hover {
  color: #cc0000;
  transform: translateY(-50%) scale(1.1);
}

.clear-btn:focus {
  outline: 2px solid rgba(255, 0, 0, 0.3);
  border-radius: 50%;
}

.filter-col-wrap .clear-btn,
#filterEditRow .clear-btn,
#urlClearBtn,
#filterGlobalClearBtn {
  color: #ff0000 !important;
  font-weight: bold;
  text-shadow: 0 0 1px rgba(0,0,0,0.2);
}

.filter-col-wrap .clear-btn:hover,
#filterEditRow .clear-btn:hover,
#urlClearBtn:hover,
#filterGlobalClearBtn:hover {
  color: #cc0000 !important;
  transform: translateY(-50%) scale(1.15);
}

#urlClearBtn {
  right: 8px !important;
  color: #e53935 !important;
}

td.editable-cell:focus { 
  outline: 2px solid rgba(41, 121, 255, 0.16); 
}
@keyframes filterBlink {
  0% { 
    background-color: var(--cell-even); 
    opacity: 1; 
  }
  25% { 
    background-color: rgba(255, 235, 59, 0.2); 
    opacity: 1; 
  }
  50% { 
    background-color: rgba(255, 235, 59, 0.35); 
    opacity: 1; 
  }
  75% { 
    background-color: rgba(255, 235, 59, 0.2); 
    opacity: 1; 
  }
  100% { 
    background-color: var(--cell-even); 
    opacity: 1; 
  }
}

@keyframes filterBlinkOdd {
  0% { 
    background-color: var(--cell-odd); 
    opacity: 1; 
  }
  25% { 
    background-color: rgba(255, 235, 59, 0.15); 
    opacity: 1; 
  }
  50% { 
    background-color: rgba(255, 235, 59, 0.3); 
    opacity: 1; 
  }
  75% { 
    background-color: rgba(255, 235, 59, 0.15); 
    opacity: 1; 
  }
  100% { 
    background-color: var(--cell-odd); 
    opacity: 1; 
  }
}

.global-match {
  animation: filterBlink 0.8s ease-in-out;
}

.column-match {
  animation: filterBlink 0.6s ease-in-out;
}

tbody tr:nth-child(even) .global-match,
tbody tr:nth-child(even) .column-match {
  animation: filterBlink 0.8s ease-in-out;
}

tbody tr:nth-child(odd) .global-match,
tbody tr:nth-child(odd) .column-match {
  animation: filterBlinkOdd 0.8s ease-in-out;
}

#rawDisplay{
  display:none;
  width:100%;
  min-height:160px;
  padding:10px;
  border:2px solid var(--input-border);
  border-radius:6px;
  white-space:pre;
  overflow:auto;
  background:var(--input-bg);
  color:var(--fg);
}

.hide-without-data{
  display:none;
}
.show-with-data{
  display:flex;
}

@media (max-width:720px){
  #drawer{width:100vw}
  thead tr.filter-row th{ top: calc(var(--th-height) + 2px) }
}

/* Estilos de urlClearBtn movidos a la regla anterior */

.custom-panel {
  display: flex;
  flex-direction: column;
  gap: 12px;
  padding: 20px;
  border: 1px solid var(--input-border);
  border-radius: 8px;
  background: var(--input-bg);
  max-width: 320px;
  margin: 0 auto;
  color: var(--fg);
  transition: background-color 0.3s ease, border-color 0.3s ease;
}

.dark .custom-panel {
  background: var(--input-bg);
  border-color: var(--input-border);
}

.dark .setting-row input[type="color"] {
  background: #333;
  border-color: #555;
}

.dark .font-selector {
  background: #333;
  border-color: #555;
  color: #fff;
}

.custom-panel h2 {
  font-size: 1.2em;
  margin: 0 0 16px 0;
  padding-bottom: 8px;
  border-bottom: 1px solid var(--input-border);
  color: var(--fg);
  text-align: center;
}

.setting-container {
  width: 100%;
  max-width: 300px;
  margin: 0 auto;
}

.setting-row {
  display: flex;
  justify-content: normal;
  align-items: center;
  padding: 10px 0;
  width: 100%;
  margin: 0 auto;
}

.setting-row label {
  width: 140px;
  font-weight: 500;
  color: var(--fg);
  font-size: 14px;
  text-align: right;
  margin-right: 15px;
  cursor: default; 
  user-select: none;
  padding: 5px 0;
}

.setting-row input[type="color"] {
  width: 60px;
  height: 32px;
  border: 1px solid var(--input-border);
  border-radius: 4px;
  cursor: pointer;
  background: #ffffff;
  padding: 2px;
  transition: all 0.2s ease;
  outline: none;
  -webkit-appearance: none;
  appearance: none;
}

.dark .setting-row input[type="color"] {
  background: #333333;
  border-color: #555555;
}

.setting-row input[type="color"]::-webkit-color-swatch {
  border: none;
  border-radius: 2px;
  padding: 0;
}

.setting-row input[type="color"]::-webkit-color-swatch-wrapper {
  padding: 0;
}

.setting-row input[type="color"]:focus,
.font-selector:focus,
button:focus {
  outline: none;
  box-shadow: 0 0 0 2px var(--accent);
}

.setting-row input[type="color"]:active {
  transform: scale(0.98);
}

.font-selector {
  width: 160px;
  padding: 6px 8px;
  border-radius: 4px;
  border: 1px solid var(--input-border);
  background: var(--bg);
  color: var(--fg);
  font-size: 14px;
  cursor: pointer;
}

.reset-container {
  text-align: center;
  margin-top: 20px;
  padding-top: 10px;
  border-top: 1px solid var(--input-border);
}

.setting-row input[type="color"]:hover {
  transform: scale(1.05);
}

.reset-btn {
  padding: 10px 16px;
  border-radius: 6px;
  background: var(--button-bg);
  border: 1px solid var(--button-border);
  color: var(--fg);
  cursor: pointer;
  font-size: 14px;
  transition: all 0.2s ease;
  margin-top: 8px;
  width: 100%;
  max-width: 280px;
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.reset-btn:hover {
  background: var(--accent);
  color: white;
  border-color: var(--accent);
}

#customPanel .form-row {
  margin: 0;
  padding: 0;
}

#fontFamily {
  width: 100%;
  padding: 10px;
  border-radius: 6px;
  border: 1px solid var(--input-border);
  background: var(--bg);
  color: var(--fg);
  font-size: 14px;
  cursor: pointer;
  transition: border-color 0.2s ease;
}

#fontFamily:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 2px rgba(41, 121, 255, 0.1);
}

#fontFamily {
  position: relative;
  z-index: 1001;
  padding: 4px 8px;
  border-radius: 4px;
  border: 1px solid var(--input-border);
  background: var(--input-bg);
  color: var(--fg);
  min-width: 150px;
}

#fontFamily option {
  position: relative;
  z-index: 1002;
  padding: 4px 8px;
}

select {
  -webkit-appearance: menulist;
  -moz-appearance: menulist;
  appearance: menulist;
}

html {
  overflow-y: scroll;
}
</style>
</head>
<body>
<div class="container">

  <div class="row top-controls" id="topControls">
    <div class="url-control-group" role="group" aria-label="Controles de URL" data-i18n-aria-label="urlControls">
      <div class="url-input-wrapper">
        <label for="urlIn" class="sr-only">Pegar URL</label>
        <input type="text" id="urlIn" placeholder="Pega URL aquí..." aria-label="Pegar URL" data-i18n-placeholder="urlPlaceholder" data-i18n-aria-label="urlPlaceholder" />
        <button id="urlClearBtn" class="clear-btn" title="Limpiar URL" aria-label="Limpiar URL" data-i18n-title="clearUrl" data-i18n-aria-label="clearUrl" style="right: 8px !important;">✕</button>
      </div>
      <button id="fetchBtn" aria-label="Cargar URL" title="Cargar URL" data-i18n="loadUrl" data-i18n-title="loadUrl" data-i18n-aria-label="loadUrl">Cargar URL</button>
    </div>
    <button id="configBtn" aria-label="Abrir configuración" title="Abrir configuración" class="config-btn" data-i18n-title="openConfiguration" data-i18n-aria-label="openConfiguration">⚙️</button>
  </div>

  <div class="row">
    <textarea id="jsonin" aria-label="Área JSON" placeholder="Pega o escribe JSON aquí" data-i18n-placeholder="jsonPlaceholder" data-i18n-aria-label="jsonPlaceholder"></textarea>
  </div>

  <div class="row">
    <button id="clearBtn" aria-label="Limpiar JSON" title="Limpiar JSON" data-i18n="clearJson" data-i18n-title="clearJson" data-i18n-aria-label="clearJson">Limpiar JSON</button>

    <label style="display:flex;align-items:center;gap:6px">
      <span id="separatorLabel" data-i18n="separator">Separador:</span>
      <select id="separatorSelect" aria-label="Separador" data-i18n-aria-label="separator">
        <option value="	">Tab</option>
        <option value=",">,</option>
        <option value=";">;</option>
      </select>
    </label>

    <select id="downloadSelect" aria-label="Descargar" disabled data-i18n-aria-label="download">
      <option value="" id="downloadOption" data-i18n="download">Descargar...</option>
      <option value="csv">CSV</option>
      <option value="xlsx">XLSX</option>
      <option value="txt">TXT</option>
    </select>

    <button id="toggleRawBtn" disabled aria-label="Mostrar raw" title="Mostrar/ocultar JSON raw" data-i18n-title="toggleRaw" data-i18n-aria-label="toggleRaw">Mostrar Raw</button>
    <button id="copyBtn" disabled aria-label="Copiar tabla" title="Copiar tabla al portapapeles" data-i18n="copyTable" data-i18n-title="copyTable" data-i18n-aria-label="copyTable">Copiar tabla</button>
  </div>

  <div class="row hide-without-data filter-edit-row" id="filterEditRow">
    <div class="filter-global-wrapper">
      <label for="filterGlobal" class="sr-only">Filtro global</label>
      <input type="text" id="filterGlobal" class="filter-global" placeholder="Filtro global..." autocomplete="off" data-i18n-placeholder="globalFilter" data-i18n-aria-label="globalFilter" />
      <button id="filterGlobalClearBtn" class="clear-btn" title="Limpiar filtro global" aria-label="Limpiar filtro global" data-i18n-title="clearFilter" data-i18n-aria-label="clearFilter">✕</button>
    </div>
    <button id="editBtn" aria-label="Editar tabla" title="Habilitar/deshabilitar edición" disabled data-i18n-title="toggleEdit" data-i18n-aria-label="toggleEdit">✏️ <span id="editBtnText">Editar</span></button>
  </div>

  <div id="tableWrap" aria-live="polite">
  </div>

  <div id="editModeBadge" class="edit-badge" role="status" aria-live="polite" aria-hidden="true">
    ✏️ <span data-i18n="editModeActive">Modo edición activo</span>
  </div>

  <div id="liveRegion" class="sr-only" aria-live="polite" aria-atomic="true"></div>

  <div style="margin-top:8px">
    <textarea id="rawDisplay" readonly aria-label="Raw CSV" data-i18n-aria-label="rawCsv"></textarea>
  </div>
</div>

<div id="drawer" role="dialog" aria-label="Configuración" style="position:fixed; padding-top:48px;">
  <button id="drawerCloseBtn" class="tab-btn" aria-label="Cerrar configuración" title="Cerrar configuración" style="position:absolute;top:10px;left:10px;width:36px;height:36px;font-size:22px;z-index:10001;display:flex;align-items:center;justify-content:center;line-height:36px;" data-i18n-title="closeConfiguration" data-i18n-aria-label="closeConfiguration">✕</button>
  <div class="tab-bar">
    <button class="tab-btn active" id="tabConfig" aria-label="Configuración" aria-selected="true" role="tab" data-i18n-aria-label="configuration">
      <span id="tabConfigText">Configuración</span>
    </button>
    <button class="tab-btn" id="tabCustom" aria-label="Tema personalizado" aria-selected="false" role="tab" data-i18n-aria-label="customTheme">
      <span id="tabCustomText">Tema personalizado</span>
    </button>
  </div>

  <div id="configContent" class="active">

    <div style="display:flex;gap:8px;margin-bottom:10px;">
      <button id="themeLight" aria-label="Cambiar a modo claro" title="Modo claro" data-i18n-title="lightMode" data-i18n-aria-label="lightMode">🌞</button>
      <button id="themeDark" aria-label="Cambiar a modo oscuro" title="Modo oscuro" data-i18n-title="darkMode" data-i18n-aria-label="darkMode">🌙</button>
    </div>

    <label>
      <span id="languageLabel" data-i18n="language">Idioma:</span>
      <select id="languageSelect" style="width:100%;margin-top:6px">
        <option value="en" id="languageOptionEn" data-i18n="languageEnglishDefault">English (default)</option>
        <option value="es" id="languageOptionEs" data-i18n="languageSpanish">Español</option>
      </select>
    </label>

    <div style="margin-top:12px;">
      <label>
        <span id="historyLabel" data-i18n="jsonHistory">Historial JSON:</span>
        <select id="jsonHistorySelect" style="width:100%;margin-top:6px">
          <option value="" id="selectJsonOption">-- Seleccionar JSON --</option>
        </select>
      </label>
      <div class="history-search">
        <label for="historySearchInput" class="sr-only">Buscar historial</label>
        <input type="text" id="historySearchInput" placeholder="Buscar en historial..." autocomplete="off" data-i18n-placeholder="historySearchPlaceholder" />
      </div>
      <div class="history-meta" id="historyMeta" aria-live="polite"></div>
      <div style="display:flex;gap:6px;margin-top:6px;">
        <button id="loadHistoryBtn" aria-label="Cargar historial" title="Cargar historial" disabled data-i18n-title="load" data-i18n-aria-label="load">
          <span id="loadHistoryText">Cargar</span>
        </button>
        <button id="renameHistoryBtn" aria-label="Renombrar entrada del historial" title="Renombrar entrada" data-i18n-title="rename" data-i18n-aria-label="rename">
          <span id="renameHistoryText">Renombrar</span>
        </button>
        <button id="deleteHistoryBtn" aria-label="Eliminar entrada del historial" title="Eliminar entrada" disabled data-i18n-title="delete" data-i18n-aria-label="delete">
          <span id="deleteHistoryText">Eliminar</span>
        </button>
      </div>
    </div>

    <div style="margin-top:12px; opacity: 0.6;" title="Función deshabilitada">
      <button id="mobileSwitchBtn" aria-label="Cambio entre vista web y móvil deshabilitado" title="Cambio entre vista web y móvil deshabilitado" disabled data-i18n="webMobile" data-i18n-title="webMobile" data-i18n-aria-label="webMobile">
        <span id="mobileSwitchText">Web / Móvil (deshabilitado)</span>
      </button>
    </div>
  </div>

  <div id="customPanel" class="custom-panel" style="display:none;">
    <h2 id="customThemeTitle" data-i18n="customizeTheme">Tema personalizado</h2>

    <div class="setting-container">
      <div class="setting-row">
        <label id="bgColorLabel" data-i18n="background">Fondo</label>
        <input type="color" id="bgColor" value="#ffffff">
      </div>

      <div class="setting-row">
        <label id="textColorLabel" data-i18n="text">Texto</label>
        <input type="color" id="textColor" value="#000000">
      </div>

      <div class="setting-row">
        <label id="cellOddLabel" data-i18n="oddCells">Celdas impares</label>
        <input type="color" id="cellOdd" value="#f0f0f0">
      </div>

      <div class="setting-row">
        <label id="cellEvenLabel" data-i18n="evenCells">Celdas pares</label>
        <input type="color" id="cellEven" value="#ffffff">
      </div>

      <div class="setting-row">
        <label id="fontFamilyLabel" data-i18n="typography">Tipografía</label>
        <select id="fontFamily" class="font-selector">
          <option value="'Inter', Arial, sans-serif">Inter (predeterminada)</option>
          <option value="'Roboto', Arial, sans-serif">Roboto</option>
          <option value="'Open Sans', Arial, sans-serif">Open Sans</option>
          <option value="'Segoe UI', Tahoma, sans-serif">Segoe UI</option>
          <option value="'Helvetica Neue', Arial, sans-serif">Helvetica</option>
          <option value="'Times New Roman', Times, serif">Times New Roman</option>
          <option value="'Courier New', Courier, monospace">Courier New</option>
          <option value="'Georgia', serif">Georgia</option>
        </select>
      </div>
    </div>

    <div class="reset-container">
      <button id="customDefaultBtn" class="reset-btn" aria-label="Restablecer valores predeterminados" title="Restablecer valores predeterminados" data-i18n-title="default" data-i18n-aria-label="default">
        <span id="customDefaultText" data-i18n="default">Restablecer valores predeterminados</span>
      </button>
    </div>
  </div>
</div>

<script>

const translations = {
  es: {
        clearJson: 'Limpiar JSON',
    separator: 'Separador:',
    download: 'Descargar...',
    showRaw: 'Mostrar Raw',
    hideRaw: 'Ocultar Raw',
    copyTable: 'Copiar tabla',
    globalFilter: 'Filtro global...',
    edit: 'Editar',
    save: 'Guardar',
    noTable: 'No hay tabla para mostrar',
    noResults: 'No hay resultados para el filtro',
    invalidJson: 'JSON inválido',

        configuration: 'Configuración',
    customTheme: 'Tema personalizado',
    language: 'Idioma:',
    languageEnglishDefault: 'Inglés (predeterminado)',
    languageSpanish: 'Español',
    jsonHistory: 'Historial JSON:',
    selectJson: '-- Seleccionar JSON --',
    historySearchPlaceholder: 'Buscar en historial...',
    historyCount: 'Mostrando {current} de {total} (máximo {limit})',
    historyNoMatches: 'Sin coincidencias en el historial',
    historySizeExceeded: 'El JSON es demasiado grande para guardar en el historial.',
    sortColumnDefault: 'Ordenar por {column}. Presiona para cambiar el orden.',
    sortColumnAsc: '{column} ordenado ascendente. Presiona para ordenar descendente.',
    sortColumnDesc: '{column} ordenado descendente. Presiona para ordenar ascendente.',
    lastJsonSizeExceeded: 'El JSON es demasiado grande para guardarlo localmente.',
    urlControls: 'Controles de URL',
    urlPlaceholder: 'Pega URL aquí...',
    jsonPlaceholder: 'Pega o escribe JSON aquí',
    clearUrl: 'Limpiar URL',
    openConfiguration: 'Abrir configuración',
    closeConfiguration: 'Cerrar configuración',
    lightMode: 'Cambiar a modo claro',
    darkMode: 'Cambiar a modo oscuro',
    toggleRaw: 'Mostrar u ocultar JSON raw',
    toggleEdit: 'Habilitar o deshabilitar edición',
    rawCsv: 'Ver CSV en bruto',
    load: 'Cargar',
    rename: 'Renombrar',
    delete: 'Eliminar',
    webMobile: 'Web / Móvil',
    editModeActive: 'Modo edición activo',
    sortAnnounceAsc: '{column} ordenado ascendente.',
    sortAnnounceDesc: '{column} ordenado descendente.',
    sortAnnounceReset: 'Orden sin aplicar en {column}.',
    filterCleared: 'Filtro de {column} eliminado.',
    globalFilterCleared: 'Filtro global eliminado.',

        customizeTheme: 'Personalizar tema',
    background: 'Fondo:',
    text: 'Texto:',
    typography: 'Tipografía:',
    evenCells: 'Celdas pares:',
    oddCells: 'Celdas impares:',
    default: 'Default',

        copied: 'Copiado',
    loading: 'Cargando...',
    loadUrl: 'Cargar URL',
    errorLoadingUrl: 'Error cargando URL',
    loadJsonFromHistory: '¿Cargar este JSON desde el historial?',
    selectJsonFromHistory: 'Selecciona un JSON del historial',
    newName: 'Nuevo nombre:',
    selectItemToDelete: 'Selecciona un elemento para eliminar',
    deleteFromHistory: 'Eliminar este JSON del historial?',
    resetThemeConfirm: '¿Restablecer el tema a los valores predeterminados?',
    filterColumn: 'Filtrar...',
    clearFilter: 'Limpiar'
  },
  en: {
        clearJson: 'Clear JSON',
    separator: 'Separator:',
    download: 'Download...',
    showRaw: 'Show Raw',
    hideRaw: 'Hide Raw',
    copyTable: 'Copy table',
    globalFilter: 'Global filter...',
    edit: 'Edit',
    save: 'Save',
    noTable: 'No table to display',
    noResults: 'No results for filter',
    invalidJson: 'Invalid JSON',

        configuration: 'Configuration',
    customTheme: 'Custom theme',
    language: 'Language:',
    languageEnglishDefault: 'English (default)',
    languageSpanish: 'Spanish',
    jsonHistory: 'JSON History:',
    selectJson: '-- Select JSON --',
    historySearchPlaceholder: 'Search history...',
    historyCount: 'Showing {current} of {total} (max {limit})',
    historyNoMatches: 'No matches in history',
    historySizeExceeded: 'JSON is too large to store in history.',
    sortColumnDefault: 'Sort by {column}. Press to change order.',
    sortColumnAsc: '{column} sorted ascending. Press to sort descending.',
    sortColumnDesc: '{column} sorted descending. Press to sort ascending.',
    lastJsonSizeExceeded: 'JSON is too large to store locally.',
    urlControls: 'URL controls',
    urlPlaceholder: 'Paste URL here...',
    jsonPlaceholder: 'Paste or type JSON here',
    clearUrl: 'Clear URL',
    openConfiguration: 'Open configuration',
    closeConfiguration: 'Close configuration',
    lightMode: 'Switch to light mode',
    darkMode: 'Switch to dark mode',
    toggleRaw: 'Show or hide raw JSON',
    toggleEdit: 'Enable or disable editing',
    rawCsv: 'View raw CSV',
    load: 'Load',
    rename: 'Rename',
    delete: 'Delete',
    webMobile: 'Web / Mobile',
    editModeActive: 'Edit mode active',
    sortAnnounceAsc: '{column} sorted ascending.',
    sortAnnounceDesc: '{column} sorted descending.',
    sortAnnounceReset: 'Sorting cleared on {column}.',
    filterCleared: 'Filter cleared for {column}.',
    globalFilterCleared: 'Global filter cleared.',

        customizeTheme: 'Customize theme',
    background: 'Background:',
    text: 'Text:',
    typography: 'Typography:',
    evenCells: 'Even cells:',
    oddCells: 'Odd cells:',
    default: 'Default',

        copied: 'Copied',
    loading: 'Loading...',
    loadUrl: 'Load URL',
    errorLoadingUrl: 'Error loading URL',
    loadJsonFromHistory: 'Load this JSON from history?',
    selectJsonFromHistory: 'Select a JSON from history',
    newName: 'New name:',
    selectItemToDelete: 'Select an item to delete',
    deleteFromHistory: 'Delete this JSON from history?',
    resetThemeConfirm: 'Reset theme to default values?',
    filterColumn: 'Filter...',
    clearFilter: 'Clear'
  }
};

const el = {
  urlIn: document.getElementById('urlIn'),
  urlClearBtn: document.getElementById('urlClearBtn'),
  fetchBtn: document.getElementById('fetchBtn'),
  configBtn: document.getElementById('configBtn'),
  jsonin: document.getElementById('jsonin'),
  clearBtn: document.getElementById('clearBtn'),
  downloadSelect: document.getElementById('downloadSelect'),
  separatorSelect: document.getElementById('separatorSelect'),
  toggleRawBtn: document.getElementById('toggleRawBtn'),
  copyBtn: document.getElementById('copyBtn'),
  filterGlobal: document.getElementById('filterGlobal'),
  filterGlobalClearBtn: document.getElementById('filterGlobalClearBtn'),
  editBtn: document.getElementById('editBtn'),
  tableWrap: document.getElementById('tableWrap'),
  rawDisplay: document.getElementById('rawDisplay'),
  drawer: document.getElementById('drawer'),
  tabConfig: document.getElementById('tabConfig'),
  tabCustom: document.getElementById('tabCustom'),
  configContent: document.getElementById('configContent'),
  customPanel: document.getElementById('customPanel'),
  themeLight: document.getElementById('themeLight'),
  themeDark: document.getElementById('themeDark'),
  languageSelect: document.getElementById('languageSelect'),
  jsonHistorySelect: document.getElementById('jsonHistorySelect'),
  loadHistoryBtn: document.getElementById('loadHistoryBtn'),
  deleteHistoryBtn: document.getElementById('deleteHistoryBtn'),
  renameHistoryBtn: document.getElementById('renameHistoryBtn'),
  historySearchInput: document.getElementById('historySearchInput'),
  historyMeta: document.getElementById('historyMeta'),
  liveRegion: document.getElementById('liveRegion'),
  mobileSwitchBtn: document.getElementById('mobileSwitchBtn'),
  bgColor: document.getElementById('bgColor'),
  textColor: document.getElementById('textColor'),
  fontFamily: document.getElementById('fontFamily'),
  cellEven: document.getElementById('cellEven'),
  cellOdd: document.getElementById('cellOdd'),
  customDefaultBtn: document.getElementById('customDefaultBtn'),
  filterEditRow: document.getElementById('filterEditRow'),
  drawerCloseBtn: document.getElementById('drawerCloseBtn')
};

const state = {
  originalParsed: null,
  originalRows: [],
  currentRows: [],
  currentHeaders: [],
  sortState: {},
  editing: false,
  columnFilters: {},
  history: [],
  historyFilter: '',
  mobileMode: false,
  virtualStart: 0,
  rowHeight: 32,
  visibleCount: 0,
  filterDebounceMs: 200,
  lastParsedFull: null,
  currentLanguage: 'en',
  cache: {
    filteredRows: null,
    filterSignature: '',
    headerKeys: null,
    dataVersion: 0
  }
};

const MAX_LAST_JSON_SIZE = 2_000_000;
const HISTORY_MAX_JSON_SIZE = 250_000;
const HISTORY_MAX_ENTRIES = 100;
const HISTORY_DISPLAY_LIMIT = 50;
const JSON_INDENT = 2;

let announceTimer = null;

const validators = {
  isValidUrl(value){
    if(!value || typeof value !== 'string') return false;
    const trimmed = value.trim();
    if(trimmed.length === 0) return false;
    try{
      new URL(trimmed);
      return true;
    }catch(e){
      try{
        new URL(`https://${trimmed}`);
        return true;
      }catch(e2){
        return false;
      }
    }
  }
};

function normalizeUrl(value){
  if(!value) return '';
  try{
    return new URL(value).href;
  }catch(e){
    try{
      return new URL(`https://${value}`).href;
    }catch(e2){
      return value;
    }
  }
}

async function fetchWithFallback(url, rawValue){
  try{
    const res = await fetch(url);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    return res;
  }catch(err){
    const hasProtocol = /^https?:\/\//i.test(rawValue || '');
    if(!hasProtocol){
      try{
        const fallbackUrl = `http://${rawValue}`;
        const res = await fetch(fallbackUrl);
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        return res;
      }catch(err2){
        throw err2;
      }
    }
    throw err;
  }
}

function resetUrlVisualState(){
  el.urlIn.style.borderColor = '';
  el.urlIn.style.boxShadow = '';

  if(el.urlIn.disabled){
    el.urlIn.style.opacity = '0.6';
    el.urlIn.style.cursor = 'not-allowed';
  } else {
    el.urlIn.style.opacity = '1';
    el.urlIn.style.cursor = 'text';
  }

  if(el.fetchBtn.disabled){
    el.fetchBtn.style.opacity = '0.6';
    el.fetchBtn.style.cursor = 'not-allowed';
  } else {
    el.fetchBtn.style.opacity = '1';
    el.fetchBtn.style.cursor = 'pointer';
  }
}

function isObj(x){ 
  return x && typeof x === 'object' && !Array.isArray(x); 
}

function flattenObject(obj, prefix='', out={}){
  if(Array.isArray(obj)){ 
    out[prefix.slice(0,-1)||'array']=JSON.stringify(obj); 
    return out; 
  }
  for(const k of Object.keys(obj||{})){
    const v = obj[k], key = prefix + k + '.';
    if(isObj(v)) {
      flattenObject(v, key, out);
    } else if(Array.isArray(v)) {
      out[key.slice(0,-1)] = JSON.stringify(v);
    } else {
            out[key.slice(0,-1)] = v;
    }
  }
  return out;
}

function unflattenObject(flat){
  const res = {};
  for(const flatKey of Object.keys(flat || {})){
    const parts = flatKey.split('.');
    let cur = res;
    for(let i=0;i<parts.length;i++){
      const p = parts[i];
      if(i === parts.length - 1){
        const val = flat[flatKey];
        if(typeof val === 'string'){
                    if(val.trim().startsWith('[') || val.trim().startsWith('{')){
            try{ 
              cur[p] = JSON.parse(val); 
              continue; 
            }catch(e){}
          }
                    if(!isNaN(val) && !isNaN(parseFloat(val)) && val.trim() !== ''){
            const num = parseFloat(val);
            if(num.toString() === val.trim()){
              cur[p] = num;
              continue;
            }
          }
                    if(val.toLowerCase() === 'true'){
            cur[p] = true;
            continue;
          }
          if(val.toLowerCase() === 'false'){
            cur[p] = false;
            continue;
          }
                    if(val.toLowerCase() === 'null'){
            cur[p] = null;
            continue;
          }
          if(val.toLowerCase() === 'undefined'){
            cur[p] = undefined;
            continue;
          }
        }
        cur[p] = val;
      } else {
        if(!cur[p] || typeof cur[p] !== 'object') cur[p] = {};
        cur = cur[p];
      }
    }
  }
  return res;
}

function getRowsFromJson(parsed){
  if(Array.isArray(parsed)){
    state.originalParsed = { type: 'array' };
    return parsed.map(o=>flattenObject(o));
  }
  for(const k of Object.keys(parsed || {})){
    if(Array.isArray(parsed[k])){
      state.originalParsed = { type: 'rootKeyArray', key: k, template: parsed };
      return parsed[k].map(o=>flattenObject(o));
    }
  }
  state.originalParsed = { type: 'object' };
  return [flattenObject(parsed)];
}

function tryParseJson(text){
  try{ 
    return JSON.parse(text); 
  }catch{
    try {
      const clean = text.replace(/(['"])?([a-zA-Z0-9_]+)(['"])?\s*:/g, '"$2":');
      return JSON.parse(clean);
    }catch{ 
      return null; 
    }
  }
}

function dynamicFilename(ext){
  const d = new Date();
  const pad = n=> (n<10?'0':'')+n;
  return `JSON_${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}.${ext}`;
}

function rowsToCsv(rows, sep){
  if(!rows.length) return '';
  const keys = Array.from(rows.reduce((s,r)=>{ 
    Object.keys(r).forEach(k=>s.add(k)); 
    return s; 
  }, new Set()));
  const esc = v=>{
    if(v==null) return '';
    const s = String(v);
    if(s.includes('"') || s.includes('\n') || s.includes(sep)) {
      return `"${s.replace(/"/g,'""')}"`;
    }
    return s;
  };
  const lines = [keys.join(sep)];
  for(const r of rows) {
    lines.push(keys.map(k=>esc(r[k])).join(sep));
  }
  return lines.join('\n');
}

function escapeHtml(s){ 
  return (s||'').replace(/[&<>"']/g, c=>({ 
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' 
  })[c]); 
}

function escapeAttribute(s){ 
  return (s||'').replace(/"/g,'&quot;'); 
}

function formatMessage(template, data){
  if(!template) return '';
  return Object.entries(data || {}).reduce((acc, [key, value])=>{
    const safeValue = value == null ? '' : String(value);
    return acc.replace(new RegExp(`\\{${key}\\}`, 'g'), safeValue);
  }, template);
}

function t(key){
  return translations[state.currentLanguage][key] || key;
}

function applyDataTranslations(){
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    if(!key) return;
    const text = t(key);
    if(text !== undefined) el.textContent = text;
  });

  const attrMap = [
    ['data-i18n-placeholder', 'placeholder'],
    ['data-i18n-title', 'title'],
    ['data-i18n-aria-label', 'aria-label']
  ];

  attrMap.forEach(([dataAttr, attr])=>{
    document.querySelectorAll(`[${dataAttr}]`).forEach(el => {
      const key = el.getAttribute(dataAttr);
      if(!key) return;
      const text = t(key);
      if(text !== undefined) el.setAttribute(attr, text);
    });
  });

  const badgeText = document.querySelector('#editModeBadge [data-i18n="editModeActive"]');
  if(badgeText) badgeText.textContent = t('editModeActive');
}

function clearAllFilters(){
  state.columnFilters = {};
  if(el.filterGlobal){
    el.filterGlobal.value = '';
  }
  if(el.filterGlobalClearBtn){
    el.filterGlobalClearBtn.style.display = 'none';
  }
  invalidateFilterCache();
  updateClearButtons();
}

function updateUITexts(){
    function updateElementText(id, text) {
    const element = document.getElementById(id);
    if (element) {
      element.textContent = text;
    } else {
      console.warn(`Elemento con ID '${id}' no encontrado`);
    }
  }

    applyDataTranslations();

    if (el.clearBtn) el.clearBtn.textContent = t('clearJson');
  updateElementText('separatorLabel', t('separator'));
  updateElementText('downloadOption', t('download'));
  if (el.toggleRawBtn) el.toggleRawBtn.textContent = t('showRaw');
  if (el.copyBtn) el.copyBtn.textContent = t('copyTable');
  if (el.filterGlobal) el.filterGlobal.placeholder = t('globalFilter');
  updateElementText('editBtnText', state.editing ? t('save') : t('edit'));

    updateElementText('tabConfigText', t('configuration'));
  updateElementText('tabCustomText', t('customTheme'));
  updateElementText('languageLabel', t('language'));
  updateElementText('historyLabel', t('jsonHistory'));
  updateElementText('selectJsonOption', t('selectJson'));
  updateElementText('loadHistoryText', t('load'));
  updateElementText('renameHistoryText', t('rename'));
  updateElementText('deleteHistoryText', t('delete'));
  if (el.historySearchInput) el.historySearchInput.placeholder = t('historySearchPlaceholder');
  updateElementText('mobileSwitchText', t('webMobile'));

    updateElementText('customThemeTitle', t('customizeTheme'));
  updateElementText('bgColorLabel', t('background'));
  updateElementText('textColorLabel', t('text'));
  updateElementText('fontFamilyLabel', t('typography'));
  updateElementText('cellEvenLabel', t('evenCells'));
  updateElementText('cellOddLabel', t('oddCells'));
  updateElementText('customDefaultText', t('default'));

    renderHistoryDropdown();
}

if(el.historySearchInput){
  el.historySearchInput.placeholder = t('historySearchPlaceholder');
  el.historySearchInput.addEventListener('input', debounce((e)=>{
    state.historyFilter = e.target.value || '';
    renderHistoryDropdown();
  }, 200));
}

function changeLanguage(lang) {
  console.log('Cambiando idioma a:', lang);
  state.currentLanguage = lang;
  localStorage.setItem('language', lang);

    if (el.languageSelect) {
    console.log('Actualizando valor del selector a:', lang);
    el.languageSelect.value = lang;
  } else {
    console.error('el.languageSelect no está definido');
  }

    console.log('Actualizando textos de la interfaz...');
  updateUITexts();

  console.log('Volviendo a renderizar la tabla para actualizar etiquetas accesibles...');
  renderTable();
}

function saveHistory(){ 
  try{ 
    localStorage.setItem('jsonHistory', JSON.stringify(state.history)); 
  }catch(e){ 
    console.warn(e); 
  } 
}

function loadHistory(){
  try{
    const raw = localStorage.getItem('jsonHistory');
    if(!raw){
      state.history = [];
      renderHistoryDropdown();
      return;
    }
    const parsed = JSON.parse(raw);
    if(Array.isArray(parsed)){
      state.history = parsed.slice(-HISTORY_MAX_ENTRIES);
    } else {
      state.history = [];
    }
    renderHistoryDropdown();
  }catch(e){
    console.warn('loadHistory', e);
    state.history = [];
    renderHistoryDropdown();
  }
}

function renderHistoryDropdown(){
  const sel = el.jsonHistorySelect;
  const filter = (state.historyFilter || '').toLowerCase();
  let needsSave = false;

  const decorated = state.history.map((item, idx)=>{
    const size = (typeof item.size === 'number')
      ? item.size
      : new Blob([item.data || '']).size;
    if(typeof item.size !== 'number'){
      item.size = size;
      needsSave = true;
    }
    return { ...item, idx, size };
  }).sort((a, b) => {
    const dateA = a.date ? new Date(a.date).getTime() : 0;
    const dateB = b.date ? new Date(b.date).getTime() : 0;
    return dateB - dateA;
  });

  const filteredAll = decorated.filter(item=>{
    if(!filter) return true;
    return (item.name || '').toLowerCase().includes(filter) ||
           (item.data || '').toLowerCase().includes(filter);
  });
  const toDisplay = filteredAll.slice(0, HISTORY_DISPLAY_LIMIT);

  sel.innerHTML = `<option value="">${t('selectJson')}</option>`;

  toDisplay.forEach((it)=>{
    const opt = document.createElement('option');
    opt.value = it.idx;
    const name = it.name || `JSON ${Number(it.idx)+1}`;
    const dateStr = it.date ? new Date(it.date).toLocaleString() : '';
    const sizeStr = formatBytes(it.size);
    const metaParts = [];
    if(dateStr) metaParts.push(dateStr);
    metaParts.push(sizeStr);
    opt.textContent = metaParts.length ? `${name} (${metaParts.join(' • ')})` : name;
    sel.appendChild(opt);
  });

  if(el.historyMeta){
    if(!filteredAll.length){
      el.historyMeta.textContent = t('historyNoMatches');
    } else {
      const text = t('historyCount')
        .replace('{current}', toDisplay.length)
        .replace('{total}', filteredAll.length)
        .replace('{limit}', HISTORY_DISPLAY_LIMIT);
      el.historyMeta.textContent = text;
    }
  }

  if(needsSave) saveHistory();
}

function formatBytes(bytes){
  if(!Number.isFinite(bytes) || bytes <= 0) return '0 B';
  const units = ['B', 'KB', 'MB', 'GB', 'TB'];
  const idx = Math.min(units.length - 1, Math.floor(Math.log(bytes) / Math.log(1024)));
  const value = bytes / Math.pow(1024, idx);
  const fixed = value >= 10 || idx === 0 ? value.toFixed(0) : value.toFixed(1);
  return `${fixed} ${units[idx]}`;
}

async function sha1(str){
  const enc = new TextEncoder();
  const buf = await crypto.subtle.digest('SHA-1', enc.encode(str));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

async function addToHistory(jsonStr, name){
  if(!jsonStr || !jsonStr.trim()) return;
  if(jsonStr.length > HISTORY_MAX_JSON_SIZE){
    alert(t('historySizeExceeded') || 'El JSON es demasiado grande para guardar en el historial.');
    return;
  }
  const h = await sha1(jsonStr);
  const idx = state.history.findIndex(x => x.hash === h);
  if(idx >= 0){
    state.history[idx].date = new Date().toISOString();
  } else {
    state.history.push({ 
      hash: h, 
      data: jsonStr, 
      name: name || ('JSON ' + (state.history.length+1)), 
      date: new Date().toISOString() 
    });
    if(state.history.length > HISTORY_MAX_ENTRIES) state.history.shift();
  }
  saveHistory();
  renderHistoryDropdown();
}

function updateLastJsonStorage(text){
  if(!setLastJson(text)){
    console.warn('No se pudo guardar lastJson');
  }
}
function updateActionButtons(){
  const hasData = state.currentRows && state.currentRows.length > 0;

    el.downloadSelect.disabled = !hasData;
  el.toggleRawBtn.disabled = !hasData;
  el.copyBtn.disabled = !hasData;
  el.editBtn.disabled = !hasData;
  el.filterGlobal.disabled = !hasData;

    el.clearBtn.disabled = !el.jsonin.value.trim();

    el.deleteHistoryBtn.disabled = el.jsonHistorySelect.value === '';
  el.loadHistoryBtn.disabled = el.jsonHistorySelect.value === '';

    if(hasData){
    el.filterEditRow.classList.remove('hide-without-data');
    el.filterEditRow.classList.add('show-with-data');
  } else {
    el.filterEditRow.classList.add('hide-without-data');
    el.filterEditRow.classList.remove('show-with-data');
  }
}

function showConfigTab(){
  el.tabConfig.classList.add('active');
  el.tabCustom.classList.remove('active');
  el.configContent.classList.add('active');
  el.configContent.style.display = 'block';
  el.customPanel.style.display = 'none';
  el.customPanel.classList.remove('active');
}

function showCustomTab(){
  el.tabCustom.classList.add('active');
  el.tabConfig.classList.remove('active');
  el.configContent.classList.remove('active');
  el.configContent.style.display = 'none';
  el.customPanel.style.display = 'block';
  el.customPanel.classList.add('active');
}

function clearCustomTheme(){
  const body = document.body;
  const html = document.documentElement;
  ['--bg','--fg','--cell-even','--cell-odd','--font-main'].forEach(prop => {
    body.style.removeProperty(prop);
    html.style.removeProperty(prop);
  });
}

function applyCustomTheme(colors){
  const target = document.body.classList.contains('dark') ? document.body : document.documentElement;
  if(colors.bg) target.style.setProperty('--bg', colors.bg);
  if(colors.text) target.style.setProperty('--fg', colors.text);
  if(colors.cellEven) target.style.setProperty('--cell-even', colors.cellEven);
  if(colors.cellOdd) target.style.setProperty('--cell-odd', colors.cellOdd);
  if(colors.font) { target.style.setProperty('--font-main', colors.font); const fontSelect = document.getElementById('fontFamily'); if(fontSelect) fontSelect.value = colors.font; }
}

function loadCustomTheme(){
  try{
    const raw = localStorage.getItem('customTheme');
    const isDark = document.body.classList.contains('dark');
    const defaults = isDark ? {
      bg: '#141414',
      text: '#eee',
      cellEven: '#252525',
      cellOdd: '#202020'
    } : {
      bg: '#ffffff',
      text: '#111111',
      cellEven: '#f9f9f9',
      cellOdd: '#eef3ff'
    };

    if(raw){
      const c = JSON.parse(raw);
      el.bgColor.value = c.bg || defaults.bg;
      el.textColor.value = c.text || defaults.text;
      el.fontFamily.value = c.font || '';
      el.cellEven.value = c.cellEven || defaults.cellEven;
      el.cellOdd.value = c.cellOdd || defaults.cellOdd;
      applyCustomTheme(c);
    } else {
      clearCustomTheme();
      el.bgColor.value = defaults.bg;
      el.textColor.value = defaults.text;
      el.fontFamily.value = '';
      el.cellEven.value = defaults.cellEven;
      el.cellOdd.value = defaults.cellOdd;
    }
  }catch(e){ 
    console.warn(e); 
  }
}

function saveCustomTheme(){
  const c = { 
    bg: el.bgColor.value, 
    text: el.textColor.value, 
    font: el.fontFamily.value, 
    cellEven: el.cellEven.value, 
    cellOdd: el.cellOdd.value
  };
  localStorage.setItem('customTheme', JSON.stringify(c));
  applyCustomTheme(c);
}

function enableMobileMode(flag){
  state.mobileMode = !!flag;
  document.body.classList.toggle('mobile', !!flag);
  localStorage.setItem('mobileMode', state.mobileMode ? 'true' : 'false');
}

function updateFetchButtonState(){
  const url = el.urlIn.value.trim();
  const hasUrl = url.length > 0;
  const isDisabled = el.urlIn.disabled;
  const isValid = !hasUrl || validators.isValidUrl(url);
  
  // Actualizar estado del botón de carga
  el.fetchBtn.disabled = !hasUrl || isDisabled || !isValid;
  
  // Actualizar estilos visuales del campo de URL
  if (hasUrl) {
    el.urlIn.style.borderColor = isValid ? '' : '#ff6b6b';
    el.urlIn.style.boxShadow = isValid ? '' : '0 0 0 2px rgba(255, 107, 107, 0.2)';
  } else {
    el.urlIn.style.borderColor = '';
    el.urlIn.style.boxShadow = '';
  }
  
  // Actualizar estilos visuales del botón
  if (isDisabled) {
    el.fetchBtn.style.opacity = '0.6';
    el.fetchBtn.style.cursor = 'not-allowed';
    el.urlIn.style.opacity = '0.6';
    el.urlIn.style.cursor = 'not-allowed';
  } else {
    el.fetchBtn.style.opacity = hasUrl && isValid ? '1' : '0.6';
    el.fetchBtn.style.cursor = (hasUrl && isValid) ? 'pointer' : 'not-allowed';
    el.urlIn.style.opacity = '1';
    el.urlIn.style.cursor = 'text';
  }
}

async function parseJsonInput(addToHist){
  const txt = el.jsonin.value || '';
  if(!txt.trim()){
    // Limpiar el estado si no hay texto
    state.originalParsed = null;
    state.originalRows = []; 
    state.currentRows = []; 
    state.currentHeaders = [];
    invalidateFilterCache();
    el.tableWrap.innerHTML = '';
    el.jsonin.classList.remove('error'); // Asegurarse de quitar la clase de error
    updateActionButtons();
    return;
  }

  const parsed = tryParseJson(txt);
  if(!parsed){
        el.jsonin.classList.add('error');
    state.originalRows = []; 
    state.currentRows = [];
    invalidateFilterCache();
    el.tableWrap.innerHTML = `<div class="table-message table-message--error" role="alert">${t('invalidJson')}</div>`;
    updateActionButtons();
    return;
  } else {
    el.jsonin.classList.remove('error');
  }

    const rows = getRowsFromJson(parsed);
  state.originalRows = rows;
  state.currentRows = rows.slice();
  state.lastParsedFull = parsed;
  invalidateFilterCache();

  if(addToHist) await addToHistory(txt);
  updateLastJsonStorage(txt);

  if(addToHist){
    clearAllFilters();
  }

  if(el.rawDisplay){
    el.rawDisplay.style.display = 'none';
  }
  if(el.tableWrap){
    el.tableWrap.style.display = '';
  }
  if(el.toggleRawBtn){
    el.toggleRawBtn.textContent = t('showRaw');
  }
  if(el.filterGlobal && el.filterGlobal.parentElement){
    el.filterGlobal.parentElement.style.display = '';
  }
  if(el.filterGlobalClearBtn){
    el.filterGlobalClearBtn.style.display = el.filterGlobal.value ? 'block' : 'none';
  }
  if(el.editBtn){
    el.editBtn.style.display = '';
  }

    state.virtualStart = 0;
  computeVisibleCount();
  renderTable();
  updateActionButtons();
}

function saveLastJson(){ 
  try{ 
    localStorage.setItem('lastJson', el.jsonin.value || ''); 
  }catch(e){
    console.warn(e);
  } 
}

function debounce(fn, ms){
  let t;
  return function(...args){
    clearTimeout(t);
    t = setTimeout(()=> fn.apply(this, args), ms);
  };
}

function computeVisibleCount(){
  const h = el.tableWrap.clientHeight || 420;
  state.visibleCount = Math.ceil(h / state.rowHeight) + 6; }

function announce(key, data){
  if(!el.liveRegion) return;
  const template = t(key) || '';
  const message = formatMessage(template, data);
  if(!message) return;
  if(announceTimer) clearTimeout(announceTimer);
  el.liveRegion.textContent = '';
  announceTimer = setTimeout(()=>{
    el.liveRegion.textContent = message;
  }, 0);
}

function getSortAriaLabel(columnKey){
  const colName = String(columnKey);
  const sortState = state.sortState[columnKey];
  let template;
  if(sortState === 'asc'){
    template = t('sortColumnAsc');
  } else if(sortState === 'desc'){
    template = t('sortColumnDesc');
  } else {
    template = t('sortColumnDefault');
  }
  return formatMessage(template || '', { column: colName });
}

function renderTable(){
  const rows = state.currentRows || [];

  if(!rows.length){
        const keys = state.originalRows.length ? getHeaderKeys(state.originalRows) : [];

    if(!keys.length){
      el.tableWrap.innerHTML = '';
      updateActionButtons();
      return;
    }

        const html = buildTableHtml([], keys, true);
    el.tableWrap.innerHTML = html;
    attachTableEvents();
    updateActionButtons();
    return;
  }

    const filtered = getFilteredRows(rows);
  const keys = getHeaderKeys(filtered.length ? filtered : rows);

  state.currentHeaders = keys;

    const scrollTop = el.tableWrap.scrollTop || 0;
  state.virtualStart = Math.max(0, Math.floor(scrollTop / state.rowHeight) - 3);
  computeVisibleCount();
  const visibleRows = filtered.slice(state.virtualStart, state.virtualStart + state.visibleCount);

    const topSpacerHeight = state.virtualStart * state.rowHeight;
  const bottomSpacerHeight = Math.max(0, (filtered.length - state.virtualStart - visibleRows.length) * state.rowHeight);

    let html = '';
  html += `<table><thead><tr>`;
  keys.forEach(k => {
    const cls = (state.sortState[k] === 'asc') ? 'order-asc' : 
                (state.sortState[k] === 'desc') ? 'order-desc' : '';
    const aria = getSortAriaLabel(k);
    html += `<th class="${cls}" data-col="${encodeURIComponent(k)}" aria-label="${escapeAttribute(aria)}">${escapeHtml(k)}</th>`;
  });
  html += `</tr>`;

    html += '<tr class="filter-row">';
  keys.forEach(k=>{
    const val = state.columnFilters[k] || '';
    html += `<th><span class="filter-col-wrap">
      <input class="filter-col" data-col="${encodeURIComponent(k)}" 
             value="${escapeAttribute(val)}" placeholder="${t('filterColumn')}" />
      <button class="clear-btn filter-col-clear" data-col="${encodeURIComponent(k)}" 
              title="${t('clearFilter')}" aria-label="${t('clearFilter')}" data-i18n-title="clearFilter" data-i18n-aria-label="clearFilter">✕</button>
    </span></th>`;
  });
  html += '</tr></thead><tbody>';

    if(topSpacerHeight > 0){
    html += `<tr style="height:${topSpacerHeight}px">
      <td style="padding:0;border:none" colspan="${keys.length}"></td>
    </tr>`;
  }

  if(visibleRows.length){
        visibleRows.forEach((r, idx)=>{
      html += '<tr>';
      keys.forEach(k=>{
        const v = r[k] == null ? '' : escapeHtml(String(r[k]));

                let cellClasses = '';
        const cellValue = String(r[k] || '').toLowerCase();
        const globalFilter = (el.filterGlobal.value || '').toLowerCase();
        const columnFilter = (state.columnFilters[k] || '').toLowerCase();

                if(globalFilter && cellValue.includes(globalFilter)){
          cellClasses += ' global-match';
        }
        if(columnFilter && cellValue.includes(columnFilter)){
          cellClasses += ' column-match';
        }

        html += `<td data-row="${state.virtualStart + idx}" data-col="${encodeURIComponent(k)}" class="${cellClasses.trim()}">${v}</td>`;
      });
      html += '</tr>';
    });
  } else {
        html += `<tr><td colspan="${keys.length}" style="padding:12px;color:var(--muted)">
      ${t('noResults')}
    </td></tr>`;
  }

    if(bottomSpacerHeight > 0){
    html += `<tr style="height:${bottomSpacerHeight}px">
      <td style="padding:0;border:none" colspan="${keys.length}"></td>
    </tr>`;
  }

  html += `</tbody></table>`;

  el.tableWrap.innerHTML = html;
  attachTableEvents(filtered);
  updateActionButtons();
  updateClearButtons();
}

function setLastJson(text){
  const data = text || '';
  if(data.length > MAX_LAST_JSON_SIZE){
    alert(t('lastJsonSizeExceeded') || 'El JSON es demasiado grande para guardarlo localmente.');
    try{ localStorage.removeItem('lastJson'); }catch(e){ console.warn(e); }
    return false;
  }
  try{
    localStorage.setItem('lastJson', data);
    return true;
  }catch(e){
    console.warn(e);
    return false;
  }
}

function getFilterSignature(){
  const globalVal = (el.filterGlobal.value || '').toLowerCase();
  const columnVals = Object.entries(state.columnFilters || {})
    .map(([k,v])=>`${k}:${(v||'').toLowerCase()}`)
    .sort()
    .join('|');
  return `${globalVal}::${columnVals}`;
}

function getFilteredRows(rows){
  const signature = getFilterSignature();
  if(state.cache.filteredRows && state.cache.filterSignature === signature){
    return state.cache.filteredRows;
  }

  const globalVal = (el.filterGlobal.value || '').toLowerCase();
  const filtered = rows.filter(r=>{
    if(globalVal && !Object.values(r).some(v=>String(v||'').toLowerCase().includes(globalVal))){
      return false;
    }
    for(const [col,val] of Object.entries(state.columnFilters || {})){
      if(val && !(String((r[col]||'')).toLowerCase().includes(val.toLowerCase()))){
        return false;
      }
    }
    return true;
  });

  state.cache.filteredRows = filtered;
  state.cache.filterSignature = signature;
  return filtered;
}

function getHeaderKeys(rows){
  const signature = getFilterSignature();
  if(state.cache.headerKeys && state.cache.filterSignature === signature){
    return state.cache.headerKeys;
  }

  const keys = Array.from(rows.reduce((acc,row)=>{
    Object.keys(row).forEach(k=>acc.add(k));
    return acc;
  }, new Set()));

  state.cache.headerKeys = keys;
  state.cache.filterSignature = signature;
  return keys;
}

function invalidateFilterCache(){
  state.cache.filteredRows = null;
  state.cache.headerKeys = null;
  state.cache.filterSignature = '';
}

function buildTableHtml(rows, keys, showFilters = false){
  let html = `<table><thead><tr>`;

    keys.forEach(k => {
    const cls = (state.sortState[k] === 'asc') ? 'order-asc' : 
                (state.sortState[k] === 'desc') ? 'order-desc' : '';
    const aria = getSortAriaLabel(k);
    html += `<th class="${cls}" data-col="${encodeURIComponent(k)}" aria-label="${escapeAttribute(aria)}">${escapeHtml(k)}</th>`;
  });
  html += `</tr>`;

  if(showFilters){
    html += '<tr class="filter-row">';
    keys.forEach(k=>{
      const val = state.columnFilters[k] || '';
      html += `<th><span class="filter-col-wrap">
        <input class="filter-col" data-col="${encodeURIComponent(k)}" 
               value="${escapeAttribute(val)}" placeholder="${t('filterColumn')}" />
        <button class="clear-btn filter-col-clear" data-col="${encodeURIComponent(k)}" 
                title="${t('clearFilter')}" aria-label="${t('clearFilter')}" data-i18n-title="clearFilter" data-i18n-aria-label="clearFilter">✕</button>
      </span></th>`;
    });
    html += '</tr>';
  }

  html += '</thead><tbody>';
  if(!rows.length){
    html += `<tr><td colspan="${keys.length}" style="padding:12px;color:var(--muted)">
      ${t('noTable')}
    </td></tr>`;
  }
  html += '</tbody></table>';
  return html;
}

function attachTableEvents(filteredRows){
    el.tableWrap.querySelectorAll('th[data-col]').forEach(th=>{
    th.onclick = ()=>{
      const col = decodeURIComponent(th.dataset.col);
      const dir = (state.sortState[col] === 'asc') ? 'desc' : 'asc';
      state.sortState = {}; 
      state.sortState[col] = dir;

      state.currentRows.sort((a,b)=>{
        const va = a[col], vb = b[col];
        if(va==null) return 1; 
        if(vb==null) return -1;
        if(!isNaN(va) && !isNaN(vb)) {
          return dir==='asc' ? va - vb : vb - va;
        }
        return dir==='asc' ? 
          String(va).localeCompare(String(vb)) : 
          String(vb).localeCompare(String(va));
      });

      announce(dir === 'asc' ? 'sortAnnounceAsc' : 'sortAnnounceDesc', { column: col });
      invalidateFilterCache();
      el.tableWrap.scrollTop = 0;
      renderTable();
    };
  });

    const deb = debounce(function(){
        const activeElement = document.activeElement;
    const activeCol = activeElement && activeElement.classList.contains('filter-col') ? 
      decodeURIComponent(activeElement.dataset.col) : null;
    const activeValue = activeElement ? activeElement.value : '';

    renderTable();

        if(activeCol){
      setTimeout(()=>{
        const newInput = el.tableWrap.querySelector(`.filter-col[data-col="${encodeURIComponent(activeCol)}"]`);
        if(newInput){
          newInput.focus();
          newInput.value = activeValue;
                    newInput.setSelectionRange(activeValue.length, activeValue.length);
        }
      }, 0);
    }
  }, state.filterDebounceMs);

  el.tableWrap.querySelectorAll('.filter-col').forEach(inp=>{
        inp.addEventListener('input', (e)=> {
      const col = decodeURIComponent(inp.dataset.col);
      state.columnFilters[col] = inp.value;
      deb();
    });

        inp.addEventListener('keydown', (e)=> { 
      e.stopPropagation();
    });

        inp.addEventListener('focus', (e)=> {
      e.stopPropagation();
    });
  });

    el.tableWrap.querySelectorAll('.filter-col-clear').forEach(btn=>{
    btn.addEventListener('click', function(e) {
      e.stopPropagation();
      const col = decodeURIComponent(btn.dataset.col);
      state.columnFilters[col] = '';
      invalidateFilterCache();

            const input = document.querySelector(`.filter-col[data-col="${encodeURIComponent(col)}"]`);
      if (input) {
        input.value = '';
      }

            btn.style.display = 'none';

            renderTable();

            announce('filterCleared', { column: col });

            setTimeout(()=>{
        const selector = `.filter-col[data-col="${encodeURIComponent(col)}"]`;
        const newInp = el.tableWrap.querySelector(selector);
        if(newInp) {
          newInp.focus();
        }
      }, 0);
    });
  });

    if(state.editing){
    el.tableWrap.querySelectorAll('tbody td').forEach(td=>{
      td.contentEditable = 'true';
      td.classList.add('editable-cell');
      td.addEventListener('input', onCellEdit);
    });
  } else {
    el.tableWrap.querySelectorAll('tbody td').forEach(td=>{
      td.contentEditable = 'false';
      td.classList.remove('editable-cell');
      td.removeEventListener('input', onCellEdit);
    });
  }

    el.tableWrap.onscroll = function(){
    const scrollTop = el.tableWrap.scrollTop || 0;
    const newStart = Math.max(0, Math.floor(scrollTop / state.rowHeight) - 3);
    if(newStart !== state.virtualStart){
      state.virtualStart = newStart;
      renderTable();
    }
  };
}

function onCellEdit(e){
  const td = e.target;
  const virtualRowIdx = Number(td.dataset.row);
  const col = decodeURIComponent(td.dataset.col);
  const newVal = td.innerText;

    const actualIdx = virtualRowIdx;
  if(typeof actualIdx === 'number' && state.currentRows[actualIdx]){
    state.currentRows[actualIdx][col] = newVal;
  }

    if(state.originalParsed && state.originalParsed.type === 'array'){
    const newObj = unflattenObject(state.currentRows[actualIdx]);
    if(state.lastParsedFull && Array.isArray(state.lastParsedFull)){
      state.lastParsedFull[actualIdx] = newObj;
      const jsonStr = JSON.stringify(state.lastParsedFull, null, 2);
      updateLastJsonStorage(jsonStr);
      el.jsonin.value = jsonStr;
    }
  } else if(state.originalParsed && state.originalParsed.type === 'rootKeyArray'){
    const key = state.originalParsed.key;
    if(state.lastParsedFull && state.lastParsedFull[key] && Array.isArray(state.lastParsedFull[key])){
      const newObj = unflattenObject(state.currentRows[actualIdx]);
      state.lastParsedFull[key][actualIdx] = newObj;
      const jsonStr = JSON.stringify(state.lastParsedFull, null, 2);
      localStorage.setItem('lastJson', jsonStr);
      el.jsonin.value = jsonStr;
    }
  } else if(state.originalParsed && state.originalParsed.type === 'object'){
    const newObj = unflattenObject(state.currentRows[actualIdx]);
    state.lastParsedFull = newObj;
    const jsonStr = JSON.stringify(state.lastParsedFull, null, 2);
    updateLastJsonStorage(jsonStr);
    el.jsonin.value = jsonStr;
  }
}

el.clearBtn.addEventListener('click', ()=>{
  // Limpiar el JSON y el estado
  el.jsonin.value = '';
  el.jsonin.classList.remove('error');
  state.originalParsed = null;
  state.originalRows = []; 
  state.currentRows = []; 
  state.currentHeaders = [];
  
  // Limpiar filtros
  if(el.filterGlobal) {
    el.filterGlobal.value = '';
  }
  state.columnFilters = {};
  
  // Limpiar la tabla
  el.tableWrap.innerHTML = '';
  
  // Ocultar el área de raw si está visible
  if(el.rawDisplay && el.rawDisplay.style.display === 'block') {
    el.rawDisplay.style.display = 'none';
    el.tableWrap.style.display = '';
    el.toggleRawBtn.textContent = t('showRaw');
    // Mostrar controles nuevamente
    if(el.filterGlobal && el.filterGlobal.parentElement) {
      el.filterGlobal.parentElement.style.display = '';
    }
    if(el.filterGlobalClearBtn) el.filterGlobalClearBtn.style.display = '';
    if(el.editBtn) el.editBtn.style.display = '';
  }
  
  // Actualizar la interfaz
  updateActionButtons();
  localStorage.removeItem('lastJson');
  el.jsonin.focus();
});

const debFilterGlobal = debounce(()=>{ 
  renderTable(); 
  updateActionButtons(); 
}, state.filterDebounceMs);

el.filterGlobal.addEventListener('input', debFilterGlobal);

el.filterGlobalClearBtn.addEventListener('click', ()=>{
  el.filterGlobal.value = '';
  el.filterGlobal.focus();
  renderTable();
  announce('globalFilterCleared');
});

el.editBtn.addEventListener('click', ()=>{
  state.editing = !state.editing;
  el.editBtn.classList.toggle('active', state.editing);
  document.getElementById('editBtnText').textContent = state.editing ? t('save') : t('edit');
  if(!state.editing) saveLastJson();
  document.body.classList.toggle('edit-mode-active', state.editing);
  const badge = document.getElementById('editModeBadge');
  if(badge){
    if(state.editing){
      badge.setAttribute('aria-hidden', 'false');
    } else {
      badge.setAttribute('aria-hidden', 'true');
    }
  }
  renderTable();
});

el.fetchBtn.addEventListener('click', async ()=>{
  if(!el.urlIn.value.trim()) return;
  
  // Guardar valores actuales para restaurarlos después
  const originalBtnText = el.fetchBtn.textContent;
  const originalBtnDisabled = el.fetchBtn.disabled;
  const originalUrlDisabled = el.urlIn.disabled;
  
  // Función para restaurar el estado original
  const restoreState = () => {
    el.fetchBtn.disabled = originalBtnDisabled;
    el.fetchBtn.style.opacity = originalBtnDisabled ? '0.6' : '1';
    el.fetchBtn.textContent = originalBtnText;
    el.urlIn.disabled = originalUrlDisabled;
    el.urlIn.style.opacity = originalUrlDisabled ? '0.6' : '1';
    updateFetchButtonState();
  };
  
  try {
    // Deshabilitar temporalmente los controles
    el.fetchBtn.disabled = true;
    el.fetchBtn.style.opacity = '0.6';
    el.fetchBtn.textContent = t('loading');
    
    el.urlIn.disabled = true;
    el.urlIn.style.opacity = '0.6';
    
    const rawUrl = el.urlIn.value.trim();
    const targetUrl = normalizeUrl(rawUrl);
    const res = await fetchWithFallback(targetUrl, rawUrl);
    const txt = await res.text();
    const parsed = tryParseJson(txt);
    el.jsonin.value = parsed ? JSON.stringify(parsed, null, 2) : txt;
    state.lastParsedFull = parsed;
    await parseJsonInput(true);
    clearAllFilters();
    updateLastJsonStorage(el.jsonin.value);
    
    // Mantener deshabilitado por 1 segundo
    setTimeout(restoreState, 1000);
  } catch(e) { 
    console.warn(e);
    // Restaurar estado de los controles primero
    restoreState();
    
    // Mostrar mensaje de error en el área de la tabla
    el.tableWrap.innerHTML = `
      <div class="error-message" style="
        padding: 20px; 
        color: #ff6b6b; 
        text-align: center;
        font-size: 1.1em;
        border: 1px solid #ff6b6b;
        border-radius: 6px;
        margin: 10px 0;
        background-color: rgba(255, 107, 107, 0.1);
      ">
        URL Inválida o no se pudo cargar el recurso
      </div>`;
    
    // Resaltar el campo de URL en rojo
    el.urlIn.style.borderColor = '#ff6b6b';
    el.urlIn.style.boxShadow = '0 0 0 2px rgba(255, 107, 107, 0.2)';
    
    // Quitar el resaltado después de 3 segundos
    setTimeout(() => {
      el.urlIn.style.borderColor = '';
      el.urlIn.style.boxShadow = '';
    }, 3000);
    
    restoreState();
  }
});

el.downloadSelect.addEventListener('change', ()=>{
  const val = el.downloadSelect.value;
  if(!val) return;
  const sep = el.separatorSelect.value;

  if(val === 'csv' || val === 'txt'){
    const content = rowsToCsv(state.currentRows, sep);
    const blob = new Blob([content], {type:'text/plain;charset=utf-8'});
    const a = document.createElement('a'); 
    a.href = URL.createObjectURL(blob); 
    a.download = dynamicFilename(val); 
    a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 1500);
  } else if(val === 'xlsx'){
    const ws = XLSX.utils.json_to_sheet(state.currentRows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
    XLSX.writeFile(wb, dynamicFilename(val));
  }
  el.downloadSelect.value = '';
});

el.toggleRawBtn.addEventListener('click', ()=>{
  if(!state.currentRows || !state.currentRows.length) return;

  if(el.rawDisplay.style.display === 'block'){ 
    // Mostrar tabla y controles
    el.rawDisplay.style.display = 'none'; 
    el.tableWrap.style.display = '';
    el.toggleRawBtn.textContent = t('showRaw');
    // Mostrar controles
    el.filterGlobal.parentElement.style.display = '';
    el.filterGlobalClearBtn.style.display = '';
    el.editBtn.style.display = '';
  } else {
    // Mostrar raw y ocultar controles
    el.rawDisplay.value = rowsToCsv(state.currentRows, el.separatorSelect.value);
    el.rawDisplay.style.display = 'block'; 
    el.tableWrap.style.display = 'none';
    el.toggleRawBtn.textContent = t('hideRaw');
    // Ocultar controles
    el.filterGlobal.parentElement.style.display = 'none';
    el.filterGlobalClearBtn.style.display = 'none';
    el.editBtn.style.display = 'none';
    // Seleccionar texto automáticamente
    setTimeout(()=>{ el.rawDisplay.select(); }, 20);
  }
});

el.separatorSelect.addEventListener('change', ()=>{
  if(el.rawDisplay.style.display === 'block' && state.currentRows && state.currentRows.length){
    el.rawDisplay.value = rowsToCsv(state.currentRows, el.separatorSelect.value);
    setTimeout(()=>{ el.rawDisplay.select(); }, 20);
  }
});

el.configBtn.addEventListener('click', ()=> {
  el.drawer.classList.toggle('open');
  showConfigTab();
});

el.drawerCloseBtn.addEventListener('click', ()=> {
  el.drawer.classList.remove('open');
  showConfigTab();
});

el.tabConfig.addEventListener('click', showConfigTab);
el.tabCustom.addEventListener('click', showCustomTab);

el.themeLight.addEventListener('click', ()=> {
  localStorage.setItem('theme','light');
  document.body.classList.remove('dark');
    loadCustomTheme();
});

el.themeDark.addEventListener('click', ()=> {
  localStorage.setItem('theme','dark');
  document.body.classList.add('dark');
    loadCustomTheme();
});

el.jsonHistorySelect.addEventListener('change', ()=>{
  const hasSelection = el.jsonHistorySelect.value !== '';
  el.deleteHistoryBtn.disabled = !hasSelection;
  el.loadHistoryBtn.disabled = !hasSelection;
});

el.loadHistoryBtn.addEventListener('click', ()=>{
  const idx = el.jsonHistorySelect.value;
  if(idx === '') return;
  const item = state.history[idx];
  if(!item) return;
  if(!confirm(t('loadJsonFromHistory'))) return;

  el.jsonin.value = item.data;
  state.lastParsedFull = tryParseJson(item.data);
  clearAllFilters();
  parseJsonInput(false);
});

el.renameHistoryBtn.addEventListener('click', ()=>{
  const idx = el.jsonHistorySelect.value;
  if(idx === '') return alert(t('selectJsonFromHistory'));
  const newName = prompt(t('newName'), state.history[idx].name || '');
  if(newName){ 
    state.history[idx].name = newName; 
    saveHistory(); 
    renderHistoryDropdown(); 
    el.jsonHistorySelect.value = idx; 
  }
});

el.deleteHistoryBtn.addEventListener('click', ()=>{
  const idx = el.jsonHistorySelect.value;
  if(idx === '') return alert(t('selectItemToDelete'));
  if(confirm(t('deleteFromHistory'))){
    state.history.splice(idx, 1);
    saveHistory(); 
    renderHistoryDropdown();
    el.jsonHistorySelect.value = '';
    el.deleteHistoryBtn.disabled = true;
    el.loadHistoryBtn.disabled = true;
  }
});

el.mobileSwitchBtn.addEventListener('click', ()=>{
  enableMobileMode(!state.mobileMode);
});

['bgColor','textColor','fontFamily','cellEven','cellOdd'].forEach(id=>{
  const node = el[id] || document.getElementById(id);
  if(node){
    node.addEventListener('input', ()=>{
      saveCustomTheme();
    });
  }
});

el.customDefaultBtn.addEventListener('click', ()=>{
  if(!confirm(t('resetThemeConfirm'))) return;
  localStorage.removeItem('customTheme');
  const isDark = document.body.classList.contains('dark');
  if(isDark){
        el.bgColor.value = '#141414';
    el.textColor.value = '#eee';
    el.cellEven.value = '#252525';
    el.cellOdd.value = '#202020';
    applyCustomTheme({
      bg:'#141414',
      text:'#eee',
      cellEven:'#252525',
      cellOdd:'#202020'
    });
  } else {
        el.bgColor.value = '#ffffff';
    el.textColor.value = '#111111';
    el.cellEven.value = '#f9f9f9';
    el.cellOdd.value = '#eef3ff';
    applyCustomTheme({
      bg:'#ffffff',
      text:'#111111',
      cellEven:'#f9f9f9',
      cellOdd:'#eef3ff'
    });
  }
  el.fontFamily.value = "'Inter', Arial, sans-serif";
});

document.addEventListener('mousedown', (e)=>{
  if(el.drawer.classList.contains('open')){
    if(!el.drawer.contains(e.target) && !el.configBtn.contains(e.target) && !el.drawerCloseBtn.contains(e.target)){
      el.drawer.classList.remove('open');
      showConfigTab();
    }
  }
});

el.urlIn.addEventListener('input', updateFetchButtonState);

el.urlClearBtn.addEventListener('click', ()=>{
  el.urlIn.value = '';
  // Restaurar estilos del campo de URL
  resetUrlVisualState();
  updateFetchButtonState();
  updateClearButtons();
  el.urlIn.focus();
});

el.jsonin.addEventListener('input', async ()=>{
  updateActionButtons();
  
  if (window.jsonInputDebounce) {
    clearTimeout(window.jsonInputDebounce);
  }

  window.jsonInputDebounce = setTimeout(async () => {
    try {
      await parseJsonInput(false);
    } catch (e) {
      console.error('Error al procesar JSON:', e);
    }
  }, 500);
});

function updateClearButtons() {
    const urlInput = document.getElementById('urlIn');
  const urlClearBtn = document.getElementById('urlClearBtn');
  if (urlInput && urlClearBtn) {
    urlClearBtn.style.display = urlInput.value ? 'block' : 'none';
  }

    const filterGlobal = document.getElementById('filterGlobal');
  const filterClearBtn = document.getElementById('filterGlobalClearBtn');
  if (filterGlobal && filterClearBtn) {
    filterClearBtn.style.display = filterGlobal.value ? 'block' : 'none';
  }

    document.querySelectorAll('.filter-col').forEach(input => {
    const clearBtn = input.nextElementSibling;
    if (clearBtn && clearBtn.classList.contains('clear-btn')) {
      clearBtn.style.display = input.value ? 'block' : 'none';
    }
  });
}

const urlInput = document.getElementById('urlIn');
const filterGlobal = document.getElementById('filterGlobal');

if (urlInput) {
  urlInput.addEventListener('input', updateClearButtons);
  urlInput.addEventListener('focus', updateClearButtons);
  urlInput.addEventListener('blur', updateClearButtons);
}

if (filterGlobal) {
  filterGlobal.addEventListener('input', updateClearButtons);
  filterGlobal.addEventListener('focus', updateClearButtons);
  filterGlobal.addEventListener('blur', updateClearButtons);
}

document.addEventListener('DOMContentLoaded', updateClearButtons);

window.addEventListener('resize', ()=>{
  computeVisibleCount();
  renderTable();
});

(async function init(){
  try{
        const savedLang = localStorage.getItem('language') || 'en';
    state.currentLanguage = savedLang;
    el.languageSelect.value = savedLang;

        const savedTheme = localStorage.getItem('theme');
    if(savedTheme === 'dark') {
      document.body.classList.add('dark');
    } else {
      document.body.classList.remove('dark');
    }

        loadCustomTheme();

        loadHistory();

        const last = localStorage.getItem('lastJson');
    if(last && last.trim()){ 
      el.jsonin.value = last; 
      state.lastParsedFull = tryParseJson(last); 
      await parseJsonInput(false); 
    } else { 
      updateActionButtons(); 
    }

        updateFetchButtonState();

        const mobile = localStorage.getItem('mobileMode') === 'true';
    enableMobileMode(mobile);

        updateUITexts();

        console.log('Configurando evento change para el selector de idioma');
    el.languageSelect.addEventListener('change', function(e) {
      console.log('Idioma cambiado a:', this.value);
      changeLanguage(this.value);
    });

        console.log('Idioma actual:', state.currentLanguage, 'Valor del selector:', el.languageSelect.value);

        function updateClearButtons() {
            const urlInput = document.getElementById('urlIn');
      const urlClearBtn = document.getElementById('urlClearBtn');
      if (urlInput && urlClearBtn) {
        urlClearBtn.style.display = urlInput.value ? 'block' : 'none';
      }

            const filterGlobal = document.getElementById('filterGlobal');
      const filterClearBtn = document.getElementById('filterGlobalClearBtn');
      if (filterGlobal && filterClearBtn) {
        filterClearBtn.style.display = filterGlobal.value ? 'block' : 'none';
      }

            document.querySelectorAll('.filter-col').forEach(input => {
        const wrap = input.closest('.filter-col-wrap');
        if (!wrap) return;

        const clearBtn = wrap.querySelector('.clear-btn');
        if (clearBtn) {
                    clearBtn.style.display = input.value ? 'block' : 'none';

                    if (!input.value) {
            clearBtn.style.display = 'none';
          }
        }
      });
    }

        updateClearButtons();

        const inputs = document.querySelectorAll('input[type="text"], textarea');
    inputs.forEach(input => {
      input.addEventListener('input', updateClearButtons);
      input.addEventListener('focus', updateClearButtons);
      input.addEventListener('blur', updateClearButtons);
    });

        document.addEventListener('click', function(e) {
      if (el.drawer && !el.drawer.contains(e.target) && e.target !== el.configBtn) {
        el.drawer.classList.remove('open');
      }
    });

        updateClearButtons();
  } catch(e) {
    console.error('Error en la inicialización:', e);
  }
})();     function initClearButtons() {
        const urlInput = document.getElementById('urlIn');
    if (urlInput) {
      urlInput.addEventListener('input', updateClearButtons);
      urlInput.addEventListener('focus', updateClearButtons);
      urlInput.addEventListener('blur', updateClearButtons);
    }

        const filterGlobal = document.getElementById('filterGlobal');
    if (filterGlobal) {
      filterGlobal.addEventListener('input', updateClearButtons);
      filterGlobal.addEventListener('focus', updateClearButtons);
      filterGlobal.addEventListener('blur', updateClearButtons);
    }

        document.addEventListener('input', function(e) {
      if (e.target.classList.contains('filter-col')) {
                const col = decodeURIComponent(e.target.dataset.col);
        state.columnFilters[col] = e.target.value;
                updateClearButtons();
      }
    });

        document.addEventListener('click', function(e) {
      if (e.target.classList.contains('filter-col-clear')) {
        const col = decodeURIComponent(e.target.dataset.col);
        state.columnFilters[col] = '';
                const input = document.querySelector(`.filter-col[data-col="${encodeURIComponent(col)}"]`);
        if (input) {
          input.value = '';
          input.focus();
        }
        updateClearButtons();
      }
    });

        updateClearButtons();
  }

    if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initClearButtons);
  } else {
    initClearButtons();
  }
</script>

<script src="https:</body>
</html>
