<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>JSON → Tabla Mejorada</title>

<!-- ===================== BLOQUE 1: CSS ===================== -->
<style>
:root {
  --bg-color: #fff;
  --text-color: #000;
  --cell-even: #f9f9f9;
  --cell-odd: #fff;
  --header-bg: #e0e0e0;
  --filter-bg: #f0f0f0;
  --highlight-color: #ffff99;
}
body {
  font-family: system-ui,Segoe UI,Roboto,Arial,sans-serif;
  background: var(--bg-color);
  color: var(--text-color);
  margin:0; padding:0;
}
#container {padding:15px; max-width:1200px; margin:auto;}
h1{margin-bottom:10px;font-size:1.5em;}
textarea,input,select,button{margin:2px 0; padding:5px; font-size:0.9em; font-family:inherit;}
table {border-collapse: collapse; width:100%; margin-top:10px;}
th,td {border:1px solid #ccc; padding:5px; text-align:left;}
th {background: var(--header-bg); cursor:pointer;}
tr:nth-child(even){background: var(--cell-even);}
tr:nth-child(odd){background: var(--cell-odd);}
.blink{animation:blink-bg 0.3s ease 0s 1;}
@keyframes blink-bg{from{background:var(--highlight-color);}to{background:inherit;}}
.columnFilter{width:100%;}
.clearBtn{cursor:pointer;color:red;font-weight:bold;}
#rawDisplay{white-space:pre; background:#eee; padding:10px; display:none; margin-top:10px; overflow:auto; max-height:300px;}
#copyMsg{position:absolute; top:10px; right:10px; background:#0f0; color:#000; padding:5px 10px; display:none; border-radius:4px;}
</style>

<!-- ===================== BLOQUE 2: HTML ESTRUCTURA ===================== -->
</head>
<body>
<div id="container">
  <h1>JSON → Tabla Mejorada</h1>
  
  <!-- Configuración -->
  <div id="config">
    <label>Separador: <select id="separatorSelect"><option value=",">,</option><option value=";">;</option><option value="\\t">TAB</option></select></label>
    <label>Descargar: <select id="downloadSelect"><option value="">Formato...</option><option value="csv">CSV</option><option value="txt">TXT</option><option value="xlsx">XLSX</option></select></label>
    <button id="copyBtn">Copiar al portapapeles</button>
    <button id="clearBtn">Limpiar</button>
    <button id="toggleRawBtn">Mostrar Raw JSON</button>
    <button id="toggleEditBtn">Toggle Edición</button>
    <input type="text" id="globalFilter" placeholder="🔍 Filtro global">
    <button id="globalClearBtn">✕</button>
    <span id="copyMsg">Copiado!</span>
  </div>

  <!-- JSON input -->
  <textarea id="jsonin" rows="10" style="width:100%;" placeholder='Pega aquí tu JSON'></textarea>

  <!-- URL fetch -->
  <div>
    <input type="text" id="urlIn" placeholder="URL JSON">
    <button id="fetchBtn">Cargar JSON</button>
  </div>

  <!-- Tabla -->
  <div id="tableWrap"></div>

  <!-- Raw JSON -->
  <pre id="rawDisplay"></pre>
</div>

<!-- ===================== BLOQUE 3: Librerías ===================== -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- ===================== BLOQUE 4: Funciones JS ===================== -->
<script>
const jsonin = document.getElementById('jsonin');
const tableWrap = document.getElementById('tableWrap');
const downloadSelect = document.getElementById('downloadSelect');
const copyBtn = document.getElementById('copyBtn');
const clearBtn = document.getElementById('clearBtn');
const urlIn = document.getElementById('urlIn');
const fetchBtn = document.getElementById('fetchBtn');
const separatorSelect = document.getElementById('separatorSelect');
const globalFilter = document.getElementById('globalFilter');
const globalClearBtn = document.getElementById('globalClearBtn');
const toggleRawBtn = document.getElementById('toggleRawBtn');
const rawDisplay = document.getElementById('rawDisplay');
const copyMsg = document.getElementById('copyMsg');
const toggleEditBtn = document.getElementById('toggleEditBtn');

let currentRows = [], currentHeaders = [], sortState = {}, showRaw = false, editing = false;
let lastJson = null;

function isObj(x){ return x && typeof x==='object' && !Array.isArray(x); }
function flattenObject(obj, prefix='', out={}){
  if(Array.isArray(obj)){ out[prefix.slice(0,-1)||'array'] = JSON.stringify(obj); return out; }
  for(const k of Object.keys(obj||{})){
    const v = obj[k], key = prefix + k + '.';
    if(isObj(v)) flattenObject(v,key,out);
    else if(Array.isArray(v)) out[key.slice(0,-1)] = JSON.stringify(v);
    else out[key.slice(0,-1)] = v;
  }
  return out;
}
function getRowsFromJson(parsed){
  if(Array.isArray(parsed)) return parsed.map(o => flattenObject(o));
  for(const k of Object.keys(parsed)){
    if(Array.isArray(parsed[k])) return parsed[k].map(o=>flattenObject(o));
  }
  return [flattenObject(parsed)];
}
function escapeForRegex(s){ return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); }
function rowsToCsv(rows, sep){
  if(!rows || !rows.length) return '';
  const allKeys = new Set();
  rows.forEach(r=>Object.keys(r).forEach(k=>allKeys.add(k)));
  const headers = Array.from(allKeys);
  const actualSep = sep==='\\t'?'\t':sep;
  const esc = v=>{
    if(v==null) return '';
    const s=String(v);
    if(new RegExp('["\\n'+escapeForRegex(actualSep)+']').test(s) || s.includes('\r')) return '"'+s.replace(/"/g,'""')+'"';
    return s;
  };
  const lines = [headers.join(actualSep)];
  for(const r of rows) lines.push(headers.map(h=>esc(r[h])).join(actualSep));
  return lines.join('\n');
}
function updateDownloadCopyButtons(enabled){
  copyBtn.disabled = !enabled;
  downloadSelect.disabled = !enabled;
}
function parseJsonInput(){
  let parsed;
  try { parsed = JSON.parse(jsonin.value); }
  catch(e){ updateDownloadCopyButtons(false); toggleRawBtn.disabled=true; tableWrap.innerHTML=''; return; }
  lastJson = parsed;
  currentRows = getRowsFromJson(parsed);
  const allKeys = new Set();
  currentRows.forEach(r=>Object.keys(r).forEach(k=>allKeys.add(k)));
  currentHeaders = Array.from(allKeys);
  renderTable();
  const hasRows = currentRows.length>0;
  updateDownloadCopyButtons(hasRows);
  toggleRawBtn.disabled = !hasRows;
  if(hasRows) localStorage.setItem('lastJson', jsonin.value);
}
(function loadLastJson(){
  const savedJson = localStorage.getItem('lastJson');
  if(savedJson){ jsonin.value=savedJson; parseJsonInput(); }
})();
function renderFilteredTbody(rows, highlightCol=null){
  const tbody = tableWrap.querySelector('tbody');
  if(!tbody) return;
  tbody.innerHTML='';
  const headers = currentHeaders || [];
  rows.forEach(r=>{
    const tr=document.createElement('tr');
    headers.forEach(h=>{
      const td=document.createElement('td');
      td.textContent = r[h]!==undefined?r[h]:'';
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
  if(highlightCol){
    const idx = headers.indexOf(highlightCol);
    if(idx>=0){
      tbody.querySelectorAll('tr').forEach(tr=>{
        const td = tr.children[idx];
        if(td){ td.classList.add('blink'); setTimeout(()=>td.classList.remove('blink'),150); }
      });
    }
  }
}
function renderTable(){
  tableWrap.innerHTML='';
  if(!currentRows.length){ updateDownloadCopyButtons(false); return; }
  const tbl=document.createElement('table');
  const thead=document.createElement('thead');
  const trh=document.createElement('tr');
  currentHeaders.forEach(h=>{
    const th=document.createElement('th');
    th.textContent=h; th.style.position='relative'; th.style.minWidth='80px';
    th.addEventListener('click', ()=>sortColumn(h));
    trh.appendChild(th);
  });
  thead.appendChild(trh);
  const trFilters=document.createElement('tr');
  currentHeaders.forEach(h=>{
    const th=document.createElement('th'); th.style.padding='2px'; th.style.position='relative'; th.style.minWidth='80px';
    const inputContainer=document.createElement('div');
    inputContainer.style.display='flex'; inputContainer.style.alignItems='center'; inputContainer.style.justifyContent='space-between';
    const input=document.createElement('input'); input.type='text'; input.placeholder='🔍'; input.className='columnFilter';
    input.style.flex='1'; input.style.fontSize='11px'; input.style.padding='2px 4px'; input.style.boxSizing='border-box'; input.style.cursor='text';
    const clearX=document.createElement('span'); clearX.textContent='✕'; clearX.className='clearBtn'; clearX.style.display='none';
    clearX.style.cursor='pointer'; clearX.style.marginLeft='4px'; clearX.style.flex='0 0 auto';
    input.addEventListener('input',()=>{
      const val=input.value.toLowerCase();
      const filtered=currentRows.filter(r=>r[h]!==undefined && String(r[h]).toLowerCase().includes(val));
      renderFilteredTbody(filtered,h);
      clearX.style.display = val?'inline':'none';
    });
    clearX.addEventListener('click', ()=>{
      input.value=''; input.focus(); clearX.style.display='none'; renderFilteredTbody(currentRows);
    });
    inputContainer.appendChild(input); inputContainer.appendChild(clearX); th.appendChild(inputContainer); trFilters.appendChild(th);
  });
  thead.appendChild(trFilters);
  tbl.appendChild(thead);
  tbl.appendChild(document.createElement('tbody'));
  tableWrap.appendChild(tbl);
  renderFilteredTbody(currentRows);
  const hasRows = currentRows.length>0;
  updateDownloadCopyButtons(hasRows);
  toggleRawBtn.disabled = !hasRows;
}
function sortColumn(header){
  const dir = sortState[header]==='asc'?'desc':'asc';
  sortState[header] = dir;
  currentRows.sort((a,b)=>{
    const va=a[header], vb=b[header];
    if(va==null) return 1; if(vb==null) return -1;
    if(!isNaN(va) && !isNaN(vb)) return dir==='asc'?va-vb:vb-va;
    return dir==='asc'?String(va).localeCompare(String(vb)):String(vb).localeCompare(String(va));
  });
  renderFilteredTbody(currentRows, header);
}
document.addEventListener('DOMContentLoaded', ()=>{
  jsonin.addEventListener('input', ()=>parseJsonInput());
  fetchBtn.addEventListener('click', async ()=>{
    const url = urlIn.value.trim();
    if(!url) return;
    try{
      const resp = await fetch(url);
      const text = await resp.text();
      try{ jsonin.value = JSON.stringify(JSON.parse(text), null, 2); } catch(e){ jsonin.value = text; }
      parseJsonInput();
    } catch(e){ console.warn('Fetch falló', e); }
  });
  clearBtn.addEventListener('click', ()=>{
    jsonin.value=''; currentRows=[]; currentHeaders=[]; renderTable();
    updateDownloadCopyButtons(false); toggleRawBtn.disabled=true; copyBtn.disabled=true; rawDisplay.style.display='none';
  });
  copyBtn.addEventListener('click', async ()=>{
    if(!currentRows.length) return;
    const sep = separatorSelect.value==='\\t'?'\t':separatorSelect.value;
    const csvText = rowsToCsv(currentRows, sep);
    try{
      if(navigator.clipboard && navigator.clipboard.writeText) await navigator.clipboard.writeText(csvText);
      else{ const tbl = document.querySelector('#tableWrap table'); if(!tbl) throw new Error('No table');
        const sel = window.getSelection(); const range=document.createRange(); range.selectNode(tbl); sel.removeAllRanges(); sel.addRange(range);
        document.execCommand('copy'); sel.removeAllRanges();
      }
      copyMsg.style.display='block'; setTimeout(()=>{copyMsg.style.display='none';},1200);
    } catch(e){ console.error('No se pudo copiar', e); }
  });
  downloadSelect.addEventListener('change', ()=>{
    if(!currentRows.length) return;
    const val = downloadSelect.value; if(!val) return;
    const sep = separatorSelect.value==='\\t'?'\t':separatorSelect.value;
    if(val==='csv' || val==='txt'){
      const csv = rowsToCsv(currentRows, sep);
      const blobType = val==='csv'?'text/csv;charset=utf-8':'text/plain;charset=utf-8';
      const blob = new Blob([csv], {type:blobType});
      const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='data.'+val;
      document.body.appendChild(a); a.click(); a.remove();
    } else if(val==='xlsx'){
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.json_to_sheet(currentRows);
      XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
      XLSX.writeFile(wb, 'data.xlsx');
    }
    downloadSelect.value='';
  });
  toggleEditBtn.addEventListener('click', ()=>{
    editing = !editing;
    toggleEditBtn.style.backgroundColor = editing ? '#d9edf7' : '';
    tableWrap.querySelectorAll('tbody td').forEach(td=>{
      if(editing){ td.contentEditable='true'; td.style.border='1px dashed #00f'; td.style.borderRadius='4px'; td.style.padding='3px'; }
      else{ td.contentEditable='false'; td.style.border=''; td.style.borderRadius=''; td.style.padding=''; }
    });
  });
  toggleRawBtn.addEventListener('click', ()=>{
    showRaw = !showRaw; rawDisplay.style.display = showRaw?'block':'none';
    if(showRaw) rawDisplay.textContent = JSON.stringify(lastJson, null, 2);
  });
  globalFilter.addEventListener('input', ()=>{
    const val = globalFilter.value.toLowerCase();
    const filtered = currentRows.filter(r=>Object.values(r).some(v=>v!==undefined && String(v).toLowerCase().includes(val)));
    renderFilteredTbody(filtered);
  });
  globalClearBtn.addEventListener('click', ()=>{ globalFilter.value=''; renderFilteredTbody(currentRows); });
});
</script>
</body>
</html>
