<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>JSON ‚Üí Tabla Mejorada</title>

<!-- ===================== BLOQUE 1: CSS ===================== -->
<style>
:root {
  --bg-color: #fff;
  --text-color: #000;
  --cell-even: #f9f9f9;
  --cell-odd: #e8f0ff;
  --header-bg: #f2f2f2;
  --header-color: #111;
}
body.dark {
  --bg-color: #1e1e1e;
  --text-color: #eee;
  --cell-even: #2a2a2a;
  --cell-odd: #262626;
  --header-bg: #333;
  --header-color: #eee;
}
* { box-sizing: border-box; }
body {
  font-family: system-ui, Segoe UI, Roboto, Arial, sans-serif;
  margin: 0; color: var(--text-color); background: var(--bg-color);
  height: 100vh; display: flex; flex-direction: column;
  transition: background 0.3s, color 0.3s;
}
textarea#jsonin { width: 100%; height: 160px; font-family: monospace; padding: 10px; font-size: 12px; background: #fff; color: #000; transition: background 0.3s, color 0.3s; }
body.dark textarea#jsonin { background: #2a2a2a; color: #eee; }
.row { display: flex; gap: 10px; margin: 5px 10px; flex-wrap: wrap; align-items: center; }
button, input, select { padding: 4px 8px; border-radius: 4px; border: 1px solid #bbb; background: #fafafa; cursor: pointer; font-size: 12px; transition: background 0.3s, color 0.3s, border 0.3s; }
body.dark button, body.dark input, body.dark select { background: #2a2a2a; color: #eee; border: 1px solid #666; }
body.dark select option { background: #2a2a2a; color: #eee; }
input[type=text], select { width: auto; }
#tableWrap { flex: 1; overflow: auto; margin: 5px 10px 10px 10px; position: relative; }
table { border-collapse: collapse; font-family: monospace; font-size: 12px; table-layout: auto; width: 100%; transition: color 0.3s, background 0.3s; }
th, td {
  border: 1px solid #ccc; padding: 6px 8px; text-align: left; white-space: nowrap; position: relative; user-select: none;
  transition: background 0.2s, color 0.2s; color: var(--text-color);
}
th { position: sticky; top: 0; background: var(--header-bg); color: var(--header-color); z-index: 2; cursor: pointer; }
th.activeHeader { background: #d9edf7; }
tr:nth-child(even) td { background: var(--cell-even); }
tr:nth-child(odd) td { background: var(--cell-odd); }
tr:hover td { background: #fff2cc; }
.columnFilterContainer { position: relative; display: flex; align-items: center; }
.columnFilter { width: 70px; font-size: 11px; padding: 2px 18px 2px 4px; margin: 2px 4px 0 0; }
.clearBtn { position: absolute; right: 2px; top: 50%; transform: translateY(-50%); color: red; cursor: pointer; display: none; font-size: 12px; user-select: none; }
.globalFilterContainer { position: relative; margin: 5px 10px; gap: 4px; display: inline-flex; align-items: center; }
.globalFilter { cursor: text; width: 200px; padding: 4px 8px; font-size: 12px; border-radius: 4px; }
.globalClearBtn { cursor: pointer; font-size: 12px; color: red; user-select: none; display: inline-block; margin-left: 4px; }
#rawDisplay {
  display: none; height: auto; min-height: 160px; margin: 5px; padding: 10px; font-family: monospace;
  font-size: 12px; overflow: auto; border: 1px solid #bbb; white-space: pre; background: #fff; color: #000; width: auto; max-width: 100%;
  transition: background 0.3s, color 0.3s;
}
body.dark #rawDisplay { background: #2a2a2a; color: #eee; border: 1px solid #666; }
.blink { background: #fffa8c !important; }
#copyMsg { position: fixed; background: #d9edf7; padding: 6px 10px; border-radius: 6px; color: #000; display: none; z-index: 9999; font-size: 12px; transition: top 0.2s, left 0.2s, opacity 0.2s; }
body.dark #copyMsg { background: #444; color: #fff; }
#configPanel {
  display: none; position: absolute; top: 40px; right: 10px; background: #fafafa; border: 1px solid #bbb;
  padding: 10px; border-radius: 6px; z-index: 999; width: 200px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  transition: background 0.3s, color 0.3s;
}
body.dark #configPanel { background: #2a2a2a; border: 1px solid #666; color: #eee; }
#configPanel label { font-size: 12px; margin-right: 5px; }
#configPanel button { font-size: 12px; padding: 2px 6px; }
#configPanel input[type=checkbox] { transform: scale(1.1); margin-left: 5px; }
#toggleEditBtn { font-size: 12px; padding: 4px 6px; cursor: pointer; display: inline-block; margin-left: 4px; }
</style>

<!-- ===================== BLOQUE 2: HTML ===================== -->
<div class="row">
  <input type="text" id="urlIn" placeholder="Pega URL aqu√≠..." style="flex:1;" />
  <button id="fetchBtn">üì° Cargar URL</button>
  <button id="configBtn">‚öôÔ∏è Config</button>
</div>

<div class="row">
  <textarea id="jsonin" placeholder='Pega JSON aqu√≠'></textarea>
</div>

<div id="configPanel"></div>

<div class="row">
  <button id="clearBtn">Limpiar JSON</button>
</div>

<div class="row">
  <label>Separador:</label>
  <select id="separatorSelect">
    <option value="	">Tab</option>
    <option value=";">;</option>
    <option value=",">,</option>
  </select>

  <select id="downloadSelect">
    <option value="">Descargar...</option>
    <option value="csv">CSV</option>
    <option value="xlsx">XLSX</option>
    <option value="txt">TXT</option>
  </select>

  <button id="toggleRawBtn">Mostrar Raw</button>
  <button id="copyBtn">Copiar tabla</button>
</div>

<div class="globalFilterContainer">
  <input id="globalFilter" class="globalFilter" placeholder="Buscar en toda la tabla..." />
  <span id="globalClearBtn" class="globalClearBtn">‚úï</span>
  <button id="toggleEditBtn">‚úèÔ∏è Editar</button>
  <select id="jsonHistorySelect">
    <option value="">-- Seleccionar JSON --</option>
  </select>
</div>

<textarea id="rawDisplay" readonly></textarea>
<div id="copyMsg">Copiado al portapapeles</div>
<div id="tableWrap"></div>

<!-- ===================== BLOQUE 3: JS ===================== -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', ()=>{
  const jsonin=document.getElementById('jsonin');
  const tableWrap=document.getElementById('tableWrap');
  const downloadSelect=document.getElementById('downloadSelect');
  const copyBtn=document.getElementById('copyBtn');
  const clearBtn=document.getElementById('clearBtn');
  const urlIn=document.getElementById('urlIn');
  const fetchBtn=document.getElementById('fetchBtn');
  const separatorSelect=document.getElementById('separatorSelect');
  const globalFilter=document.getElementById('globalFilter');
  const globalClearBtn=document.getElementById('globalClearBtn');
  const toggleRawBtn=document.getElementById('toggleRawBtn');
  const rawDisplay=document.getElementById('rawDisplay');
  const toggleEditBtn=document.getElementById('toggleEditBtn');
  const jsonHistorySelect=document.getElementById('jsonHistorySelect');
  const configBtn=document.getElementById('configBtn');
  const configPanel=document.getElementById('configPanel');

  window.currentRows=[];
  let currentHeaders=[], sortState={}, showRaw=false, editing=false;
  let lastJson=null;
  let jsonHistory = JSON.parse(localStorage.getItem('jsonHistory')||'[]');

  function isObj(x){ return x && typeof x==='object' && !Array.isArray(x); }
  function flattenObject(obj,prefix='',out={}) {
    if(Array.isArray(obj)){ out[prefix.slice(0,-1)||'array']=JSON.stringify(obj); return out; }
    for(const k of Object.keys(obj||{})){
      const v=obj[k], key=prefix+k+'.';
      if(isObj(v)) flattenObject(v,key,out);
      else if(Array.isArray(v)) out[key.slice(0,-1)] = JSON.stringify(v);
      else out[key.slice(0,-1)] = v;
    }
    return out;
  }
  function getRowsFromJson(parsed){
    if(Array.isArray(parsed)) return parsed.map(o => flattenObject(o));
    for(const k of Object.keys(parsed)){ if(Array.isArray(parsed[k])) return parsed[k].map(o=>flattenObject(o)); }
    return [flattenObject(parsed)];
  }
  function escRegex(s){ return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
  function rowsToCsv(rows, sep){
    if(!rows || !rows.length) return '';
    const allKeys = new Set();
    rows.forEach(r=>Object.keys(r).forEach(k=>allKeys.add(k)));
    const headers = Array.from(allKeys);
    const actualSep = sep==='\\t'?'\t':sep;
    const esc = v=>{
      if(v==null) return '';
      const s=String(v);
      if(new RegExp('["\\n'+escRegex(actualSep)+']').test(s) || s.includes('\r')) return '"'+s.replace(/"/g,'""')+'"';
      return s;
    };
    const lines=[headers.join(actualSep)];
    for(const r of rows) lines.push(headers.map(h=>esc(r[h])).join(actualSep));
    return lines.join('\n');
  }

  function parseJsonInput(){
    let parsed;
    try { parsed = JSON.parse(jsonin.value); }
    catch(e){ tableWrap.innerHTML=''; toggleRawBtn.disabled=true; downloadSelect.disabled=true; copyBtn.disabled=true; return; }
    lastJson = parsed;
    window.currentRows = getRowsFromJson(parsed);
    const allKeys = new Set(); window.currentRows.forEach(r=>Object.keys(r).forEach(k=>allKeys.add(k))); currentHeaders = Array.from(allKeys);
    renderTable();
    const hasRows = window.currentRows.length>0;
    toggleRawBtn.disabled = !hasRows;
    updateDownloadCopyButtons(hasRows);
    if(hasRows) addToHistory(jsonin.value);
    if(hasRows) localStorage.setItem('lastJson', jsonin.value);
  }

  function updateDownloadCopyButtons(enabled){ copyBtn.disabled=!enabled; downloadSelect.disabled=!enabled; }

  function renderFilteredTbody(rows, highlightCol=null){
    const tbody = tableWrap.querySelector('tbody');
    if(!tbody) return;
    tbody.innerHTML='';
    const headers = currentHeaders || [];
    rows.forEach(r=>{
      const tr=document.createElement('tr');
      headers.forEach(h=>{
        const td=document.createElement('td'); td.textContent = r[h]!==undefined?r[h]:''; tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
    if(highlightCol){
      const idx = headers.indexOf(highlightCol);
      if(idx>=0){
        tbody.querySelectorAll('tr').forEach(tr=>{
          const td=tr.children[idx];
          if(td){ td.classList.add('blink'); setTimeout(()=>td.classList.remove('blink'),150); }
        });
      }
    }
  }

  function renderTable(){
    tableWrap.innerHTML=''; if(!window.currentRows.length){ updateDownloadCopyButtons(false); return; }
    const tbl=document.createElement('table'); const thead=document.createElement('thead');
    const trh=document.createElement('tr');
    currentHeaders.forEach(h=>{
      const th=document.createElement('th'); th.textContent=h; th.style.minWidth='80px';
      th.addEventListener('click', ()=>sortColumn(h)); trh.appendChild(th);
    });
    thead.appendChild(trh);
    // Filtros por columna
    const trFilters=document.createElement('tr');
    currentHeaders.forEach(h=>{
      const th=document.createElement('th'); th.style.padding='2px'; th.style.minWidth='80px';
      const inputContainer=document.createElement('div'); inputContainer.style.display='flex'; inputContainer.style.alignItems='center'; inputContainer.style.justifyContent='space-between';
      const input=document.createElement('input'); input.type='text'; input.placeholder='üîç'; input.className='columnFilter';
      input.style.flex='1'; input.style.fontSize='11px'; input.style.padding='2px 4px'; input.style.boxSizing='border-box'; input.style.cursor='text';
      const clearX=document.createElement('span'); clearX.textContent='‚úï'; clearX.className='clearBtn'; clearX.style.display='none';
      clearX.style.cursor='pointer'; clearX.style.marginLeft='4px'; clearX.style.flex='0 0 auto';
      input.addEventListener('input',()=>{ const val=input.value.toLowerCase(); const filtered=window.currentRows.filter(r=>r[h]!==undefined && String(r[h]).toLowerCase().includes(val)); renderFilteredTbody(filtered,h); clearX.style.display = val?'inline':'none'; });
      clearX.addEventListener('click',()=>{ input.value=''; input.focus(); clearX.style.display='none'; renderFilteredTbody(window.currentRows); });
      inputContainer.appendChild(input); inputContainer.appendChild(clearX); th.appendChild(inputContainer); trFilters.appendChild(th);
    });
    thead.appendChild(trFilters); tbl.appendChild(thead); tbl.appendChild(document.createElement('tbody')); tableWrap.appendChild(tbl);
    renderFilteredTbody(window.currentRows);
  }

  function sortColumn(header){
    const dir = sortState[header]==='asc'?'desc':'asc'; sortState[header]=dir;
    window.currentRows.sort((a,b)=>{
      const va=a[header]??''; const vb=b[header]??''; if(va===vb) return 0;
      if(dir==='asc') return va>vb?1:-1; else return va>vb?-1:1;
    });
    renderTable();
  }

  function addToHistory(jsonStr){
    if(jsonHistory.includes(jsonStr)) return;
    jsonHistory.unshift(jsonStr);
    if(jsonHistory.length>20) jsonHistory.pop();
    localStorage.setItem('jsonHistory', JSON.stringify(jsonHistory));
    updateHistorySelect();
  }

  function updateHistorySelect(){
    jsonHistorySelect.innerHTML='<option value="">-- Seleccionar JSON --</option>';
    jsonHistory.forEach((j,i)=>{ const opt=document.createElement('option'); opt.value=i; opt.textContent='JSON '+(i+1); jsonHistorySelect.appendChild(opt); });
  }

  function showRawData(){ rawDisplay.style.display=showRaw?'block':'none'; if(showRaw) rawDisplay.value=rowsToCsv(window.currentRows, separatorSelect.value); }

  // Eventos
  jsonin.addEventListener('input', parseJsonInput);
  clearBtn.addEventListener('click',()=>{ jsonin.value=''; parseJsonInput(); });
  fetchBtn.addEventListener('click',()=>{
    if(!urlIn.value) return;
    fetch(urlIn.value).then(r=>r.json()).then(data=>{ jsonin.value=JSON.stringify(data,null,2); parseJsonInput(); }).catch(console.error);
  });
  separatorSelect.addEventListener('change',()=>{ if(showRaw) rawDisplay.value=rowsToCsv(window.currentRows, separatorSelect.value); });
  toggleRawBtn.addEventListener('click',()=>{ showRaw=!showRaw; toggleRawBtn.textContent = showRaw?'Ocultar Raw':'Mostrar Raw'; showRawData(); });
  globalFilter.addEventListener('input',()=>{ const val=globalFilter.value.toLowerCase(); const filtered=window.currentRows.filter(r=>Object.values(r).some(v=>String(v).toLowerCase().includes(val))); renderFilteredTbody(filtered); globalClearBtn.style.display=val?'inline':'none'; });
  globalClearBtn.addEventListener('click',()=>{ globalFilter.value=''; renderFilteredTbody(window.currentRows); globalClearBtn.style.display='none'; });
  toggleEditBtn.addEventListener('click',()=>{ editing=!editing; toggleEditBtn.textContent=editing?'‚úîÔ∏è Guardar':'‚úèÔ∏è Editar'; tableWrap.querySelectorAll('td').forEach(td=>{ td.contentEditable=editing; td.style.background=editing?'#fff3cf':''; }); });
  copyBtn.addEventListener('click',()=>{
    const txt=rowsToCsv(window.currentRows, separatorSelect.value);
    navigator.clipboard.writeText(txt).then(()=>{ const msg=document.getElementById('copyMsg'); msg.style.display='block'; msg.style.top='10px'; msg.style.left='10px'; setTimeout(()=>msg.style.display='none',800); });
  });
  downloadSelect.addEventListener('change', ()=>{
    const val=downloadSelect.value; if(!val) return; downloadSelect.value='';
    if(val==='txt' || val==='csv'){ const blob=new Blob([rowsToCsv(window.currentRows, separatorSelect.value)],{type:'text/plain'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='tabla.'+val; a.click(); URL.revokeObjectURL(a.href); }
    else if(val==='xlsx'){ const wb=XLSX.utils.book_new(); const ws=XLSX.utils.json_to_sheet(window.currentRows); XLSX.utils.book_append_sheet(wb,ws,'Sheet1'); XLSX.writeFile(wb,'tabla.xlsx'); }
  });

  jsonHistorySelect.addEventListener('change',()=>{ const idx=parseInt(jsonHistorySelect.value); if(!isNaN(idx)) { jsonin.value=jsonHistory[idx]; parseJsonInput(); } });

  // Config panel
  configBtn.addEventListener('click',()=>{ configPanel.style.display=configPanel.style.display==='block'?'none':'block'; });
  configPanel.innerHTML=`
    <label><input type="checkbox" id="darkModeChk"> Modo oscuro</label>
  `;
  const darkModeChk = document.getElementById('darkModeChk');
  darkModeChk.addEventListener('change',()=>{ document.body.classList.toggle('dark', darkModeChk.checked); });
  if(localStorage.getItem('darkMode')==='true'){ document.body.classList.add('dark'); darkModeChk.checked=true; }
  darkModeChk.addEventListener('change',()=>{ localStorage.setItem('darkMode', darkModeChk.checked); });

  // Inicializar
  updateHistorySelect();
  const last=localStorage.getItem('lastJson'); if(last){ jsonin.value=last; parseJsonInput(); }
});
</script>



</body>
</html>
