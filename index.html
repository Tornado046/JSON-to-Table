<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>JSON ‚Üí Tabla Mejorada</title>

<!-- M√≥dulo 1.1 - Tipograf√≠a y estilos base -->
<link href="https://fonts.googleapis.com/css?family=Inter:400,700&display=swap" rel="stylesheet">

<style>
/* M√≥dulo 1.2 - Variables y tema */
:root{
  --bg:#ffffff; --fg:#111111; --header-bg:#f2f2f2; --muted:#888;
  --cell-even:#f9f9f9; --cell-odd:#eef3ff; --accent:#2979ff;
  --input-border:#bbb; --error:#e53935;
  --th-height:40px;
  --row-height:32px;
  --font-main: 'Inter', system-ui, Arial, sans-serif;
}
body.dark{
  --bg:#141414; --fg:#eee; --header-bg:#222; --muted:#aaa;
  --cell-even:#252525; --cell-odd:#202020; --accent:#2979ff;
}
*{box-sizing:border-box}
body{
  margin:0; font-family:var(--font-main); color:var(--fg);
  background:var(--bg); -webkit-font-smoothing:antialiased;
}

/* M√≥dulo 1.3 - Layout */
.container{padding:12px;}
.row{display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap}

/* M√≥dulo 1.4 - Inputs y botones */
input[type=text], textarea, select, button{
  font-family:var(--font-main);
  font-size:14px;
}
textarea#jsonin{
  width:100%; min-height:160px; padding:10px; border:2px solid var(--input-border);
  border-radius:6px; resize:vertical; background:inherit; color:inherit;
}
textarea#jsonin.error{ border-color:var(--error); box-shadow:0 0 6px rgba(229,57,53,0.18); }
input[type=text]{padding:6px;border-radius:6px;border:1px solid var(--input-border)}
button{padding:6px 10px;border-radius:6px;border:1px solid var(--input-border);background:#f2f6ff;cursor:pointer}
button:disabled{background:#f0f0f0;color:var(--muted);cursor:not-allowed}

/* M√≥dulo 1.5 - Drawer (configuraci√≥n) */
#drawer{
  position:fixed; right:-100%; top:0; width:360px; height:100vh; background:var(--header-bg);
  box-shadow:0 6px 24px rgba(0,0,0,0.12); transition:right .28s; z-index:9999; padding:12px; overflow:auto;
}
#drawer.open{ right:0; }
.tab-bar{display:flex;gap:6px;margin-bottom:12px}
.tab-btn{flex:1;padding:10px;border-radius:8px;border:0;background:#eee;cursor:pointer}
.tab-btn.active{background:var(--accent);color:#fff}

/* M√≥dulo 1.6 - Table area: mantiene su propio scroll (tabla con scroll) */
#tableWrap{ width:100%; margin-top:10px; border-radius:8px; border:1px solid #e6e6e6; background:transparent; min-height:200px; max-height:420px; overflow:auto }

/* M√≥dulo 1.7 - Table styles y sticky headers */
table{border-collapse:collapse;width:100%}
th, td{padding:6px 8px;border:1px solid #e2e2e2; white-space:nowrap; font-family:monospace; font-size:13px; height:var(--row-height)}
thead th{height:var(--th-height); background:var(--header-bg); position:sticky; top:0; z-index:4}
thead tr.filter-row th{ top: calc(var(--th-height)); background:#fbfbfb; z-index:5 } /* M√≥dulo 1.7.1 - evita overlap */
tbody tr:nth-child(even) td{background:var(--cell-even)}
tbody tr:nth-child(odd) td{background:var(--cell-odd)}
th.order-asc::after{ content:" ‚Üë"; color:var(--accent); font-weight:bold }
th.order-desc::after{ content:" ‚Üì"; color:var(--accent); font-weight:bold }

/* M√≥dulo 1.8 - Column filter input wrapper */
.filter-col-wrap{ position:relative; }
.filter-col{ width:100%; box-sizing:border-box; padding-right:28px; border-radius:4px; padding:4px 8px; }

/* M√≥dulo 1.9 - Clear (X) inside inputs - global and column */
.clear-btn{ position:absolute; right:6px; top:50%; transform:translateY(-50%); border:0;background:transparent;color:var(--muted); cursor:pointer;font-size:14px;padding:2px; }
.clear-btn:focus{outline:2px solid rgba(41,121,255,0.12)}

/* M√≥dulo 1.10 - Editable cell visual effect */
.editable-cell{ background:#fffbe7 !important; border:1px dashed var(--accent) !important; box-shadow:0 0 0 3px rgba(41,121,255,0.06); }
td.editable-cell:focus{ outline:2px solid rgba(41,121,255,0.16); }

/* M√≥dulo 1.11 - Raw area */
#rawDisplay{display:none;width:100%;min-height:160px;padding:10px;border:2px solid var(--input-border);border-radius:6px;white-space:pre;overflow:auto;background:inherit;color:inherit}

/* Responsive adjustments */
@media (max-width:720px){
  #drawer{width:100vw}
  thead tr.filter-row th{ top: calc(var(--th-height) + 2px) }
}
</style>
</head>
<body>
<div class="container">
  <!-- M√≥dulo 2.1 - Controles superiores -->
  <div class="row" id="topControls">
    <input type="text" id="urlIn" placeholder="Pega URL aqu√≠..." aria-label="Pegar URL" style="flex:1">
    <button id="fetchBtn" aria-label="Cargar URL">Cargar URL</button>
    <button id="configBtn" aria-label="Abrir configuraci√≥n">‚öôÔ∏è Config</button>
  </div>

  <!-- M√≥dulo 2.2 - √Årea JSON -->
  <div class="row">
    <textarea id="jsonin" aria-label="√Årea JSON" placeholder="Pega o escribe JSON aqu√≠"></textarea>
  </div>

  <!-- M√≥dulo 2.3 - Acciones -->
  <div class="row">
    <button id="clearBtn" aria-label="Limpiar JSON">Limpiar JSON</button>

    <label style="display:flex;align-items:center;gap:6px">
      Separador:
      <select id="separatorSelect" aria-label="Separador">
        <option value="	">Tab</option>
        <option value=",">,</option>
        <option value=";">;</option>
      </select>
    </label>

    <select id="downloadSelect" aria-label="Descargar" disabled>
      <option value="">Descargar...</option>
      <option value="csv">CSV</option>
      <option value="xlsx">XLSX</option>
      <option value="txt">TXT</option>
    </select>

    <button id="toggleRawBtn" disabled aria-label="Mostrar raw">Mostrar Raw</button>
    <button id="copyBtn" disabled aria-label="Copiar tabla">Copiar tabla</button>
  </div>

  <!-- M√≥dulo 2.4 - Filtro global + bot√≥n editar -->
  <div class="row" style="align-items:center; margin-top:10px;">
    <div style="position:relative;flex:1;">
      <input type="text" id="filterGlobal" class="filter-global" placeholder="Filtro global..." autocomplete="off" style="width:100%;padding:8px 36px;border-radius:6px;border:1px solid var(--input-border)" />
      <button id="filterGlobalClearBtn" class="clear-btn" title="Limpiar filtro global">‚úï</button>
    </div>
    <button id="editBtn" aria-label="Editar tabla" disabled>‚úèÔ∏è Editar</button>
  </div>

  <!-- M√≥dulo 2.5 - Wrapper de tabla (CON SCROLL propio para sticky headers) -->
  <div id="tableWrap" aria-live="polite">
    <!-- la tabla se renderiza aqu√≠ -->
  </div>

  <!-- M√≥dulo 2.6 - √Årea raw -->
  <div style="margin-top:8px">
    <textarea id="rawDisplay" readonly aria-label="Raw CSV"></textarea>
  </div>
</div>

<!-- M√≥dulo 3.1 - Drawer / Configuraci√≥n -->
<div id="drawer" role="dialog" aria-label="Configuraci√≥n">
  <div class="tab-bar">
    <button class="tab-btn active" id="tabConfig">Configuraci√≥n</button>
    <button class="tab-btn" id="tabCustom">Tema personalizado</button>
  </div>

  <!-- M√≥dulo 3.2 - Contenido Configuraci√≥n -->
  <div id="configContent" class="active">
    <!-- M√≥dulo 3.2.1 - Tema r√°pido -->
    <div style="display:flex;gap:8px;margin-bottom:10px;">
      <button id="themeLight" title="Modo claro">üåû</button>
      <button id="themeDark" title="Modo oscuro">üåô</button>
    </div>

    <!-- M√≥dulo 3.2.2 - Idioma -->
    <label>Idioma:
      <select id="languageSelect" style="width:100%;margin-top:6px">
        <option value="es">Espa√±ol</option>
        <option value="en">English</option>
      </select>
    </label>

    <!-- M√≥dulo 3.2.3 - Historial -->
    <div style="margin-top:12px;">
      <label>Historial JSON:
        <select id="jsonHistorySelect" style="width:100%;margin-top:6px">
          <option value="">-- Seleccionar JSON --</option>
        </select>
      </label>
      <div style="display:flex;gap:6px;margin-top:6px;">
        <button id="renameHistoryBtn">Renombrar</button>
        <button id="deleteHistoryBtn" disabled>Eliminar</button>
      </div>
    </div>

    <!-- M√≥dulo 3.2.4 - Web/M√≥vil -->
    <div style="margin-top:12px;">
      <button id="mobileSwitchBtn">Web / M√≥vil</button>
    </div>
  </div>

  <!-- M√≥dulo 3.3 - Panel Tema Personalizado -->
  <div id="customPanel" style="display:none;">
    <h4>Personalizar tema</h4>
    <label>Fondo: <input type="color" id="bgColor"></label>
    <label>Texto: <input type="color" id="textColor"></label>
    <label>Tipograf√≠a: <input type="text" id="fontFamily" placeholder="Inter, Arial"></label>
    <label>Celdas pares: <input type="color" id="cellEven"></label>
    <label>Celdas impares: <input type="color" id="cellOdd"></label>
    <div style="margin-top:8px">
      <button id="customDefaultBtn">Default</button>
    </div>
  </div>
</div>

<!-- M√≥dulo 4.1 - Script principal (comentarios numerados en espa√±ol) -->
<script>
/* M√≥dulo 4.1 - Variables globales (4.1.1 Dom, 4.1.2 Estado) */
const el = {
  urlIn: document.getElementById('urlIn'),
  fetchBtn: document.getElementById('fetchBtn'),
  configBtn: document.getElementById('configBtn'),
  jsonin: document.getElementById('jsonin'),
  clearBtn: document.getElementById('clearBtn'),
  downloadSelect: document.getElementById('downloadSelect'),
  separatorSelect: document.getElementById('separatorSelect'),
  toggleRawBtn: document.getElementById('toggleRawBtn'),
  copyBtn: document.getElementById('copyBtn'),
  filterGlobal: document.getElementById('filterGlobal'),
  filterGlobalClearBtn: document.getElementById('filterGlobalClearBtn'),
  editBtn: document.getElementById('editBtn'),
  tableWrap: document.getElementById('tableWrap'),
  rawDisplay: document.getElementById('rawDisplay'),
  drawer: document.getElementById('drawer'),
  tabConfig: document.getElementById('tabConfig'),
  tabCustom: document.getElementById('tabCustom'),
  configContent: document.getElementById('configContent'),
  customPanel: document.getElementById('customPanel'),
  themeLight: document.getElementById('themeLight'),
  themeDark: document.getElementById('themeDark'),
  languageSelect: document.getElementById('languageSelect'),
  jsonHistorySelect: document.getElementById('jsonHistorySelect'),
  deleteHistoryBtn: document.getElementById('deleteHistoryBtn'),
  renameHistoryBtn: document.getElementById('renameHistoryBtn'),
  mobileSwitchBtn: document.getElementById('mobileSwitchBtn'),
  bgColor: document.getElementById('bgColor'),
  textColor: document.getElementById('textColor'),
  fontFamily: document.getElementById('fontFamily'),
  cellEven: document.getElementById('cellEven'),
  cellOdd: document.getElementById('cellOdd'),
  customDefaultBtn: document.getElementById('customDefaultBtn'),
  loadingAnim: document.getElementById('loadingAnim')
};

const state = {
  originalParsed: null,     // M√≥dulo 4.1.3 - objeto JSON original (para reconstruir)
  originalRows: [],         // M√≥dulo 4.1.4 - rows flatten
  currentRows: [],          // M√≥dulo 4.1.5 - current working rows (after filters/sort)
  currentHeaders: [],
  sortState: {},            // {col: 'asc'|'desc'}
  editing: false,
  columnFilters: {},        // {colKey: value}
  history: [],              // {hash,name,data,date}
  mobileMode: (localStorage.getItem('mobileMode') === 'true'),
  virtualStart: 0,          // M√≥dulo 4.1.6 - virtual scrolling start index
  rowHeight: 32,            // M√≥dulo 4.1.7 - estimated row height
  visibleCount: 0,          // M√≥dulo 4.1.8 - number of rows visible
  filterDebounceMs: 200     // M√≥dulo 4.1.9 - debounce for filters
};

/* M√≥dulo 4.2 - Utilidades (4.2.1 SHA-1, 4.2.2 flatten, 4.2.3 unflatten, 4.2.4 CSV) */
async function sha1(str){
  const enc = new TextEncoder();
  const buf = await crypto.subtle.digest('SHA-1', enc.encode(str));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}
function isObj(x){ return x && typeof x === 'object' && !Array.isArray(x); }
function flattenObject(obj, prefix='', out={}){
  if(Array.isArray(obj)){ out[prefix.slice(0,-1)||'array']=JSON.stringify(obj); return out; }
  for(const k of Object.keys(obj||{})){
    const v = obj[k], key = prefix + k + '.';
    if(isObj(v)) flattenObject(v, key, out);
    else if(Array.isArray(v)) out[key.slice(0,-1)] = JSON.stringify(v);
    else out[key.slice(0,-1)] = v;
  }
  return out;
}
/* M√≥dulo 4.2.3 - Unflatten: reconstruye objeto desde keys con puntos */
function unflattenObject(flat){
  const res = {};
  for(const flatKey of Object.keys(flat || {})){
    const parts = flatKey.split('.');
    let cur = res;
    for(let i=0;i<parts.length;i++){
      const p = parts[i];
      if(i === parts.length - 1){
        // intenta parsear JSON (arrays o objetos) si value parece JSON
        const val = flat[flatKey];
        if(typeof val === 'string' && (val.trim().startsWith('[') || val.trim().startsWith('{'))){
          try{ cur[p] = JSON.parse(val); continue; }catch(e){}
        }
        cur[p] = val;
      } else {
        if(!cur[p] || typeof cur[p] !== 'object') cur[p] = {};
        cur = cur[p];
      }
    }
  }
  return res;
}
function getRowsFromJson(parsed){
  // guarda parsed para reconstrucci√≥n
  if(Array.isArray(parsed)){
    state.originalParsed = { type: 'array' };
    return parsed.map(o=>flattenObject(o));
  }
  // si objeto con arrays en sus keys, intenta encontrar primer array
  for(const k of Object.keys(parsed || {})){
    if(Array.isArray(parsed[k])){
      state.originalParsed = { type: 'rootKeyArray', key: k, template: parsed };
      return parsed[k].map(o=>flattenObject(o));
    }
  }
  state.originalParsed = { type: 'object' };
  return [flattenObject(parsed)];
}
function tryParseJson(text){
  try{ return JSON.parse(text); }catch{
    try {
      const clean = text.replace(/(['"])?([a-zA-Z0-9_]+)(['"])?\s*:/g, '"$2":');
      return JSON.parse(clean);
    }catch{ return null; }
  }
}
function dynamicFilename(ext){
  const d = new Date();
  const pad = n=> (n<10?'0':'')+n;
  return `JSON_${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}.${ext}`;
}
function rowsToCsv(rows, sep){
  if(!rows.length) return '';
  const keys = Array.from(rows.reduce((s,r)=>{ Object.keys(r).forEach(k=>s.add(k)); return s; }, new Set()));
  const esc = v=>{
    if(v==null) return '';
    const s = String(v);
    if(s.includes('"') || s.includes('\n') || s.includes(sep)) return `"${s.replace(/"/g,'""')}"`;
    return s;
  };
  const lines = [keys.join(sep)];
  for(const r of rows) lines.push(keys.map(k=>esc(r[k])).join(sep));
  return lines.join('\n');
}

/* M√≥dulo 4.3 - Persistencia: historial + lastJson + tema + mode (4.3.1 guardar/cargar) */
function saveHistory(){ try{ localStorage.setItem('jsonHistory', JSON.stringify(state.history)); }catch(e){ console.warn(e); } }
function loadHistory(){
  try{
    const raw = localStorage.getItem('jsonHistory');
    if(!raw) return;
    state.history = JSON.parse(raw) || [];
    renderHistoryDropdown();
  }catch(e){ console.warn('loadHistory', e); }
}
function renderHistoryDropdown(){
  const sel = el.jsonHistorySelect;
  sel.innerHTML = '<option value="">-- Seleccionar JSON --</option>';
  state.history.forEach((it, idx)=>{
    const opt = document.createElement('option');
    opt.value = idx;
    opt.textContent = `${it.name || 'JSON '+(idx+1)} (${new Date(it.date).toLocaleString()})`;
    sel.appendChild(opt);
  });
}

/* M√≥dulo 4.4 - A√±adir al historial con dedupe (4.4.1) */
async function addToHistory(jsonStr, name){
  if(!jsonStr || !jsonStr.trim()) return;
  const h = await sha1(jsonStr);
  const idx = state.history.findIndex(x => x.hash === h);
  if(idx >= 0){
    state.history[idx].date = new Date().toISOString();
  } else {
    state.history.push({ hash: h, data: jsonStr, name: name || ('JSON ' + (state.history.length+1)), date: new Date().toISOString() });
    if(state.history.length > 200) state.history.shift();
  }
  saveHistory();
  renderHistoryDropdown();
}

/* M√≥dulo 4.5 - Botones UI: habilitar/deshabilitar estado (4.5.1) */
function updateActionButtons(){
  const hasData = state.currentRows && state.currentRows.length>0;
  el.downloadSelect.disabled = !hasData;
  el.toggleRawBtn.disabled = !hasData;
  el.copyBtn.disabled = !hasData;
  el.editBtn.disabled = !hasData;
  el.filterGlobal.disabled = !hasData;
  el.clearBtn.disabled = !el.jsonin.value.trim();
  el.deleteHistoryBtn.disabled = el.jsonHistorySelect.value === '';
}

/* M√≥dulo 4.6 - Drawer/tabs (4.6.1 mostrar solo panel activo) */
el.configBtn.addEventListener('click', ()=> {
  el.drawer.classList.toggle('open');
  showConfigTab();
});
function showConfigTab(){
  el.tabConfig.classList.add('active');
  el.tabCustom.classList.remove('active');
  el.configContent.classList.add('active');
  el.configContent.style.display = 'block';
  el.customPanel.style.display = 'none';
  el.customPanel.classList.remove('active');
}
function showCustomTab(){
  el.tabCustom.classList.add('active');
  el.tabConfig.classList.remove('active');
  el.configContent.classList.remove('active');
  el.configContent.style.display = 'none';
  el.customPanel.style.display = 'block';
  el.customPanel.classList.add('active');
}
el.tabConfig.addEventListener('click', showConfigTab);
el.tabCustom.addEventListener('click', showCustomTab);

/* M√≥dulo 4.7 - Tema personalizado en tiempo real y persistente (4.7.1 carga/guardado) */
function applyCustomTheme(colors){
  if(colors.bg) document.documentElement.style.setProperty('--bg', colors.bg);
  if(colors.text) document.documentElement.style.setProperty('--fg', colors.text);
  if(colors.cellEven) document.documentElement.style.setProperty('--cell-even', colors.cellEven);
  if(colors.cellOdd) document.documentElement.style.setProperty('--cell-odd', colors.cellOdd);
  if(colors.font) document.body.style.fontFamily = colors.font;
}
function loadCustomTheme(){
  try{
    const raw = localStorage.getItem('customTheme');
    if(raw){
      const c = JSON.parse(raw);
      el.bgColor.value = c.bg || '#ffffff';
      el.textColor.value = c.text || '#111111';
      el.fontFamily.value = c.font || '';
      el.cellEven.value = c.cellEven || '#f9f9f9';
      el.cellOdd.value = c.cellOdd || '#eef3ff';
      applyCustomTheme(c);
    } else {
      el.bgColor.value = '#ffffff';
      el.textColor.value = '#111111';
      el.fontFamily.value = '';
      el.cellEven.value = '#f9f9f9';
      el.cellOdd.value = '#eef3ff';
    }
  }catch(e){ console.warn(e); }
}
function saveCustomTheme(){
  const c = { bg: el.bgColor.value, text: el.textColor.value, font: el.fontFamily.value, cellEven: el.cellEven.value, cellOdd: el.cellOdd.value};
  localStorage.setItem('customTheme', JSON.stringify(c));
  applyCustomTheme(c);
}
['bgColor','textColor','fontFamily','cellEven','cellOdd'].forEach(id=>{
  const node = el[id] || document.getElementById(id);
  if(node){
    node.addEventListener('input', ()=>{
      saveCustomTheme();
    });
  }
});
el.customDefaultBtn.addEventListener('click', ()=>{
  if(!confirm('¬øRestablecer el tema a los valores predeterminados?')) return;
  localStorage.removeItem('customTheme');
  el.bgColor.value = '#ffffff';
  el.textColor.value = '#111111';
  el.fontFamily.value = '';
  el.cellEven.value = '#f9f9f9';
  el.cellOdd.value = '#eef3ff';
  applyCustomTheme({bg:'#ffffff', text:'#111111', font:'', cellEven:'#f9f9f9', cellOdd:'#eef3ff'});
});

/* M√≥dulo 4.8 - Modo Web/M√≥vil (persistente) */
function enableMobileMode(flag){
  state.mobileMode = !!flag;
  document.body.classList.toggle('mobile', !!flag);
  localStorage.setItem('mobileMode', state.mobileMode ? 'true' : 'false');
}
el.mobileSwitchBtn.addEventListener('click', ()=>{
  enableMobileMode(!state.mobileMode);
});

/* M√≥dulo 4.9 - Control del bot√≥n cargar URL (4.9.1 desactivar si vac√≠o) */
function updateFetchButtonState(){
  el.fetchBtn.disabled = !el.urlIn.value.trim();
}
el.urlIn.addEventListener('input', updateFetchButtonState);
updateFetchButtonState();

/* M√≥dulo 4.10 - Parseo JSON, generar filas y guardar lastJson (4.10.1, 4.10.2) */
async function parseJsonInput(addToHist){
  const txt = el.jsonin.value || '';
  if(!txt.trim()){
    state.originalParsed = null;
    state.originalRows = []; state.currentRows = []; state.currentHeaders = [];
    el.tableWrap.innerHTML = '<div style="padding:12px;color:var(--muted)">No hay tabla para mostrar</div>';
    updateActionButtons();
    return;
  }
  const parsed = tryParseJson(txt);
  if(!parsed){
    el.jsonin.classList.add('error');
    state.originalRows = []; state.currentRows = [];
    el.tableWrap.innerHTML = '<div style="padding:12px;color:var(--error)">JSON inv√°lido</div>';
    updateActionButtons();
    return;
  } else {
    el.jsonin.classList.remove('error');
  }
  const rows = getRowsFromJson(parsed);
  state.originalRows = rows;
  state.currentRows = rows.slice();
  if(addToHist) await addToHistory(txt);
  localStorage.setItem('lastJson', txt);
  state.originalParsed = parsed;
  // reset virtual scrolling start
  state.virtualStart = 0;
  computeVisibleCount();
  renderTable();
  updateActionButtons();
}
function saveLastJson(){ try{ localStorage.setItem('lastJson', el.jsonin.value || ''); }catch(e){console.warn(e);} }

/* M√≥dulo 4.11 - Debounce helper (4.11.1) */
function debounce(fn, ms){
  let t;
  return function(...args){
    clearTimeout(t);
    t = setTimeout(()=> fn.apply(this, args), ms);
  };
}

/* M√≥dulo 4.12 - Virtual scrolling calculations (4.12.1) */
function computeVisibleCount(){
  const h = el.tableWrap.clientHeight || 420;
  state.visibleCount = Math.ceil(h / state.rowHeight) + 6; // buffer
}

/* M√≥dulo 4.13 - Render de la tabla con virtual scrolling (4.13.1 filtros, 4.13.2 headers sticky) */
function renderTable(){
  const rows = state.currentRows || [];
  if(!rows.length){
    // Show headers if possible (we need to compute headers from originalRows)
    const keys = state.originalRows.length ? Array.from(state.originalRows.reduce((s,r)=>{ Object.keys(r).forEach(k=>s.add(k)); return s; }, new Set())) : [];
    if(!keys.length){
      el.tableWrap.innerHTML = '<div style="padding:12px;color:var(--muted)">No hay tabla para mostrar</div>';
      updateActionButtons();
      return;
    }
    // Render table with headers + filter row and empty tbody
    const html = buildTableHtml([], keys, true);
    el.tableWrap.innerHTML = html;
    attachTableEvents();
    updateActionButtons();
    return;
  }

  // apply filters (global + column)
  const globalVal = (el.filterGlobal.value || '').toLowerCase();
  let filtered = rows.filter(r=>{
    if(globalVal){
      if(!Object.values(r).some(v=>String(v||'').toLowerCase().includes(globalVal))) return false;
    }
    for(const [col, val] of Object.entries(state.columnFilters || {})){
      if(val && !(String((r[col]||'')).toLowerCase().includes(val.toLowerCase()))) return false;
    }
    return true;
  });

  // compute keys from filtered or all rows
  const keys = Array.from((filtered.length ? filtered : rows).reduce((s,r)=>{ Object.keys(r).forEach(k=>s.add(k)); return s; }, new Set()));
  state.currentHeaders = keys;

  // virtual scrolling: compute start based on scrollTop
  const scrollTop = el.tableWrap.scrollTop || 0;
  state.virtualStart = Math.max(0, Math.floor(scrollTop / state.rowHeight) - 3);
  computeVisibleCount();
  const visibleRows = filtered.slice(state.virtualStart, state.virtualStart + state.visibleCount);

  // build HTML with headers + filter row + tbody containing only visible rows + spacer rows
  const topSpacerHeight = state.virtualStart * state.rowHeight;
  const bottomSpacerHeight = Math.max(0, (filtered.length - state.virtualStart - visibleRows.length) * state.rowHeight);

  let html = '';
  html += `<table><thead><tr>`;
  keys.forEach(k => {
    const cls = (state.sortState[k] === 'asc') ? 'order-asc' : (state.sortState[k] === 'desc') ? 'order-desc' : '';
    html += `<th class="${cls}" data-col="${encodeURIComponent(k)}">${escapeHtml(k)}</th>`;
  });
  html += `</tr>`;

  // filter row
  html += '<tr class="filter-row">';
  keys.forEach(k=>{
    const val = state.columnFilters[k] || '';
    html += `<th><span class="filter-col-wrap"><input class="filter-col" data-col="${encodeURIComponent(k)}" value="${escapeAttribute(val)}" placeholder="Filtrar..." /><button class="clear-btn filter-col-clear" data-col="${encodeURIComponent(k)}" title="Limpiar">‚úï</button></span></th>`;
  });
  html += '</tr></thead><tbody>';
  // top spacer
  html += `<tr style="height:${topSpacerHeight}px"><td style="padding:0;border:none" colspan="${keys.length}"></td></tr>`;

  if(visibleRows.length){
    visibleRows.forEach((r, idx)=>{
      html += '<tr>';
      keys.forEach(k=>{
        const v = r[k] == null ? '' : escapeHtml(String(r[k]));
        html += `<td data-row="${state.virtualStart + idx}" data-col="${encodeURIComponent(k)}">${v}</td>`;
      });
      html += '</tr>';
    });
  } else {
    // No results but keep headers and filter row visible; show empty message row
    html += `<tr><td colspan="${keys.length}" style="padding:12px;color:var(--muted)">No hay resultados para el filtro</td></tr>`;
  }

  // bottom spacer
  html += `<tr style="height:${bottomSpacerHeight}px"><td style="padding:0;border:none" colspan="${keys.length}"></td></tr>`;
  html += `</tbody></table>`;

  el.tableWrap.innerHTML = html;

  attachTableEvents(filtered);

  updateActionButtons();
}

/* M√≥dulo 4.14 - Attach events for headers, filters, clear buttons, virtualization scroll, editing (4.14.1) */
function attachTableEvents(filteredRows){
  // header sort
  el.tableWrap.querySelectorAll('th[data-col]').forEach(th=>{
    th.onclick = ()=>{
      const col = decodeURIComponent(th.dataset.col);
      const dir = (state.sortState[col] === 'asc') ? 'desc' : 'asc';
      state.sortState = {}; state.sortState[col] = dir;
      state.currentRows.sort((a,b)=>{
        const va = a[col], vb = b[col];
        if(va==null) return 1; if(vb==null) return -1;
        if(!isNaN(va) && !isNaN(vb)) return dir==='asc' ? va - vb : vb - va;
        return dir==='asc' ? String(va).localeCompare(String(vb)) : String(vb).localeCompare(String(va));
      });
      // reset scroll to top to show changes
      el.tableWrap.scrollTop = 0;
      renderTable();
    };
  });

   // filter inputs events with debounce
  const deb = debounce(function(inp){
    const col = decodeURIComponent(inp.dataset.col);
    state.columnFilters[col] = inp.value;
    renderTable();
  }, state.filterDebounceMs);

  el.tableWrap.querySelectorAll('.filter-col').forEach(inp=>{
    inp.addEventListener('input', (e)=> {
      // Actualizar inmediatamente el valor en el estado
      const col = decodeURIComponent(inp.dataset.col);
      state.columnFilters[col] = inp.value;
      // Llamar al debounce para procesamiento posterior
      deb(inp);
    });
    // A√±adir esta l√≠nea para permitir la escritura continua
    inp.addEventListener('keydown', (e)=> { 
      // Evitar que se bloquee la entrada
      e.stopPropagation();
    });
  });

  // clear buttons inside columns
  el.tableWrap.querySelectorAll('.filter-col-clear').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const col = decodeURIComponent(btn.dataset.col);
      state.columnFilters[col] = '';
      // re-render and focus the input so user can continue typing
      renderTable();
      setTimeout(()=>{
        const selector = `.filter-col[data-col="${encodeURIComponent(col)}"]`;
        const newInp = el.tableWrap.querySelector(selector);
        if(newInp){ newInp.value=''; newInp.focus(); }
      }, 0);
    });
  });

  // editing handling
  if(state.editing){
    el.tableWrap.querySelectorAll('tbody td').forEach(td=>{
      td.contentEditable = 'true';
      td.classList.add('editable-cell');
      td.addEventListener('input', onCellEdit);
    });
  } else {
    el.tableWrap.querySelectorAll('tbody td').forEach(td=>{
      td.contentEditable = 'false';
      td.classList.remove('editable-cell');
      td.removeEventListener('input', onCellEdit);
    });
  }

  // virtualization: update on scroll
  el.tableWrap.onscroll = function(){
    // recompute virtualStart from scrollTop and re-render
    const scrollTop = el.tableWrap.scrollTop || 0;
    const newStart = Math.max(0, Math.floor(scrollTop / state.rowHeight) - 3);
    if(newStart !== state.virtualStart){
      state.virtualStart = newStart;
      renderTable();
    }
  };
}

/* M√≥dulo 4.15 - onCellEdit: sincronizar edici√≥n con estructura JSON original (4.15.1) */
function onCellEdit(e){
  const td = e.target;
  const virtualRowIdx = Number(td.dataset.row);
  const col = decodeURIComponent(td.dataset.col);
  const newVal = td.innerText;
  // Determine actual index in currentRows based on virtualStart
  const actualIdx = virtualRowIdx;
  // Update currentRows
  if(typeof actualIdx === 'number' && state.currentRows[actualIdx]){
    state.currentRows[actualIdx][col] = newVal;
  }
  // Update originalParsed structure:
  // Reconstruct nested object from flattened row and replace in originalParsed accordingly.
  // Determine where to place: if originalParsed.type === 'array' -> map by index
  if(state.originalParsed && state.originalParsed.type === 'array'){
    // unflatten currentRows[actualIdx] to object and place into parsed array
    const newObj = unflattenObject(state.currentRows[actualIdx]);
    // We cannot mutate state.originalParsed directly because we only stored type; instead we keep originalParsedFull in localStorage when load
    // Simpler approach: store lastParsedFull in memory when parsing
    if(state.lastParsedFull && Array.isArray(state.lastParsedFull)){
      state.lastParsedFull[actualIdx] = newObj;
      // persist lastParsedFull to lastJson
      localStorage.setItem('lastJson', JSON.stringify(state.lastParsedFull, null, 2));
      el.jsonin.value = JSON.stringify(state.lastParsedFull, null, 2);
    }
  } else if(state.originalParsed && state.originalParsed.type === 'rootKeyArray'){
    const key = state.originalParsed.key;
    if(state.lastParsedFull && state.lastParsedFull[key] && Array.isArray(state.lastParsedFull[key])){
      const newObj = unflattenObject(state.currentRows[actualIdx]);
      state.lastParsedFull[key][actualIdx] = newObj;
      localStorage.setItem('lastJson', JSON.stringify(state.lastParsedFull, null, 2));
      el.jsonin.value = JSON.stringify(state.lastParsedFull, null, 2);
    }
  } else if(state.originalParsed && state.originalParsed.type === 'object'){
    // single object: update first element
    const newObj = unflattenObject(state.currentRows[actualIdx]);
    state.lastParsedFull = newObj;
    localStorage.setItem('lastJson', JSON.stringify(state.lastParsedFull, null, 2));
    el.jsonin.value = JSON.stringify(state.lastParsedFull, null, 2);
  }
}

/* M√≥dulo 4.16 - Clear JSON behavior (4.16.1) */
el.clearBtn.addEventListener('click', ()=>{
  el.jsonin.value = '';
  state.originalParsed = null;
  state.originalRows = []; state.currentRows = []; state.currentHeaders = [];
  el.tableWrap.innerHTML = '<div style="padding:12px;color:var(--muted)">No hay tabla para mostrar</div>';
  updateActionButtons();
  localStorage.removeItem('lastJson');
});

/* M√≥dulo 4.17 - Copiar con mensaje en la posici√≥n del cursor (4.17.1) */
el.copyBtn.addEventListener('click', async (ev)=>{
  if(!state.currentRows || !state.currentRows.length) return;
  try{
    await navigator.clipboard.writeText(rowsToCsv(state.currentRows, el.separatorSelect.value));
    const note = document.createElement('div'); note.textContent = 'Copiado';
    note.style.position = 'fixed'; note.style.zIndex = 99999; note.style.padding = '6px 10px';
    note.style.background = '#e0f7fa'; note.style.borderRadius = '6px';
    if(ev && ev.clientX && ev.clientY){
      note.style.left = (ev.clientX + 8) + 'px';
      note.style.top = (ev.clientY + 8) + 'px';
    } else {
      note.style.left = '50%'; note.style.top = '12px'; note.style.transform = 'translateX(-50%)';
    }
    document.body.appendChild(note);
    setTimeout(()=> note.remove(), 900);
  }catch(e){ console.warn(e); }
});

/* M√≥dulo 4.18 - Global filter and clear (4.18.1) with debounce */
const debFilterGlobal = debounce(()=>{ renderTable(); updateActionButtons(); }, state.filterDebounceMs);
el.filterGlobal.addEventListener('input', debFilterGlobal);
el.filterGlobalClearBtn.addEventListener('click', ()=>{
  el.filterGlobal.value = '';
  el.filterGlobal.focus();
  renderTable();
});

/* M√≥dulo 4.19 - Edit toggle (4.19.1) */
el.editBtn.addEventListener('click', ()=>{
  state.editing = !state.editing;
  el.editBtn.classList.toggle('active', state.editing);
  el.editBtn.textContent = state.editing ? 'üíæ Guardar' : '‚úèÔ∏è Editar';
  if(!state.editing) saveLastJson();
  renderTable();
});

/* M√≥dulo 4.20 - Fetch URL (4.20.1) */
el.fetchBtn.addEventListener('click', async ()=>{
  if(!el.urlIn.value.trim()) return;
  try{
    el.fetchBtn.disabled = true;
    el.fetchBtn.textContent = 'Cargando...';
    const res = await fetch(el.urlIn.value.trim());
    const txt = await res.text();
    const parsed = tryParseJson(txt);
    el.jsonin.value = parsed ? JSON.stringify(parsed, null, 2) : txt;
    state.lastParsedFull = parsed;
    await parseJsonInput(true);
  }catch(e){ console.warn(e); alert('Error cargando URL'); }
  el.fetchBtn.textContent = 'Cargar URL';
  updateFetchButtonState();
});

/* M√≥dulo 4.21 - Download / raw / separator change behavior (4.21.1) */
el.downloadSelect.addEventListener('change', ()=>{
  const val = el.downloadSelect.value;
  if(!val) return;
  const sep = el.separatorSelect.value;
  if(val === 'csv' || val === 'txt'){
    const content = rowsToCsv(state.currentRows, sep);
    const blob = new Blob([content], {type:'text/plain;charset=utf-8'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = dynamicFilename(val); a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 1500);
  } else if(val === 'xlsx'){
    const ws = XLSX.utils.json_to_sheet(state.currentRows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
    XLSX.writeFile(wb, dynamicFilename(val));
  }
  el.downloadSelect.value = '';
});
el.toggleRawBtn.addEventListener('click', ()=>{
  if(!state.currentRows || !state.currentRows.length) return;
  if(el.rawDisplay.style.display === 'block'){ el.rawDisplay.style.display = 'none'; el.tableWrap.style.display = ''; }
  else {
    el.rawDisplay.value = rowsToCsv(state.currentRows, el.separatorSelect.value);
    el.rawDisplay.style.display = 'block'; el.tableWrap.style.display = 'none';
    setTimeout(()=>{ el.rawDisplay.select(); }, 20);
  }
});
// M√≥dulo 4.21.2 - Cuando cambia el separador y RAW visible, actualizar y seleccionar
el.separatorSelect.addEventListener('change', ()=>{
  if(el.rawDisplay.style.display === 'block' && state.currentRows && state.currentRows.length){
    el.rawDisplay.value = rowsToCsv(state.currentRows, el.separatorSelect.value);
    setTimeout(()=>{ el.rawDisplay.select(); }, 20);
  }
});

/* M√≥dulo 4.22 - Historial: seleccionar con confirmaci√≥n, renombrar y eliminar (4.22.1) */
el.jsonHistorySelect.addEventListener('change', ()=>{
  el.deleteHistoryBtn.disabled = el.jsonHistorySelect.value === '';
});
el.jsonHistorySelect.addEventListener('dblclick', ()=>{
  const idx = el.jsonHistorySelect.value;
  if(idx === '') return;
  const item = state.history[idx];
  if(!item) return;
  if(!confirm('¬øCargar este JSON desde el historial?')) return;
  el.jsonin.value = item.data;
  state.lastParsedFull = tryParseJson(item.data);
  parseJsonInput(false);
});
el.renameHistoryBtn.addEventListener('click', ()=>{
  const idx = el.jsonHistorySelect.value;
  if(idx === '') return alert('Selecciona un JSON del historial');
  const newName = prompt('Nuevo nombre:', state.history[idx].name || '');
  if(newName){ state.history[idx].name = newName; saveHistory(); renderHistoryDropdown(); el.jsonHistorySelect.value = idx; }
});
el.deleteHistoryBtn.addEventListener('click', ()=>{
  const idx = el.jsonHistorySelect.value;
  if(idx === '') return alert('Selecciona un elemento para eliminar');
  if(confirm('Eliminar este JSON del historial?')){
    state.history.splice(idx, 1);
    saveHistory(); renderHistoryDropdown();
    el.jsonHistorySelect.value = '';
    el.deleteHistoryBtn.disabled = true;
  }
});

/* M√≥dulo 4.23 - Click fuera del drawer cierra (4.23.1) */
document.addEventListener('mousedown', (e)=>{
  if(el.drawer.classList.contains('open')){
    if(!el.drawer.contains(e.target) && !el.configBtn.contains(e.target)){
      el.drawer.classList.remove('open');
      showConfigTab();
    }
  }
});

/* M√≥dulo 4.24 - Carga inicial (4.24.1 tema, historial, √∫ltimo JSON, botones) */
(async function init(){
  try{
    // 4.24.2 - tema claro/oscuro
    const savedTheme = localStorage.getItem('theme');
    if(savedTheme === 'dark') document.body.classList.add('dark');
    else document.body.classList.remove('dark');
    el.themeLight.addEventListener('click', ()=> { localStorage.setItem('theme','light'); document.body.classList.remove('dark'); });
    el.themeDark.addEventListener('click', ()=> { localStorage.setItem('theme','dark'); document.body.classList.add('dark'); });

    // 4.24.3 - load custom theme
    loadCustomTheme();

    // 4.24.4 - history
    loadHistory();

    // 4.24.5 - last JSON
    const last = localStorage.getItem('lastJson');
    if(last && last.trim()){ el.jsonin.value = last; state.lastParsedFull = tryParseJson(last); await parseJsonInput(false); }
    else { updateActionButtons(); }

    // 4.24.6 - fetch button initial state
    updateFetchButtonState();

    // 4.24.7 - mobile mode
    const mobile = localStorage.getItem('mobileMode') === 'true';
    enableMobileMode(mobile);

    // 4.24.8 - ensure loading hidden
    if(el.loadingAnim) el.loadingAnim.style.display = 'none';
  }catch(e){ console.warn('init', e); }
})();

/* M√≥dulo 4.25 - Helpers de escape */
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[c]); }
function escapeAttribute(s){ return (s||'').replace(/"/g,'&quot;'); }

/* M√≥dulo 4.26 - Ensure clear button state updates on manual input (4.26.1) */
el.jsonin.addEventListener('input', ()=>{
  // enable clear button when any text
  updateActionButtons();
});

/* M√≥dulo 4.27 - Debounce for column filters behaviour handled in attachTableEvents */

/* M√≥dulo 4.28 - Save reconstructed JSON for export (4.28.1) */
/* Reconstruye JSON completo desde state.currentRows y state.originalParsed */
function reconstructJsonFull(){
  if(!state.currentRows || !state.currentRows.length) return null;
  if(state.originalParsed && state.originalParsed.type === 'array'){
    // unflatten each row into object
    const arr = state.currentRows.map(r => unflattenObject(r));
    return arr;
  } else if(state.originalParsed && state.originalParsed.type === 'rootKeyArray'){
    const key = state.originalParsed.key;
    const full = JSON.parse(JSON.stringify(state.lastParsedFull || {}));
    full[key] = state.currentRows.map(r => unflattenObject(r));
    return full;
  } else if(state.originalParsed && state.originalParsed.type === 'object'){
    // single object
    return unflattenObject(state.currentRows[0]);
  }
  return null;
}

/* M√≥dulo 4.29 - Update raw when separator changes and RAW visible handled above */

/* M√≥dulo 4.30 - Virtual scrolling: compute visibleCount on resize */
window.addEventListener('resize', ()=>{
  computeVisibleCount();
  renderTable();
});

/* M√≥dulo 4.31 - End of script */
</script>

<!-- XLSX for download support (M√≥dulo 5.1) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</body>
</html>